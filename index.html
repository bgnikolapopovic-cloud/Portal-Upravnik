<!DOCTYPE html>
<html lang="sr-Latn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Portal Upravnik</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<style>
:root{
  --bg-url: url("bg.png");

  --sidebar-w: min(340px, 50vw);
--edge-w: 0px;

  --main-pad: 18px;

  --ink:#0f172a;
  --muted:rgba(15,23,42,.65);
  --glass:rgba(248,250,252,.92);
  --border:rgba(15,23,42,.14);
  --shadow:0 18px 40px rgba(2,6,23,.10);

  --side1:rgba(10,35,56,.92);
  --side2:rgba(6,24,40,.92);
}
@media(min-width:900px){
  :root{ --main-pad: 52px; }
}
  
/* ===== SIDEBAR LOGOUT ===== */
.nav .logoutItem{
  margin-top: auto;
  background: rgba(220, 38, 38, .12);
  border: 1px solid rgba(220, 38, 38, .45);
  color: #fecaca;
  font-weight: 900;
  letter-spacing: .04em;
  text-align: center;
}

.nav .logoutItem:hover{
  background: rgba(220, 38, 38, .22);
  box-shadow: 0 0 0 4px rgba(220, 38, 38, .18);
}


*{margin:0;padding:0;box-sizing:border-box;font-family:"Inter",system-ui,Arial,sans-serif}

body{
  min-height:100vh;
  background: var(--bg-url) center/cover no-repeat fixed;
  color: var(--ink);
  overflow-x:hidden;
}

body::before{
  content:"";
  position:fixed;
  inset:0;
  background: rgba(255,255,255,.22);
  backdrop-filter: blur(1.4px);
  filter: contrast(1.35) saturate(1.25);
  z-index:-2;
}

/* ambient blobs */
.ambient{
  position:fixed;
  inset:-20%;
  z-index:-1;
  pointer-events:none;
  background:
    radial-gradient(600px 380px at 18% 22%, rgba(59,130,246,.22), transparent 60%),
    radial-gradient(620px 420px at 82% 26%, rgba(14,165,233,.18), transparent 60%),
    radial-gradient(720px 520px at 50% 84%, rgba(15,23,42,.12), transparent 62%);
  filter: blur(2px);
}

/* TOP RIGHT */
.topRightBar{
  position:absolute;
  top:calc(10px + env(safe-area-inset-top));
  right:calc(var(--main-pad) + env(safe-area-inset-right));
  display:flex;
  align-items:center;
  gap:12px;
  z-index:95;
  pointer-events:none;
}
.topRightTitle{
  text-align:left;
  font-weight:900;
  line-height:1.05;
}
.topRightTitle span{
  display:block;
  font-size:18px;
}
.topRightLogo{
  padding:6px;
  background:rgba(255,255,255,.72);
  border:1px solid var(--border);
  border-radius:22px;
  box-shadow:var(--shadow);
}
.topRightLogo img{
  height:56px;
  width:auto;
  display:block;
  border-radius:16px;
}
@media(min-width:900px){
  .topRightTitle span{font-size:22px;}
  .topRightLogo img{height:92px;}
}

/* SCREENS */
.loginWrap{
  min-height:100vh;
  display:grid;
  place-items:center;
  padding:24px var(--main-pad);
}

.loginCard{
  width:min(560px, 100%);
  border-radius:30px;
  background:rgba(255,255,255,.90);
  border:1px solid rgba(15,23,42,.14);
  box-shadow:var(--shadow);
  padding:22px;
  position:relative;
  overflow:hidden;
}
.loginCard::before{
  content:"";
  position:absolute;
  inset:-2px;
  background:
    radial-gradient(520px 320px at 22% 18%, rgba(59,130,246,.14), transparent 60%),
    radial-gradient(520px 320px at 86% 18%, rgba(14,165,233,.10), transparent 60%);
  pointer-events:none;
}
.loginInner{position:relative; z-index:1;}

.loginHead{
  padding-bottom:12px;
  border-bottom:1px solid rgba(15,23,42,.10);
}
.formTitle{
  margin:0;
  font-weight:900;
  font-size:26px;
  letter-spacing:.02em;
}
.formSub{
  margin-top:12px;
  color:var(--muted);
  font-weight:700;
  font-size:13px;
  line-height:1.4;
}

.field{ margin-top:12px; }
.field label{
  display:block;
  font-size:12px;
  font-weight:900;
  letter-spacing:.12em;
  text-transform:uppercase;
  opacity:.7;
  margin-bottom:6px;
}
.inputWrap{ position:relative; }
.field input, .field select, .field textarea{
  width:100%;
  border-radius:18px;
  border:1px solid rgba(15,23,42,.14);
  background:rgba(255,255,255,.94);
  padding:14px 14px;
  font-size:15px;
  outline:none;
  transition:.15s;
}
.field textarea{min-height:86px; resize:vertical;}
.field input:focus, .field select:focus, .field textarea:focus{
  border-color:rgba(15,23,42,.28);
  box-shadow:0 0 0 5px rgba(15,23,42,.06);
}

.eyeBtn{
  position:absolute;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  border:none;
  background:rgba(15,23,42,.06);
  border:1px solid rgba(15,23,42,.14);
  border-radius:14px;
  padding:8px 10px;
  cursor:pointer;
  font-weight:900;
  user-select:none;
}

.row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-top:12px;
  flex-wrap:wrap;
}
.check{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:800;
  color:rgba(15,23,42,.75);
  font-size:13px;
}
.check input{width:18px;height:18px}

.btnRow{ display:flex; gap:10px; margin-top:14px; }
.btn{
  flex:1;
  border:none;
  cursor:pointer;
  border-radius:18px;
  padding:14px 16px;
  font-weight:900;
  letter-spacing:.02em;
  transition:.15s;
}
.btnPrimary{
  background:rgba(15,23,42,.92);
  color:white;
  box-shadow:0 18px 36px rgba(2,6,23,.18);
}
.btnPrimary:hover{ transform:translateY(-1px); }
.btnGhost{
  background:rgba(255,255,255,.72);
  border:1px solid rgba(15,23,42,.14);
  box-shadow:var(--shadow);
  color:rgba(15,23,42,.92);
}
.error{
  margin-top:10px;
  font-weight:900;
  color:#9f1239;
  display:none;
}
.miniHint{
  margin-top:10px;
  font-weight:800;
  color:rgba(15,23,42,.62);
  font-size:12px;
  line-height:1.4;
}

/* overlay + hover zona (PORTAL) */
.overlay{
  position:fixed; inset:0;
  background:rgba(2,6,23,.25);
  opacity:0; pointer-events:none;
  transition:.2s;
  z-index:40;
}
.overlay.show{opacity:1;pointer-events:auto}
.edgeHotspot{
  position:fixed; left:0; top:0;
  width:var(--edge-w); height:100vh;
  z-index:60;
}

/* SIDEBAR */
.sidebar{
  position:fixed; left:0; top:0;
  width:var(--sidebar-w); height:100vh;
  padding:16px 20px;
  background:linear-gradient(180deg,var(--side1),var(--side2)),var(--bg-url);
  background-size:cover;
  color:#fff;
  box-shadow:18px 0 40px rgba(0,0,0,.28);
  transform:translateX(-100%);
  transition:.2s;
  z-index:70;
}
.sidebar.open{transform:translateX(0)}
body:not(.sidebar-open) .sidebar{ filter: brightness(1.20); }
body.sidebar-open .sidebar{ filter:none; }
.sidebar::before{
  content:"";
  position:absolute; inset:0;
  background:rgba(0,0,0,.22);
  backdrop-filter:blur(8px);
}
.sidebar>*{position:relative;z-index:1}

.brand{height:92px}
.brand h1{font-size:24px;font-weight:900;letter-spacing:.16em}
.brand p{font-size:13px;opacity:.78;margin-top:8px}

.nav{margin-top:26px;display:flex;flex-direction:column;gap:12px}
.nav a{
  padding:16px 18px;
  border-radius:18px;
  color:#fff;
  text-decoration:none;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.14);
  font-size:19px;
  font-weight:700;
  display:block;
}
.nav a.active{background:rgba(255,255,255,.14)}

  /* ‚úÖ PREMIUM STATISTIKA BUTTON (plavi gradient + glow) */
.nav a[data-page="statistika"]{
  position: relative;
  overflow: hidden;

  background: linear-gradient(135deg,
    rgba(59,130,246,.35),
    rgba(14,165,233,.22)
  );
  border: 1px solid rgba(147,197,253,.65);
  box-shadow:
    0 18px 40px rgba(37, 99, 235, .22),
    0 6px 14px rgba(2, 6, 23, .22);

  font-weight: 900;
  letter-spacing: .02em;
}

/* shine / svetlucanje */
.nav a[data-page="statistika"]::before{
  content:"";
  position:absolute;
  inset:-2px;
  background: radial-gradient(260px 120px at 15% 25%,
    rgba(255,255,255,.22),
    transparent 60%
  );
  pointer-events:none;
}

/* mala linija sa leve strane (premium bar) */
.nav a[data-page="statistika"]::after{
  content:"";
  position:absolute;
  left:10px;
  top:50%;
  transform:translateY(-50%);
  width:6px;
  height:60%;
  border-radius:999px;
  background: linear-gradient(180deg,
    rgba(191,219,254,.95),
    rgba(59,130,246,.95)
  );
  box-shadow: 0 0 18px rgba(59,130,246,.45);
  pointer-events:none;
}

/* hover efekat */
.nav a[data-page="statistika"]:hover{
  transform: translateY(-1px);
  background: linear-gradient(135deg,
    rgba(59,130,246,.45),
    rgba(14,165,233,.30)
  );
  box-shadow:
    0 22px 50px rgba(37, 99, 235, .30),
    0 8px 16px rgba(2, 6, 23, .25);
}

/* active (kada si u statistici) */
.nav a[data-page="statistika"].active{
  background: linear-gradient(135deg,
    rgba(59,130,246,.72),
    rgba(14,165,233,.55)
  );
  border-color: rgba(191,219,254,.95);
  box-shadow:
    0 26px 60px rgba(37, 99, 235, .36),
    0 10px 20px rgba(2, 6, 23, .28);
}


/* hamburger */
.hamburger{
  position:fixed;
  left:18px; top:18px;
  width:56px; height:56px;
  border-radius:17px;
  background:var(--glass);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  display:grid; place-items:center;
  cursor:pointer;
  z-index:80;
  user-select:none;
}

/* MAIN */
.main{ padding:0 var(--main-pad) 22px; }
.contentWrap{ padding-top:calc(86px + 14px); }
@media(min-width:900px){
  .contentWrap{padding-top:calc(120px + 14px);}
}
.pageHeader{
  display:flex;
  justify-content:space-between;
  gap:14px;
  margin-bottom:18px;

  position: sticky;
  top: 12px;
  z-index: 50;
}
.leftInfo{max-width:52vw}
.meta{
  font-size:18px;
  color:rgba(15,23,42,.62);
  font-weight:600;
  line-height:1.28;
}
.rightCol{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:10px;
}

.searchInline,
.balanceCard{
  width:clamp(180px,42vw,300px);
  border-radius:18px;
  background:var(--glass);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
}

.searchInline{ padding:10px 14px; }
.searchInline input{
  border:none;
  background:transparent;
  width:100%;
  outline:none;
  font-size:14px;
}

/* stanje */
.balanceCard{
  padding:12px;
  text-align:right;
}
.balanceCard .label{
  font-size:12px;
  font-weight:700;
  display:block;
  margin-bottom:6px;
}
.balanceAmount{ white-space:nowrap; }
.balanceAmount .value{
  font-size:20px;
  font-weight:900;
  letter-spacing:0.2px;
}
.balanceAmount .currency{
  font-size:11px;
  font-weight:700;
  opacity:.55;
  margin-left:4px;
}

@media(min-width:900px){
  .meta{font-size:26px;}
  .balanceAmount .value{font-size:25px;}
  .balanceAmount .currency{font-size:13px;}
  .balanceCard{padding:10px;}
}
/* MOBILE FIX ‚Äì veliki iznosi da ne izlaze iz kartice */
@media (max-width: 520px){
  .balanceCard{ overflow:hidden; }
  .balanceAmount{ white-space: normal; }
  .balanceAmount .value{ font-size: 18px; }
}

/* cards */
.card{
  background:rgba(248,250,252,.86);
  border-radius:26px;
  padding:22px;
  box-shadow:var(--shadow);
}
.card h3{
  text-transform:uppercase;
  letter-spacing:.16em;
  font-size:22px;
  font-weight:900;
}
@media(min-width:900px){
  .card{padding:28px;}
  .card h3{font-size:26px;}
}

.boardList{
  margin-top:14px;
  list-style:none;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.boardList li{
  background:rgba(15,23,42,.06);
  border:1px solid rgba(15,23,42,.10);
  padding:12px 14px;
  border-radius:16px;
  font-weight:700;
}

.smallText{
  margin-top:10px;
  font-weight:700;
  color:rgba(15,23,42,.65);
  line-height:1.45;
}

/* pills */
.topMini{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.pill{
  border-radius:999px;
  padding:10px 12px;
  background:rgba(255,255,255,.72);
  border:1px solid rgba(15,23,42,.14);
  box-shadow:var(--shadow);
  font-weight:900;
  font-size:13px;
  user-select:none;
}
.pillBtn{ cursor:pointer; }

/* pages switch */
.page{ display:none; }
.page.active{ display:block; }

/* badge */
.badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  border:1px solid rgba(15,23,42,.14);
  background:rgba(255,255,255,.72);
  box-shadow:var(--shadow);
}

/* simple row */
.fRow{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:flex-start;
}
.fRow .grow{flex:1; min-width:220px;}
.fRow .half{flex:1; min-width:220px;}

/* files list */
.fileList{
  margin-top:10px;
  list-style:none;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.fileList li{
  background:rgba(15,23,42,.06);
  border:1px solid rgba(15,23,42,.10);
  padding:10px 12px;
  border-radius:14px;
  font-weight:800;
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.fileList small{opacity:.7; font-weight:900;}

/* mode switching */
body.mode-login #portalScreen,
body.mode-login #buildingSelectScreen{display:none;}
body.mode-buildingSelect #loginScreen,
body.mode-buildingSelect #portalScreen{display:none;}
body.mode-portal #loginScreen,
body.mode-portal #buildingSelectScreen{display:none;}
body.mode-portal #portalScreen{display:block;}

/* Global search dropdown */
.searchResults{
  position:absolute;
  left:10px;
  right:10px;
  top:calc(100% + 10px);
  z-index:999;
  border-radius:18px;
  background:rgba(255,255,255,.92);
  border:1px solid rgba(15,23,42,.14);
  box-shadow:0 18px 40px rgba(2,6,23,.12);
  overflow:hidden;
  backdrop-filter: blur(6px);
}
.searchResults .srHead{
  padding:10px 12px;
  font-weight:900;
  font-size:12px;
  letter-spacing:.12em;
  text-transform:uppercase;
  color:rgba(15,23,42,.70);
  background:rgba(15,23,42,.04);
  border-bottom:1px solid rgba(15,23,42,.10);
}
.searchResults .srItem{
  padding:10px 12px;
  cursor:pointer;
  display:flex;
  gap:10px;
  align-items:flex-start;
  border-bottom:1px solid rgba(15,23,42,.08);
}
.searchResults .srItem:last-child{ border-bottom:none; }
.searchResults .srItem:hover{ background:rgba(15,23,42,.05); }
.searchResults .srTag{
  flex:0 0 auto;
  font-weight:900;
  font-size:11px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(15,23,42,.14);
  background:rgba(255,255,255,.72);
  color:rgba(15,23,42,.85);
  white-space:nowrap;
}
.searchResults .srText{
  flex:1;
  font-weight:800;
  color:rgba(15,23,42,.88);
  line-height:1.25;
  font-size:13px;
}
.searchResults .srSub{
  margin-top:4px;
  font-weight:700;
  color:rgba(15,23,42,.60);
  font-size:12px;
}

.searchHitFlash{
  outline:3px solid rgba(59,130,246,.55);
  box-shadow:0 0 0 6px rgba(59,130,246,.14);
  transition:.2s;
  animation: srFlash .9s ease-in-out 1;
}
@keyframes srFlash{
  0%{ transform:scale(1); }
  50%{ transform:scale(1.01); }
  100%{ transform:scale(1); }
}
body.sidebar-open .hamburger{
  opacity: 0;
  pointer-events: none;
}

/* building select list */
.pickList{
  margin-top:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.pickBtn{
  width:100%;
  text-align:left;
  border:none;
  cursor:pointer;
  border-radius:18px;
  padding:14px 14px;
  background:rgba(255,255,255,.92);
  border:1px solid rgba(15,23,42,.14);
  box-shadow:var(--shadow);
}
.pickBtn .t{font-weight:900;}
.pickBtn .s{margin-top:4px; font-weight:800; color:rgba(15,23,42,.62); font-size:12px; line-height:1.3;}

  /* Finansije: stavke koje imaju uploadovane dokumente -> PLAVO */
/* FINANSIJE: samo PDF fajlovi (donji deo) da budu PLAVI */
#financeList .fileList li,
#financeList .fileList li span,
#financeList .fileList li small{
  color:#1d4ed8;
  font-weight:900;
}

  /* ====== DARKEN WHITE CARDS (soft, for eyes) ====== */
:root{
  --glass: rgba(241,245,249,.78); /* manje belo */
}

/* sve glavne kartice */
.card{
  background: rgba(15,23,42,.18) !important;
  border: 1px solid rgba(15,23,42,.22) !important;
}

/* login + building select kartice */
.loginCard{
  background: rgba(241,245,249,.82) !important;
  border: 1px solid rgba(15,23,42,.18) !important;
}

/* search, balance, hamburger, pill */
.searchInline,
.balanceCard{
  background: rgba(241,245,249,.72) !important;
  border: 1px solid rgba(15,23,42,.18) !important;
}

/* pill (Korisnik/Zgrada/Odjava) */
.pill{
  background: rgba(241,245,249,.70) !important;
  border: 1px solid rgba(15,23,42,.18) !important;
}

/* dropdown rezultati pretrage */
.searchResults{
  background: rgba(241,245,249,.92) !important;
  border: 1px solid rgba(15,23,42,.18) !important;
}

/* izbor zgrade */
.pickBtn{
  background: rgba(241,245,249,.85) !important;
  border: 1px solid rgba(15,23,42,.18) !important;
}

    /* =========================
   CUSTOM MONTH PICKER (SR)
========================= */

.monthPick{
  margin-top:12px;
}

.monthPickRow{
  display:flex;
  gap:10px;
  align-items:flex-end;
  flex-wrap:wrap;
}

.mpLabel{
  display:block;
  font-size:12px;
  font-weight:800;
  color:rgba(15,23,42,.72);
  margin-bottom:8px;
  letter-spacing:.02em;
}

.mpSelect{
  flex:1 1 160px;
  min-width:160px;
  padding:12px 12px;
  border-radius:16px;
  border:1px solid rgba(15,23,42,.18);
  background:rgba(255,255,255,.78);
  color:rgba(15,23,42,.92);
  font-weight:800;
  outline:none;
  box-shadow:0 10px 26px rgba(2,6,23,.06);
}

.mpSelect:focus{
  border-color:rgba(29, 78, 216, .45);
  box-shadow:0 0 0 4px rgba(29, 78, 216, .18);
}

.mpBtn{
  padding:12px 14px;
  border-radius:16px;
  font-weight:900;
  white-space:nowrap;
}

.mpHint{
  margin-top:10px;
  font-size:12px;
  font-weight:800;
  color:rgba(15,23,42,.65);
}

  /* FINANSIJE ‚Äì sakrij header */
body.page-finansije .pageHeader{
  display: none;
}

/* blago spu≈°tanje kartica po stranama */
body.page-home #page-home,
body.page-finansije #page-finansije,
body.page-oglasna #page-oglasna,
body.page-forum #page-forum,
body.page-regulative #page-regulative,
body.page-kontakt #page-kontakt,
body.page-statistika #page-statistika{
  margin-top: 28px;
}

/* ===== GLOBAL OFFSET ISPOD SIDEBARA ===== */
:root{
  --sidebar-top-offset: 72px; /* menjaj po potrebi */
}

.contentWrap{
  padding-top: var(--sidebar-top-offset);
}

/* Header (meta + pretraga + stanje) samo na Poƒçetnoj */
body.mode-portal .pageHeader{ 
  display: none; 
}

body.mode-portal.page-home .pageHeader{ 
  display: flex; 
}

  /* Logo smanjen za ~40% */
.topRightLogo img{
  height: 34px;   /* 56px ‚Üí 34px */
}

/* desktop */
@media (min-width: 900px){
  .topRightLogo img{
    height: 55px; /* 92px ‚Üí 55px */
  }
}

  /* Tekst "Portal / Upravnik" smanjen proporcionalno sa logom (‚àí40%) */
.topRightTitle span{
  font-size: 11px;   /* 18px ‚Üí 11px */
}

/* desktop */
@media (min-width: 900px){
  .topRightTitle span{
    font-size: 13px; /* 22px ‚Üí 13px */
  }
}

  /* Poƒçetna: fix overflow na mobilnom (vrati header elemente u kolonu) */
@media (max-width: 720px){
  body.mode-portal.page-home .rightCol{
    display: flex;
    flex-direction: column;
    align-items: stretch; /* da elementi zauzmu ≈°irinu lepo */
  }

  body.mode-portal.page-home .searchInline,
  body.mode-portal.page-home .balanceCard{
    width: 100%;
    max-width: 100%;
  }

  /* po≈°to si spu≈°tao balanceCard za desktop poravnanje */
  body.mode-portal.page-home .balanceCard{
    margin-top: 0;
    align-self: auto;
  }
}

  /* ‚úÖ POƒåETNA: Promeni zgradu + Pretraga + Stanje raƒçuna u ISTOM redu */
@media (min-width: 721px){
  body.mode-portal.page-home .rightCol{
    display: grid;
    grid-template-columns: auto 1fr auto; /* dugme | pretraga | stanje */
    align-items: center;
    gap: 12px;
  }

  /* "spljo≈°ti" topMini da njegovi child elementi postanu grid-items */
  body.mode-portal.page-home .topMini{ 
    display: contents; 
  }

  /* sakrij pill-ove (veƒá ih JS gasi, ali da bude sigurno) */
  body.mode-portal.page-home #userPill,
  body.mode-portal.page-home #buildingPill{
    display: none !important;
  }

  /* Promeni zgradu ide u prvu kolonu */
  body.mode-portal.page-home #switchBuildingBtn{
    grid-column: 1;
    margin: 0;
  }

  /* Pretraga u sredinu */
  body.mode-portal.page-home .searchInline{
    grid-column: 2;
    width: 100%;
    margin: 0;
  }

  /* Stanje raƒçuna desno */
  body.mode-portal.page-home .balanceCard{
    grid-column: 3;
    margin: 0;
    align-self: center;
  }
}

/* ‚úÖ MOBILNI: vraƒáamo u kolonu kao ≈°to si imao */
@media (max-width: 720px){
  body.mode-portal.page-home .rightCol{
    display: flex;
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }

  body.mode-portal.page-home .searchInline,
  body.mode-portal.page-home .balanceCard{
    width: 100%;
    max-width: 100%;
  }

  body.mode-portal.page-home .balanceCard{
    margin-top: 0;
  }
}

  /* Poƒçetna: brze preƒçice (klikabilne stavke) */
#homeLastChange, #homePinned, #homeForum{
  cursor: pointer;
}

#homeLastChange:hover, #homePinned:hover, #homeForum:hover{
  text-decoration: underline;
  opacity: .9;
}

#addFinanceBtn{
  background: transparent;
  color: #2563eb;
  border: 1px solid #2563eb;
}

#addFinanceBtn:hover{
  background: #2563eb;
  color: #fff;
}

  /* PDF fajlovi ‚Äì Oglasna + Finansije (force) */
.fileList li,
.fileList li span,
.fileList li small{
  color:#1d4ed8 !important;
  font-weight:900;
}

  /* Dodaj dugmad ‚Äì isti outline stil (Finansije + Oglasna) */
#addFinanceBtn,
#addBoardBtn{
  background: transparent;
  color: #2563eb;
  border: 1px solid #2563eb;
}

#addFinanceBtn:hover,
#addBoardBtn:hover{
  background: #2563eb;
  color: #fff;
}

/* Poƒçetna: "NOVO" badge */
#page-home .boardList li{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

.unreadBadge{
  flex:0 0 auto;
  padding:6px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  letter-spacing:.06em;
  background: rgba(59,130,246,.16);
  border: 1px solid rgba(59,130,246,.45);
  color:#1d4ed8;
}

/* DESKTOP ONLY ‚Äì spusti "Stanje raƒçuna" */
@media (min-width: 721px){
  body.mode-portal.page-home .balanceCard{
    align-self: flex-start; /* ili start */
    margin-top: 8px;        /* sada je stvarnih 5px */
  }
}

/* ===== Finansijski statusi ===== */

/* Dug */
.status-dug,
.dug {
  color: #dc2626;          /* crvena */
  background: rgba(220,38,38,.12);
  border: 1px solid rgba(220,38,38,.35);
}

/* Obaveza */
.status-obaveza,
.obaveza {
  color: #ca8a04;          /* ≈æuta */
  background: rgba(250,204,21,.18);
  border: 1px solid rgba(202,138,4,.35);
}

/* Uplaƒáeno / Pretplata */
.status-uplaceno,
.uplaceno,
.pretplata {
  color: #16a34a;          /* zelena */
  background: rgba(22,163,74,.15);
  border: 1px solid rgba(22,163,74,.35);
}

/* Mali UI polish */
.status-dug,
.status-obaveza,
.status-uplaceno {
  padding: 4px 10px;
  border-radius: 999px;
  font-weight: 700;
  font-size: 12px;
  display: inline-block;
}

/* ===== Finansije: kompaktne kontrole (Tip/Kategorija/Sort/Pretraga) ===== */
:root{
  --fin-ctrl-h: 36px;
  --fin-ctrl-font: 13px;
  --fin-ctrl-pad-y: 6px;
  --fin-ctrl-pad-x: 10px;
}

/* same kontrole */
#finFilterType,
#finFilterCategory,
#finSortBy,
#finLocalSearch{
  height: var(--fin-ctrl-h);
  font-size: var(--fin-ctrl-font);
  padding: var(--fin-ctrl-pad-y) var(--fin-ctrl-pad-x);
  border-radius: 12px;
}

  #finFilterType,
#finFilterCategory,
#finSortBy,
#finLocalSearch{
  background: rgba(248,250,252,.88);
  border: 1px solid rgba(15,23,42,.14);
}

/* fokus (da izgleda profi kad klikne≈°) */
#finFilterType:focus,
#finFilterCategory:focus,
#finSortBy:focus,
#finLocalSearch:focus{
  outline: none;
  box-shadow: 0 0 0 3px rgba(59,130,246,.18);
}

/* FINANSIJE: naslov + stanar badge u istom redu */
.finTitleRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

#finTenantBadge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  white-space:nowrap;
}

/* ===== FINANSIJE: SMANJI NAZIV PDF-a (ono plavo ≈°to si zaokru≈æio) ===== */
#financeList .fileList li{
  padding: 6px 10px !important;     /* manje prostora */
  border-radius: 12px !important;
  font-size: 12px !important;       /* manji tekst (fallback) */
  line-height: 1.2 !important;
}

#financeList .fileList li span{
  font-size: 12px !important;       /* naziv fajla */
  font-weight: 800 !important;
}

#financeList .fileList li small{
  font-size: 10px !important;       /* "4 KB" */
  font-weight: 800 !important;
  opacity: .7 !important;
}

/* ===== OGLASNA ‚Äì smanji naziv PDF fajla ispod objave ===== */
#boardList li span{
  font-size: 12px !important;   /* naziv fajla */
  font-weight: 700 !important;
}

#boardList li small{
  font-size: 10px !important;   /* "KB" */
  opacity: .7 !important;
}

#boardList li{
  padding: 6px 8px !important;
  line-height: 1.2 !important;
}

  /* ===== FIN stavka: naslov + akcije u istom redu ===== */
.finRowTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

.finRowTitle{
  flex:1;
  min-width:0;               /* bitno da tekst mo≈æe da se ‚Äúskupi‚Äù */
}

.finRowActions{
  display:flex;
  gap:10px;
  align-items:center;
  white-space:nowrap;        /* da Izmeni/Obri≈°i ne prelomi */
}

/* da dugmad ne budu ogromna (ako su ti buttoni preveliki) */
.finRowActions .btn{
  padding:8px 14px;
  border-radius:999px;
}

/* ===== Iznos + veliƒçina fajla u istom redu ===== */
.finAmountInline{
  white-space:nowrap;        /* RSD + 4KB u istom redu */
}

.finFileSize{
  margin-left:8px;
  font-size:12px;
  opacity:.65;
  white-space:nowrap;
}

/* === FIN: header red (datum/opis + akcije desno) === */
.finRowTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

.finRowTitle{
  flex:1;
  min-width:0;            /* bitno da tekst mo≈æe da se ‚Äúseƒçe‚Äù umesto da gura dugmad */
}

.finRowActions{
  flex:0 0 auto;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:flex-end;
}

/* mala dugmad gore desno */
.finActBtn{
  padding:8px 12px;
  border-radius:12px;
  border:1px solid rgba(15,23,42,.18);
  background:rgba(248,250,252,.92);
  color:#0f172a;
  font-weight:800;
  letter-spacing:.2px;
  cursor:pointer;
  transition:transform .08s ease, background .12s ease;
  line-height:1;
}

.finActBtn:hover{ transform:translateY(-1px); }
.finActBtn:active{ transform:translateY(0px); }

.finActBtn.danger{
  border-color: rgba(239,68,68,.35);
  color:#b91c1c;
}

/* mobile: da ne bude tesno */
@media (max-width: 640px){
  .finRowTop{
    flex-direction:column;
    align-items:stretch;
  }
  .finRowActions{
    justify-content:flex-end;
  }
}

/* malo ‚Äúuredi‚Äù razmake unutar kartice (opciono) */
.finCard .row,
.finCard .finRow,
.finCard .itemRow{
  align-items: center;
  gap: 10px;
}

/* PDF redovi da budu uredniji (opciono) */
.finCard .fileRow,
.finCard .docRow{
  background: rgba(255,255,255,.35);
  border: 1px solid rgba(15,23,42,.12);
  border-radius: 14px;
  padding: 8px 10px;
}

  /* Poƒçetno stanje ‚Äì labela manja i diskretnija */
.openingBalanceLabel{
  font-size: 0.65em;   /* ~35‚Äì40% manje od normalnog teksta */
  opacity: .65;
  letter-spacing: .02em;
  margin-bottom: 2px;
}

/* Wrapper za poƒçetno stanje */
#openingBalanceView,
#openingBalanceViewAdmin{
  gap: 6px !important;      /* pribli≈æi elemente */
  align-items: baseline;    /* poravnaj tekst i cifru */
}

/* Sama cifra */
#openingBalanceValue,
#openingBalanceValueAdmin{
  font-size: 1.25em;        /* blago istaknuta */
  padding: 4px 10px;        /* manji ‚Äúbalon‚Äù */
}

  /* =========================================================
   POCETNO STANJE ‚Äì smanjeno dugme "Saƒçuvaj" (‚àí40%)
   bez promene izgleda + zategnut razmak
   ========================================================= */

#saveOpeningBalanceBtn,
#saveOpeningBalanceBtnAdmin{
  transform: scale(0.9);              /* 40% manje */
  transform-origin: left center;      /* skuplja se ka inputu */
  margin-left: -2px;                  /* zategni razmak */
}

/* opciono: malo zategni ceo red da deluje kompaktnije */
[data-role="upravnik"] .fRow .grow,
[data-role="admin"] .fRow .grow{
  gap: 6px;
}

.finDesc{
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  max-width: 100%;
}

.userBadge{
  font-weight: 900;
  font-size: 14px;
  letter-spacing: .6px;
  color: #1e40af;
  line-height: 1;
}

  /* FIX: samo skrati DATE input da prati ostale kvadrate */
#fDate{
  width: 100%;
  min-width: 0;
  max-width: 100%;
  box-sizing: border-box;
}

  .lockIcon{
  font-size:16px;
  line-height:1;
  opacity:.7;
  user-select:none;
}

/* zakljuƒçano */
.lockIcon.locked::before{
  content:"üîí";
}

/* otkljuƒçano */
.lockIcon.unlocked::before{
  content:"üîì";
}

/* ‚úÖ Confirm modal (custom) */
.cModal{
  position:fixed;
  inset:0;
  z-index:2000;
}

.cModalOverlay{
  position:absolute;
  inset:0;
  background: rgba(2,6,23,.45);
  backdrop-filter: blur(6px);
}

.cModalCard{
  position: absolute;
  left:50%;
  top:50%;
  transform: translate(-50%,-50%);
  width: min(520px, calc(100vw - 28px));
  border-radius: 22px;
  background: rgba(241,245,249,.96);
  border: 1px solid rgba(15,23,42,.18);
  box-shadow: 0 26px 70px rgba(2,6,23,.28);
  padding: 14px;
}

.cModalHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 6px 6px 10px 6px;
  border-bottom: 1px solid rgba(15,23,42,.10);
}

.cModalTitle{
  font-weight: 900;
  font-size: 16px;
  letter-spacing: .02em;
}

.cModalX{
  border:none;
  background: rgba(15,23,42,.06);
  border: 1px solid rgba(15,23,42,.14);
  border-radius: 12px;
  padding: 8px 10px;
  cursor:pointer;
  font-weight: 900;
}

.cModalBody{
  padding: 12px 6px;
}

.cModalText{
  font-weight: 800;
  color: rgba(15,23,42,.82);
  line-height: 1.35;
}

.cModalActions{
  display:flex;
  gap:10px;
  padding: 0 6px 6px 6px;
}

.cModalActions .btn{
  flex:1;
}

.cDanger{
  background: rgba(220,38,38,.92) !important;
  color:#fff !important;
}

.cDanger:hover{
  transform: translateY(-1px);
}

/* Finansije + Oglasna: smanji ‚ÄúUpravnik‚Äù i ‚ÄúUpload limit‚Äù (badge-ove u toj info liniji) */
#page-finansije .smallText[data-role="upravnik"] .badge,
#page-oglasna   .smallText[data-role="upravnik"] .badge{
  font-size: 11px;
  padding: 5px 9px;
  opacity: .85;
}

/* =========================
   DUGOVANJA (ADMIN GRID)
========================= */
.duesToolbar{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-top:12px;
}

.duesToolbar .field{ margin-top:0; }
.duesToolbar input, .duesToolbar select{
  height:36px;
  border-radius:12px;
  padding:6px 10px;
  border:1px solid rgba(15,23,42,.14);
  background:rgba(248,250,252,.88);
  font-weight:800;
  font-size:13px;
}

.duesGrid{
  margin-top:12px;
  display:grid;
  gap:10px;
}

.duesRow{
  display:grid;
  grid-template-columns: 140px 1fr 1fr 1fr auto; /* korisnik | uplaceno | obaveza | saldo | akcija */
  gap:12px;
  align-items:center;

  background: rgba(15, 23, 42, .18);
  border: 1px solid rgba(15, 23, 42, .22);
  box-shadow: 0 10px 26px rgba(2, 6, 23, .10);
  border-radius: 18px;
  padding: 12px 14px;

  /* bitno za hover */
  transition: background .12s ease, transform .12s ease;
}

.duesRow:hover{
  background: rgba(15, 23, 42, .22);
  transform: translateY(-1px);
}

.duesUser{
  font-weight: 900;
  font-size: 16px;
  letter-spacing:.3px;
}

.duesMeta{
  font-weight:800;
  color: rgba(15,23,42,.80);
  font-size: 12px;
  opacity:.85;
}

.duesBadges{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
}

.duesBadge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  border:1px solid rgba(15,23,42,.14);
  background: rgba(241,245,249,.75);
  white-space:nowrap;
}

/* saldo status boje (isti sistem kao kod tebe) */
.duesBadge.status-dug{ 
  color:#b91c1c; background:rgba(220,38,38,.22); border-color:rgba(220,38,38,.55);
}
.duesBadge.status-obaveza{
  color:#a16207; background:rgba(250,204,21,.28); border-color:rgba(202,138,4,.55);
}
.duesBadge.status-uplaceno{
  color:#15803d; background:rgba(22,163,74,.26); border-color:rgba(22,163,74,.55);
}

.duesActions{
  display:flex;
  justify-content:flex-end;
gap: 10px;
}

.duesActions .btn{
  flex:unset;
  padding:10px 14px;
  border-radius:14px;
}

/* responsive */
@media (max-width: 920px){
  .duesRow{
    grid-template-columns: 1fr; 
  }
  .duesBadges{ justify-content:flex-start; }
  .duesActions{ justify-content:flex-start; }
}

  /* =========================
   STATISTIKA ‚Äî FINAL
========================= */
.statsGrid{
  margin-top:12px;
  display:grid;
  grid-template-columns: repeat(2, minmax(220px, 1fr));
  gap:12px;
}

.statsCard{
  background: rgba(241,245,249,.85);
  border: 1px solid rgba(15,23,42,.14);
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 18px 40px rgba(2,6,23,.08);
}

.statsCard h4{
  margin:0 0 10px 0;
  font-size: 15px;
  font-weight: 900;
  color: rgba(15,23,42,.92);
  letter-spacing:.02em;
}

.statsRows{ display:flex; flex-direction:column; gap:8px; }

.statRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 10px 12px;
  border-radius: 14px;
  background: rgba(255,255,255,.55);
  border: 1px solid rgba(15,23,42,.10);
}

.statRow .k{
  color: rgba(15,23,42,.70);
  font-weight: 700;
  font-size: 13px;
}

.statRow .v{
  color: rgba(15,23,42,.92);
  font-weight: 900;
  font-size: 15px;
}

/* mobilni */
@media (max-width: 640px){
  .statsGrid{ grid-template-columns: 1fr; }
  .statsCard[style*="grid-column"]{ grid-column:auto !important; }
}
  /* =================================================
   FINANSIJE ‚Äì KARTICE ISTE KAO DUGOVANJA
================================================= */
#financeList li.finCard{
  background: rgba(15, 23, 42, .18) !important;
  border: 1px solid rgba(15, 23, 42, .22) !important;
  box-shadow: 0 10px 26px rgba(2, 6, 23, .10) !important;
}

/* hover (opciono, da bude kao ‚Äú≈æiv‚Äù efekat) */
#financeList li.finCard:hover{
  background: rgba(15, 23, 42, .22) !important;
}

  /* =================================================
   UNOSI ‚Äî ISTA NIJANSA KAO DUGOVANJA (toolbar)
   (finansije + oglasna + forum + uplata dugovanja)
================================================= */

#financeFormWrap .field input,
#financeFormWrap .field select,
#financeFormWrap .field textarea,

#boardFormWrap .field input,
#boardFormWrap .field select,
#boardFormWrap .field textarea,

#forumCreateWrap .field input,
#forumCreateWrap .field textarea,

#duesPayWrap .field input,
#duesPayWrap .field select,
#duesPayWrap .field textarea{
  background: rgba(248,250,252,.88);
  border: 1px solid rgba(15,23,42,.14);
  color: rgba(15,23,42,.92);
  border-radius: 14px;
}

/* fokus */
#financeFormWrap .field input:focus,
#financeFormWrap .field select:focus,
#financeFormWrap .field textarea:focus,

#boardFormWrap .field input:focus,
#boardFormWrap .field select:focus,
#boardFormWrap .field textarea:focus,

#forumCreateWrap .field input:focus,
#forumCreateWrap .field textarea:focus,

#duesPayWrap .field input:focus,
#duesPayWrap .field select:focus,
#duesPayWrap .field textarea:focus{
  outline: none;
  background: rgba(248,250,252,.94);
  border-color: rgba(15,23,42,.25);
  box-shadow: 0 0 0 4px rgba(15,23,42,.06);
}

/* disabled / readonly */
#financeFormWrap .field input[readonly],
#financeFormWrap .field input:disabled{
  opacity: .85;
  cursor: not-allowed;
}

/* =================================================
   PROFI LIST ITEM UI (Finansije + Oglasna)
================================================= */

.itemHead{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}

.itemLeft{
  flex:1;
  min-width:0;
}

.itemMeta{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
}
.itemMeta .pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  border:1px solid rgba(15,23,42,.14);
  background: rgba(255,255,255,.55);
  color: rgba(15,23,42,.88);
  white-space:nowrap;
}

.itemMeta .pill.type-rashod{
  color:#b91c1c;
  background: rgba(220,38,38,.12);
  border-color: rgba(220,38,38,.30);
}

.itemMeta .pill.type-prihod{
  color:#166534;
  background: rgba(22,163,74,.12);
  border-color: rgba(22,163,74,.28);
}

/* opis */
.itemDesc{
  margin-top:6px;
  font-weight:800;
  color: rgba(15,23,42,.70);
  line-height:1.35;

  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

/* iznos (price-tag) */
.itemAmount{
  flex:0 0 auto;
  padding:8px 12px;
  border-radius:14px;
  font-weight:900;
  white-space:nowrap;
  border:1px solid rgba(15,23,42,.14);
  background: rgba(255,255,255,.62);
  color: rgba(15,23,42,.92);
}

.itemAmount.rashod{
  border-color: rgba(220,38,38,.25);
}
.itemAmount.prihod{
  border-color: rgba(22,163,74,.22);
}

/* mobile */
@media (max-width: 640px){
  .itemHead{ flex-direction:column; }
  .itemAmount{ align-self:flex-start; }
}

  #regList li{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

.lawPdfLink{
  padding:6px 12px;
  border-radius:10px;
  background:#eef2ff;
  color:#1e3a8a;
  font-weight:600;
  text-decoration:none;
}

.lawPdfLink:hover{
  background:#e0e7ff;
}

/* ‚úÖ UNIFIED HOVER: Finansije + Dugovanja + Oglasna (kartice) */
.finCard,
.duesRow{
  transition: background .12s ease, transform .12s ease;
}

.finCard:hover,
.duesRow:hover{
  background: rgba(15, 23, 42, .22) !important;
  transform: translateY(-1px);
}

  /* =========================
   ADMIN UPLOAD GRID (kao Dugovanja)
========================= */
.uplRow{
  /* isto kao duesRow, ali drugaƒçije kolone */
  grid-template-columns: 260px 1fr 1fr 1fr; /* zgrada | finansije | oglasna | ukupno */
}

@media (max-width: 920px){
  .uplRow{
    grid-template-columns: 1fr;
  }
}

/* ===== ADMIN DROPDOWN (PRO LOOK) ===== */
.adminTopWrap{
  position: relative;
  display: inline-block;
  width: 100%;
}

.adminToggle{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border-radius:14px;
  background: rgba(255,255,255,.65);
  border: 1px solid rgba(15,23,42,.14);
  backdrop-filter: blur(10px);
  cursor:pointer;
  user-select:none;
}

#adminToggleLabel{
  font-weight:900;
}

#adminActiveBuilding{
  font-weight:700;
  opacity:.8;
}

.adminArrow{
  margin-left:auto;
  font-size:16px;
  padding:6px 10px;
  border-radius:12px;
  border:1px solid rgba(15,23,42,.12);
  background: rgba(255,255,255,.6);
}

/* dropdown panel */
.adminMenu{
  position:absolute;
  top: calc(100% + 8px);
  left: 0;
  width: min(520px, 100%);
  background: rgba(255,255,255,.92);
  border: 1px solid rgba(15,23,42,.14);
  border-radius: 14px;
  box-shadow: 0 18px 40px rgba(2,6,23,.14);
  padding: 8px;
  z-index: 9999;
}

.adminMenuItem{
  width: 100%;
  display: block;
  text-align: left;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid transparent;
  background: transparent;
  cursor: pointer;
  font-weight: 700;
}

.adminMenuItem:hover{
  background: rgba(15,23,42,.06);
  border-color: rgba(15,23,42,.10);
}

.hidden{ display:none; }


.adminNavBtn{
  margin-left:auto;
  padding:6px 10px;
  border-radius:10px;
  border:1px solid rgba(15,23,42,.14);
  background:rgba(248,250,252,.92);
  cursor:pointer;
  font-weight:700;
  font-size:12px;
}

  /* ===== FORUM ‚Äì PROCENTI GLASANJA ===== */
.pollStats{
  font-size:13px;
  color:var(--muted);
}

.pollBar{
  display:flex;
  height:8px;
  border-radius:6px;
  overflow:hidden;
  background:rgba(15,23,42,.12);
  margin-bottom:6px;
}

.pollYes{
  background:#22c55e;
}

.pollNo{
  background:#ef4444;
}

.pollText{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
}

.pollSep{
  opacity:.6;
}

/* ===== VLASNICI STANOVA ===== */
.unitOwnerRow{
  display:flex;
  gap:10px;
  align-items:center;
}

.unitOwnerRow .unitCode{
  min-width:90px;
  font-weight:600;
}

.unitOwnerRow input{
  flex:1;
}

/* ‚úÖ NOVO: red sa (Promeni zgradu + Pretraga) */
.headerTools{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:flex-end;
  flex-wrap:wrap;
}

  /* ================= HEADER TOOLS ================= */
.headerTools{
  display: flex;
  align-items: center;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 8px;
  flex-wrap: wrap;
}

/* dugme da se ne lomi */
#switchBuildingBtn{
  white-space: nowrap;
}

/* pretraga u headeru */
.headerTools .searchInline{
  min-width: 260px;
}

#globalSearch{
  width: 320px;
  max-width: 45vw;
}

  /* ‚úÖ sticky top bar (da alatke ostanu vidljive pri scroll-u) */
.pageHeader{
  position: sticky;
  top: 12px;
  z-index: 50;
}

/* ===== TOP ROW: tools levo, user/building desno ===== */
.rightCol{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:10px;
}

.topRow{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:12px;
}

/* tools stoje levo od user pill-ova */
.headerTools{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:nowrap;
  justify-content:flex-end;
  margin-top:0; /* bitno da ne ‚Äúspu≈°ta‚Äù */
}

/* user/building pill-ovi desno */
.topMini{
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:flex-end;
  flex-wrap:wrap;
}

/* ≈°irina pretrage u headeru */
.headerTools .searchInline{ min-width: 260px; }
#globalSearch{ width: 320px; max-width: 40vw; }
#switchBuildingBtn{ white-space: nowrap; }
  
</style>
</head>

<body class="mode-login">
<div class="ambient"></div>

<!-- TOP RIGHT BRAND -->
<div class="topRightBar">
  <div class="topRightTitle">

    <!-- USER ID BADGE -->
    <div class="userBadge" id="userBadge"></div>

    <span>Portal</span>
    <span>Upravnik</span>
  </div>

  <div class="topRightLogo">
    <img src="logo.png" alt="Portal Upravnik logo">
  </div>
</div>


<!-- LOGIN SCREEN -->
<section class="loginWrap" id="loginScreen">
  <div class="loginCard">
    <div class="loginInner">

      <div class="loginHead">
        <div class="formTitle">Prijava</div>
      </div>

      <div class="formSub">
        Unesite korisniƒçko ime i lozinku sa kartice.
      </div>

      <div class="field">
        <label for="username">Korisniƒçko ime</label>
        <input id="username" type="text" placeholder="npr. PU7X9-001" autocomplete="username">
      </div>

      <div class="field">
        <label for="pass">Lozinka</label>
        <div class="inputWrap">
          <input id="pass" type="password" placeholder="Unesi lozinku" autocomplete="current-password">
          <button class="eyeBtn" id="togglePass" type="button">üëÅ</button>
        </div>
      </div>

      <div class="row">
        <label class="check">
          <input id="remember" type="checkbox" checked>
          Zapamti me
        </label>
      </div>

      <div class="btnRow">
        <button class="btn btnPrimary" id="loginBtn">Uloguj se</button>
      </div>

      <div class="error" id="loginError">Pogresno korisniƒçko ime ili lozinka.</div>

      <div class="miniHint">
        U sluƒçaju zaboravljenog naloga ili lozinke kontaktirajte upravnika.
      </div>

    </div>
  </div>
</section>

<!-- BUILDING SELECT SCREEN -->
<section class="loginWrap" id="buildingSelectScreen">
  <div class="loginCard">
    <div class="loginInner">

      <div class="loginHead">
        <div class="formTitle">Izaberi stambenu zajednicu</div>
      </div>

      <div class="formSub" id="bsSub">
        Izaberite zgradu koju zelite da otvorite.
      </div>

      <div class="pickList" id="buildingPickList"></div>

      <div class="btnRow" style="margin-top:16px;">
        <button class="btn btnGhost" id="bsLogoutBtn" type="button">Odjava</button>
      </div>

    </div>
  </div>
</section>

<!-- PORTAL SCREEN -->
<div id="portalScreen">

  <div class="edgeHotspot" id="edgeHotspot"></div>
  <div class="overlay" id="overlay"></div>
  <div class="hamburger" id="hamburger">‚ò∞</div>

  <aside class="sidebar" id="sidebar">
    

    <nav class="nav" id="nav">
      <a href="#" class="active" data-page="home">Poƒçetna</a>
      <a href="#" data-page="finansije">Finansije</a>
      <a href="#" data-page="oglasna">Oglasna tabla</a>
      <a href="#" data-page="forum">Forum</a>
      <a href="#" data-page="regulative">Zakonske regulative</a>
      <a href="#" data-page="kontakt">Kontakt slu≈æbe</a>

<!-- ‚úÖ STATISTIKA (samo upravnik/admin) -->
<a href="#" data-page="statistika" data-role="manage">Statistika</a>

<!-- ‚úÖ ODJAVA (uvek poslednja) -->
<a href="#" id="sidebarLogout" class="logoutItem">Odjava</a>


    </nav>
  </aside>

  <main class="main">
    <div class="contentWrap">

      <section class="pageHeader">
        <div class="leftInfo">
          <div class="meta" id="buildingMeta">
            <!-- popunjava JS -->
          </div>
        </div>

        <div class="rightCol">
  <div class="topRow">
  <div class="headerTools">
    <div class="pill pillBtn" id="switchBuildingBtn" style="display:none;">Promeni zgradu</div>

    <div class="searchInline" style="position:relative;">
      <input id="globalSearch" placeholder="Pretraga (finansije, dokumenti, forum)">
      <div class="searchResults" id="searchResults" style="display:none;"></div>
    </div>
  </div>

  <div class="topMini">
    <div class="pill" id="userPill">Korisnik</div>
    <div class="pill" id="buildingPill">Zgrada</div>
  </div>
</div>

  <div class="balanceCard">
    <span class="label">Stanje raƒçuna</span>
    <div class="balanceAmount">
      <span class="value" id="balanceValue">0,00</span>
      <span class="currency">RSD</span>
    </div>
  </div>
</div>
      </section>

      <section class="page active" id="page-home">
        <section class="card">
          <h3>Poƒçetna</h3>

                    <ul class="boardList" style="margin-top:12px;">
            <li id="homeLastChange">Poslednja promena: (nema)</li>
            <li id="homePinned">Istaknuto: (nema)</li>
            <li id="homeForum">Forum: (nema)</li>
          </ul>


          
          <div class="smallText" data-role="admin" style="margin-top:12px;">
            Admin: placeholder (upravljanje korisnicima, regulativama i kontaktima).
          </div>
        </section>
      </section>

      <!-- FINANSIJE -->
<section class="page" id="page-finansije">
  <section class="card">

    <div class="finTitleRow">
      <h3>Finansije</h3>

      <!-- ADMIN: Promeni zgradu (Finansije) -->
      <div id="adminFinBuildingSwitch" data-role="admin" style="display:none;"></div>

      <!-- STANAR: Moj dug/pretplata u naslovu Finansija -->
      <div class="finTenantBadge status-obaveza" data-role="stanar" id="finTenantBadge" style="display:none;">
        <span id="finTenantBadgeText">0,00 RSD</span>
      </div>
    </div>

    <!-- ADMIN: Upravljanje stanovima -->
    <div id="adminUnitsWrap" data-role="admin" style="display:none; margin-top:14px;">
      <div class="badge">Upravljanje stanovima (samo admin)</div>

      <div class="fRow" style="margin-top:10px; gap:10px; align-items:flex-end;">
        <button class="btn btnPrimary" type="button" id="adminAddUnitBtn">Dodaj stan</button>
        <div class="smallText" style="opacity:.75">
          Dodaje novi stan (npr. BM25-026). Ime vlasnika unosi admin.
        </div>
      </div>

<!-- ADMIN: forma za dodavanje stana (kao za zgradu) -->
<div id="adminAddUnitForm" style="display:none; margin-top:12px;">
  <div class="fRow" style="gap:10px; align-items:flex-end; flex-wrap:wrap;">
    <div class="field" style="min-width:160px;">
      <label>≈†ifra zgrade</label>
      <input id="adminUnitBCode" type="text" disabled>
    </div>

    <div class="field" style="min-width:320px; flex:1;">
      <label>Adresa</label>
      <input id="adminUnitAddr" type="text" disabled>
    </div>

    <div class="field" style="min-width:260px; flex:1;">
      <label>Ime i prezime vlasnika</label>
      <input id="adminUnitOwner" type="text" placeholder="npr. Marko Markoviƒá">
    </div>

    <div class="field" style="min-width:180px;">
      <label>Novi ID stana</label>
      <input id="adminUnitCode" type="text" placeholder="npr. BM25-026">
    </div>

    <button class="btn btnPrimary" type="button" id="adminSaveUnitBtn">Saƒçuvaj</button>
    <button class="btn btnGhost" type="button" id="adminCancelUnitBtn">Odustani</button>
  </div>

  <div class="smallText" style="opacity:.75; margin-top:8px;">
    ID stana se predla≈æe automatski, mo≈æe≈° ga ruƒçno izmeniti.
  </div>
</div>
      
      <div id="adminUnitsList" class="list" style="margin-top:10px;"></div>
    </div>

<!-- ADMIN: detalji stana (otvara se klikom na red) -->
<div id="adminUnitDetails" style="display:none; margin-top:12px;">
  <div class="badge" id="audTitle">Stan</div>

  <div class="fRow" style="margin-top:10px; gap:10px; align-items:flex-end; flex-wrap:wrap;">
    <div class="field" style="min-width:180px;">
      <label>ID stana</label>
      <input id="audUnitCode" type="text" disabled>
    </div>

    <div class="field" style="min-width:260px; flex:1;">
      <label>Ime i prezime vlasnika</label>
      <input id="audOwner" type="text" placeholder="npr. Marko Markoviƒá">
    </div>

    <button class="btn btnPrimary" type="button" id="audSaveBtn">Saƒçuvaj</button>
    <button class="btn btnGhost" type="button" id="audCloseBtn">Zatvori</button>
    <button class="btn btnGhost" type="button" id="audDeleteBtn">Obri≈°i</button>
  </div>

  <div class="smallText" style="opacity:.7; margin-top:6px;">
    Ovde menja≈° samo vlasnika za izabrani stan.
  </div>
</div>
    
          <div class="fRow" data-role="upravnik" style="margin-top:12px; gap:10px;">
  <button class="btn btnPrimary" id="finTabEntries">Finansijske promene</button>
  <button class="btn btnGhost" id="finTabDues">Dugovanja stanara</button>
</div>

       <div id="finEntriesWrap">  

<!-- ADMIN: Upravljanje zgradama -->
<div id="adminBuildingsWrap" data-role="admin" style="display:none; margin-top:14px;">
  <div class="badge">Upravljanje zgradama (samo admin)</div>

  <div class="fRow" style="margin-top:10px; gap:10px; align-items:flex-end; flex-wrap:wrap;">
    <div class="field" style="min-width:160px;">
      <label>≈†ifra zgrade (npr. BM25)</label>
      <input id="adminBCode" type="text" placeholder="BM25">
    </div>

    <div class="field" style="min-width:260px; flex:1;">
      <label>Naziv zgrade</label>
      <input id="adminBTitle" type="text" placeholder="Bore Markoviƒáa 25">
    </div>

    <div class="field" style="min-width:220px; flex:1;">
      <label>Ulica</label>
      <input id="adminBStreet" type="text" placeholder="Bore Markoviƒáa">
    </div>

    <div class="field" style="min-width:120px;">
      <label>Broj</label>
      <input id="adminBNumber" type="text" placeholder="25">
    </div>

    <div class="field" style="min-width:120px;">
      <label>Broj stanova</label>
      <input id="adminBUnits" type="number" min="1" placeholder="25">
    </div>

    <button class="btn btnPrimary" type="button" id="adminAddBuildingBtn">
      Dodaj zgradu
    </button>
  </div>

  <div id="adminBuildingsList" class="list" style="margin-top:10px;"></div>
</div>
         
<!-- FIN HEADER CONTROLS (filter/sort) -->
<div class="fRow" style="margin-top:12px; gap:10px; align-items:flex-end;">
  <div class="half field" style="margin-top:0;">
    <label for="finFilterType">Tip</label>
    <select id="finFilterType">
      <option value="svi">Svi</option>
      <option value="prihod">Prihod</option>
      <option value="rashod">Rashod</option>
    </select>
  </div>

  <div class="half field" style="margin-top:0;">
    <label for="finFilterCategory">Kategorija</label>
    <select id="finFilterCategory">
      <option value="">Sve</option>
      <option value="hitna intervencija">Hitna intervencija</option>
      <option value="tekuƒáe odr≈æavanje">Tekuƒáe odr≈æavanje</option>
      <option value="lift">Lift</option>
      <option value="ostalo">Ostalo</option>
      <option value="drugo">Drugo</option>
    </select>
  </div>

  <div class="half field" style="margin-top:0; display:none;">
  <label for="finSortBy">Sortiranje</label>
  <select id="finSortBy">
    <option value="date-desc">Datum ‚Üì</option>
    <option value="date-asc">Datum ‚Üë</option>
    <option value="amount-desc">Iznos ‚Üì</option>
    <option value="amount-asc">Iznos ‚Üë</option>
  </select>
</div>


  <div class="grow field" style="margin-top:0;">
    <label for="finLocalSearch">Pretraga</label>
    <input id="finLocalSearch" type="text" placeholder="npr. lift, servis, 120000...">
  </div>
</div>
<!-- /FIN HEADER CONTROLS -->
         
          <!-- ‚úÖ DODATO: POCETNO STANJE (samo admin/upravnik) -->
          <div class="smallText" data-role="upravnik" style="margin-top:12px;">
  <div class="fRow">
    <div class="grow" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      <span class="badge" style="font-size:11px; padding:6px 10px; opacity:.75;">
        Poƒçetno stanje (RSD)
      </span>

      <div class="field openingBalanceWrap" style="margin-top:0; width:220px; display:flex; align-items:center; gap:8px;">
  <input id="openingBalanceInput" type="number" step="0.01"
    placeholder="npr. 948889"
    style="height:36px; border-radius:14px; padding:8px 10px;">

  <span id="openingBalanceLock"
        class="lockIcon locked"
        title="Zakljuƒçano ‚Äì kliknite Izmeni">
  </span>
</div>
      <button class="btn btnGhost" id="editOpeningBalanceBtn" type="button"
        style="flex:unset; padding:10px 14px; border-radius:14px;">
  Izmeni
</button>

<button class="btn btnGhost" id="saveOpeningBalanceBtn" type="button"
        style="flex:unset; padding:10px 14px; border-radius:14px; display:none;">
  Saƒçuvaj
</button>
    </div>
  </div>
</div>

             <div class="smallText" data-role="admin" style="margin-top:12px;">
  <div class="fRow">
    <div class="grow" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      <span class="badge" style="font-size:11px; padding:6px 10px; opacity:.75;">
        Poƒçetno stanje (RSD)
      </span>

      <div class="field" style="margin-top:0; width:220px;">
        <input id="openingBalanceInputAdmin" type="number" step="0.01" placeholder="npr. 948889"
               style="height:36px; border-radius:14px; padding:8px 10px;">
      </div>

      <button class="btn btnGhost" id="editOpeningBalanceBtnAdmin" type="button"
        style="flex:unset; padding:10px 14px; border-radius:14px;">
  Izmeni
</button>

<button class="btn btnGhost" id="saveOpeningBalanceBtnAdmin" type="button"
        style="flex:unset; padding:10px 14px; border-radius:14px; display:none;">
  Saƒçuvaj
</button>
    </div>
  </div>
</div>

          <!-- ‚úÖ /DODATO -->

          <div class="smallText" data-role="upravnik" style="margin-top:12px;">
            <div class="fRow">
              <div class="grow">
                <span class="badge">Upravnik</span>
                <span class="badge" style="margin-left:8px;">Upload limit: 10MB po unosu</span>
              </div>
              <div>
                <button class="btn btnGhost" id="addFinanceBtn" type="button">Dodaj finansijsku stavku</button>
              </div>
            </div>
          </div>

          <div id="financeFormWrap" data-role="upravnik" style="display:none; margin-top:12px;">
            <div class="fRow">
              <div class="half field">
                <label for="fDate">Datum</label>
                <input id="fDate" type="date">
              </div>

              <div class="half field">
                <label for="fType">Tip</label>
                <select id="fType">
                  <option value="rashod">Rashod</option>
                  <option value="prihod">Prihod</option>
                </select>
              </div>

              <div class="half field">
                <label for="fCategory">Kategorija</label>
                <select id="fCategory">
                  <option value="hitna intervencija">Hitna intervencija</option>
                  <option value="tekuƒáe odr≈æavanje">Tekuƒáe odr≈æavanje</option>
                  <option value="lift">Lift</option>
                  <option value="ostalo">Ostalo</option>
                  <option value="drugo">Drugo</option>
                </select>
              </div>

              <div class="half field">
                <label for="fFirm">Firma (dropdown)</label>
                <select id="fFirm"></select>
              </div>

              <div class="grow field">
                <label for="fFirmNew">Nova firma (opciono)</label>
                <input id="fFirmNew" type="text" placeholder="Unesi novu firmu ako ne postoji u listi">
              </div>

              <div class="grow field">
                <label for="fDesc">Opis</label>
                <input id="fDesc" type="text" placeholder="npr. placanje racuna / uplata stanara">
              </div>

              <div class="grow field">
                <label for="fAmount">Iznos (RSD)</label>
                <input id="fAmount" type="number" step="0.01" placeholder="npr. 12500">
              </div>

              <div class="grow field">
                <label for="fDocs">Dokumenti (vi≈°e fajlova)</label>
                <input id="fDocs" type="file" multiple accept="application/pdf">
                <div class="smallText" style="margin-top:6px;">
                  Ukupna veliƒçina fajlova po unosu max 10MB. Klik na fajl u listi = otvori PDF.
                </div>
              </div>
<div class="grow" id="existingDocsWrap" style="display:none; margin-top:6px;">
  <div class="smallText" style="margin-top:6px;">
    Postojeƒái dokumenti (klik ‚ÄúUkloni‚Äù da izbri≈°e≈° iz stavke):
  </div>
  <ul class="fileList" id="existingDocsList"></ul>
</div>

              <div class="grow" style="display:flex; gap:10px; margin-top:6px;">
                <button class="btn btnPrimary" id="saveFinanceBtn" type="button">Saƒçuvaj</button>
                <button class="btn btnGhost" id="cancelFinanceBtn" type="button">Otka≈æi</button>
              </div>

              <div class="error" id="financeError" style="display:none;">Gre≈°ka: proveri polja i limit fajlova (10MB).</div>
            </div>
          </div>

          <ul class="boardList" id="financeList"></ul>

</div><!-- /finEntriesWrap -->

          <div id="finDuesWrap" style="display:none;">
         
<!-- ‚úÖ DUG / PRETPLATA STANARA (samo upravnik) -->
<div class="smallText" data-role="upravnik" style="margin-top:14px;">
  <span class="badge">Dug / pretplata stanara</span>

  <div class="fRow" style="margin-top:10px; gap:10px; align-items:flex-end;">
    <div class="half field" style="margin-top:0;">
      <label for="monthlyFeeInput">Meseƒçna obaveza (RSD)</label>
      <input id="monthlyFeeInput" type="number" min="0" step="1" value="2000">
    </div>

    <div class="half field" style="margin-top:0;">
      <label for="duesStartMonth">Poƒçetni mesec obraƒçuna</label>
      <input id="duesStartMonth" type="month">
    </div>

    <div>
      <button class="btn btnGhost" id="saveDuesSettingsBtn" type="button" style="flex:unset;">
        Saƒçuvaj pode≈°avanja
      </button>
    </div>
  </div>

  <!-- ===== Dugovanja stanara: toolbar + grid ===== -->
<div class="duesToolbar">
  <div class="field" style="min-width:220px;">
    <label for="duesSearch">Pretraga stanara</label>
    <input id="duesSearch" type="text" placeholder="npr. BM25-002">
  </div>

  <div class="field" style="min-width:220px;">
    <label for="duesFilter">Filter</label>
    <select id="duesFilter">
      <option value="svi">Svi</option>
      <option value="dug">Samo dug</option>
      <option value="nula">Samo 0</option>
      <option value="pretplata">Samo pretplata</option>
    </select>
  </div>

  <div class="field" style="min-width:220px;">
    <label for="duesSort">Sortiranje</label>
    <select id="duesSort">
      <option value="user-asc">Korisnik A‚ÄìZ</option>
      <option value="saldo-asc">Najveƒái dug</option>
      <option value="saldo-desc">Najveƒáa pretplata</option>
    </select>
  </div>
</div>

<!-- ===== VLASNICI STANOVA (samo upravnik/admin) ===== -->
<div id="unitOwnersWrap" style="display:none; margin-top:16px;">
  <div class="badge">Vlasnici stanova (vidljivo samo upravniku i adminu)</div>

  <div class="fRow" style="margin-top:10px;">
    <div class="smallText" style="opacity:.75">
      Unesi ime i prezime vlasnika za svaki stan. Podaci nisu vidljivi stanarima.
    </div>
  </div>

  <div id="unitOwnersTable" class="list" style="margin-top:10px;"></div>
</div>

  
<div class="duesGrid" id="duesGrid"></div>

  <div id="duesPayWrap" style="display:none; margin-top:14px;">
    <div class="badge" id="duesPayTitle">Uplata</div>

    <div class="fRow" style="margin-top:10px; gap:10px; align-items:flex-end;">
      <div class="half field" style="margin-top:0;">
        <label for="duesPayDate">Datum uplate</label>
        <input id="duesPayDate" type="date">
      </div>

      <div class="half field" style="margin-top:0;">
        <label for="duesPayAmount">Iznos (RSD)</label>
        <input id="duesPayAmount" type="number" step="0.01" placeholder="npr. 2000">
      </div>

      <div class="grow field" style="margin-top:0;">
        <label for="duesPayNote">Napomena (opciono)</label>
        <input id="duesPayNote" type="text" placeholder="npr. januar 2026 / dug / korekcija">
      </div>
    </div>
    
    <div class="field" style="margin-top:10px;">
      <label for="duesPayDocs">PDF potvrde (vi≈°e fajlova, max 10MB)</label>
      <input id="duesPayDocs" type="file" multiple accept="application/pdf">
    </div>

    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
      <button class="btn btnPrimary" id="duesPaySaveBtn" type="button" style="flex:unset;">Saƒçuvaj uplatu</button>
      <button class="btn btnGhost" id="duesPayCancelBtn" type="button" style="flex:unset;">Otka≈æi</button>
    </div>

    <div class="error" id="duesPayError" style="display:none;"></div>
</div> <!-- /duesPayWrap -->

</div>

  <!-- ‚úÖ IZMJENA / KOREKCIJA (UPRAVNIK / ADMIN) -->
<div id="duesAdjWrap" style="display:none; margin-top:14px;">
  <div class="badge" id="duesAdjTitle">Izmena</div>

  <div class="fRow" style="margin-top:10px; gap:10px; align-items:flex-end;">
    <div class="half field">
      <label for="duesAdjDate">Datum izmene</label>
      <input id="duesAdjDate" type="date">
    </div>

    <div class="half field">
      <label for="duesAdjKind">Akcija</label>
      <select id="duesAdjKind">
        <option value="plus">Poveƒáaj iznos</option>
        <option value="minus">Smanji iznos</option>
      </select>
    </div>

    <div class="half field">
      <label for="duesAdjAmount">Iznos (RSD)</label>
      <input id="duesAdjAmount" type="number" step="0.01">
    </div>

    <div class="grow field">
      <label for="duesAdjNote">Razlog</label>
      <input id="duesAdjNote" type="text" placeholder="npr. korekcija / gre≈°ka u uplati">
    </div>
  </div>

  <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
    <button class="btn btnPrimary" id="duesAdjSaveBtn" type="button" style="flex:unset;">Saƒçuvaj izmenu</button>
    <button class="btn btnGhost" id="duesAdjCancelBtn" type="button" style="flex:unset;">Otka≈æi</button>
  </div>

  <div class="error" id="duesAdjError" style="display:none;"></div>
</div>
            
</div><!-- /finDuesWrap -->
            
          <!-- ‚úÖ STANAR: moj dug / pretplata (read-only) -->
<div class="smallText" data-role="stanar" id="tenantDuesBox" style="margin-top:14px;">
  <span class="badge">Moj dug / pretplata</span>

  <div class="fRow" style="margin-top:10px; gap:10px;">
    <span class="badge status-uplaceno">
  Uplaƒáeno: <b id="tPaid">0,00</b> RSD
</span>

<span class="badge status-obaveza">
  Obaveza: <b id="tExpected">0,00</b> RSD
</span>

<span class="badge status-dug" id="tSaldoBadge">
  0,00
</span>
  </div>

  <div class="smallText" id="tPeriod" style="margin-top:8px;"></div>
</div>

        </section>
      </section>

      <!-- OGLASNA -->
      <section class="page" id="page-oglasna">
        <section class="card">
          <h3>Oglasna tabla</h3>

                   <div class="smallText" data-role="upravnik" style="margin-top:12px;">
            <div class="fRow">
              <div class="grow">
                <span class="badge">Upravnik</span>
                <span class="badge" style="margin-left:8px;">Upload limit: 10MB po objavi</span>
              </div>
              <div>
                <button class="btn btnGhost" id="addBoardBtn" type="button">Dodaj objavu</button>
              </div>
            </div>
          </div>

          <div id="boardFormWrap" data-role="upravnik" style="display:none; margin-top:12px;">
            <div class="fRow">
              <div class="grow field">
                <label for="bTitle">Naslov objave</label>
                <input id="bTitle" type="text" placeholder="npr. Odluka skup≈°tine stanara">
              </div>

              <div class="half field">
                <label for="bDate">Datum</label>
                <input id="bDate" type="date">
              </div>

              <div class="grow field">
                <label for="bDesc">Kratak opis</label>
                <input id="bDesc" type="text" placeholder="npr. Odluka o tekuƒáe odr≈æavanje">
              </div>

              <div class="grow field">
                <label for="bDocs">PDF dokumenta (vi≈°e fajlova)</label>
                <input id="bDocs" type="file" multiple accept="application/pdf">
                <div class="smallText" style="margin-top:6px;">
                  Ukupna velicina fajlova po objavi max 10MB.
                </div>
              </div>

              <div class="grow" style="display:flex; gap:10px; margin-top:6px;">
                <button class="btn btnPrimary" id="saveBoardBtn" type="button">Objavi</button>
                <button class="btn btnGhost" id="cancelBoardBtn" type="button">Otka≈æi</button>
              </div>

              <div class="error" id="boardError" style="display:none;">Gre≈°ka: proveri polja i limit fajlova (10MB).</div>
            </div>
          </div>

          <ul class="boardList" id="boardList"></ul>

          <div class="smallText" style="margin-top:10px;">
            
          </div>
        </section>
      </section>

      <!-- FORUM -->
      <section class="page" id="page-forum">
        <section class="card">
          <h3>Forum</h3>

                   <div data-role="stanar" id="forumCreateWrap" style="margin-top:12px;">
            <div class="fRow">
              <div class="grow field">
                <label for="pTitle">Naslov predloga</label>
                <input id="pTitle" type="text" placeholder="npr. Zamena svetla u hodniku">
              </div>
              <div class="grow field">
                <label for="pBody">Opis</label>
                <textarea id="pBody" placeholder="Kratak opis predloga (bez licnih podataka)"></textarea>
              </div>

              <div class="grow" style="display:flex; gap:10px; margin-top:6px;">
                <button class="btn btnPrimary" id="createProposalBtn" type="button">Objavi predlog</button>
                <button class="btn btnGhost" id="clearProposalBtn" type="button">Odustani</button>
              </div>

              <div class="error" id="forumError" style="display:none;">Gre≈°ka: proveri polja.</div>
            </div>
          </div>

          <ul class="boardList" id="forumList"></ul>
        </section>
      </section>

      <section class="page" id="page-regulative">
        <section class="card">
          <h3>Zakonske regulative</h3>
          
          <div class="smallText" data-role="admin">
            Admin: placeholder (upload/izmena regulativa).
          </div>
            
          <ul class="boardList" id="regList">
  <li>
    Zakon o stanovanju i odr≈æavanju zgrada
    <a
      href="Zakon_o_stanovanju_i_odrzavanju_zgrada.pdf"
      target="_blank"
      class="lawPdfLink"
    >
      PDF
    </a>
  </li>

  <li>Pravilnik o upravljanju stambenim zajednicama (PDF)</li>
</ul>
        </section>
      </section>

      <section class="page" id="page-kontakt">
        <section class="card">
          <h3>Kontakt slu≈æbe</h3>

          <div class="smallText" data-role="admin">
            Admin: placeholder (izmena kontakata i brojeva).
          </div>

          <ul class="boardList" id="kontaktList">
            <li>Vatrogasci: 193</li>
            <li>Hitna pomoc: 194</li>
            <li>Policija: 192</li>
            <li>EPS kvarovi: (placeholder)</li>
          </ul>
        </section>
      </section>

<section class="page" id="page-statistika">
  <section class="card">
    <h3>Statistika</h3>

    <!-- ================= ADMIN: potro≈°nja upload-a (SVE ZGRADE) ================= -->
<div data-role="admin" style="margin-top:14px;">

  <div class="badge">Admin ‚Äî Potro≈°nja upload-a po zgradama</div>

  <!-- pretraga + totals -->
  <div class="duesToolbar" style="margin-top:12px;">
    <div class="field" style="min-width:260px;">
      <label for="uplAdminSearchFin">Pretraga zgrade</label>
      <input
        id="uplAdminSearchFin"
        type="text"
        placeholder="npr. Bore, BM25, NC28, Nedeljka..."
      >
      <div class="smallText" style="margin-top:6px; opacity:.8;">
        Ukucaj adresu i izaberi zgradu
      </div>
    </div>

    <div class="duesBadges" style="margin-left:auto;">
      <span class="duesBadge">
        Ukupno fajlova: <b id="uplAdminTotalFilesFin">0</b>
      </span>
      <span class="duesBadge">
        Ukupno MB: <b id="uplAdminTotalMBFin">0.00</b>
      </span>
    </div>
  </div>

  <!-- dropdown lista zgrada -->
  <div class="adminTopWrap" style="margin-top:10px;">
    <div id="adminBuildingMenuFin" class="adminMenu hidden"></div>
  </div>

  <!-- rezultat -->
  <div class="duesGrid" id="uplAdminGridFin" style="margin-top:12px;"></div>
</div>
<!-- ================= /ADMIN ================= -->

<div data-role="upravnik" style="margin-top:12px;">
  <div class="half field" style="margin-top:0; min-width:220px;">
   <div class="monthPick">
  <label class="mpLabel" for="uplMonthMonth">Mesec (obraƒçun upload-a)</label>

  <div class="monthPickRow">
    <select id="uplMonthMonth" class="mpSelect">
      <option value="">Mesec</option>
      <option value="01">Januar</option>
      <option value="02">Februar</option>
      <option value="03">Mart</option>
      <option value="04">April</option>
      <option value="05">Maj</option>
      <option value="06">Jun</option>
      <option value="07">Jul</option>
      <option value="08">Avgust</option>
      <option value="09">Septembar</option>
      <option value="10">Oktobar</option>
      <option value="11">Novembar</option>
      <option value="12">Decembar</option>
    </select>

    <select id="uplMonthYear" class="mpSelect">
      <option value="">Godina</option>
      <!-- JS automatski puni -->
    </select>

    <button type="button" class="btn btnPrimary mpBtn" id="uplMonthApply">
      Primeni
    </button>
  </div>

  <!-- hidden value kao YYYY-MM -->
  <input type="hidden" id="uplMonthPick" value="">

  <div class="mpHint" id="uplMonthHint">Izaberi mesec i godinu</div>
</div>


  <div class="statsGrid">
    <div class="statsCard">
      <h4>Finansije</h4>
      <div class="statsRows">
        <div class="statRow"><span class="k">Unosa</span><span class="v" id="uplFinEntries">0</span></div>
        <div class="statRow"><span class="k">Fajlova</span><span class="v" id="uplFinFiles">0</span></div>
        <div class="statRow"><span class="k">MB</span><span class="v" id="uplFinMB">0.00</span></div>
      </div>
    </div>

    <div class="statsCard">
      <h4>Oglasna</h4>
      <div class="statsRows">
        <div class="statRow"><span class="k">Objava</span><span class="v" id="uplBrdEntries">0</span></div>
        <div class="statRow"><span class="k">Fajlova</span><span class="v" id="uplBrdFiles">0</span></div>
        <div class="statRow"><span class="k">MB</span><span class="v" id="uplBrdMB">0.00</span></div>
      </div>
    </div>

    <div class="statsCard" style="grid-column:1/-1;">
      <h4>Ukupno</h4>
      <div class="statsRows">
        <div class="statRow"><span class="k">Ukupno fajlova</span><span class="v" id="uplTotalFiles">0</span></div>
        <div class="statRow"><span class="k">Ukupno MB</span><span class="v" id="uplTotalMB">0.00</span></div>
      </div>
   </div>
  </div>
    
  </main>

</div>

<!-- ‚úÖ CONFIRM MODAL (custom, mobile-friendly) -->
<div class="cModal" id="cModal" style="display:none;">
  <div class="cModalOverlay" id="cModalOverlay"></div>

  <div class="cModalCard" role="dialog" aria-modal="true"
       aria-labelledby="cTitle" aria-describedby="cText">
    <div class="cModalHead">
      <div class="cModalTitle" id="cTitle">Potvrda</div>
      <button class="cModalX" id="cModalX" type="button" aria-label="Zatvori">‚úï</button>
    </div>

    <div class="cModalBody">
      <div class="cModalText" id="cText">Da li ste sigurni?</div>
    </div>

    <div class="cModalActions">
      <button class="btn btnGhost" id="cCancel" type="button">Otka≈æi</button>
      <button class="btn btnPrimary cDanger" id="cOk" type="button">Obri≈°i</button>
    </div>
  </div>
</div>
  
<script>
  
/* =========================================================
   PRINCIP RADA (front-only priprema)
   - svaka zgrada je "tenant" (nezavisna stambena zajednica)
   - stanari dobijaju kartice: username + lozinka (po stanu)
   - upravnik moze voditi vi≈°e zgrada -> posle logina bira zgradu
   - sve se cuva u localStorage po zgradi (kasnije Supabase)
   ========================================================= */

/* ====== Buildings (stambene zajednice) ====== */
const BUILDINGS = [
  {
    id: "b_bm25",
    title: "Bore Markoviƒáa 25",
    street: "Bore Markoviƒáa",
    number: "25",
    units: 25
  },
  {
    id: "b_bp10",
    title: "Bulevar Primer 10",
    street: "Bulevar Primer",
    number: "10",
    units: 48
  },
  {
    id: "b_nƒç28",
    title: "Nedeljka ƒåabrinoviƒáa 28",
    street: "Nedeljka ƒåabrinoviƒáa",
    number: "28",
    units: 36
  }
];

/* ================= BUILDINGS DB (admin dodaje zgrade) ================= */
const KEY_BUILDINGS_DB = "pu_buildings_db_v1";

function loadBuildingsDB(){
  try {
    return JSON.parse(localStorage.getItem(KEY_BUILDINGS_DB)) || [];
  } catch {
    return [];
  }
}

function saveBuildingsDB(rows){
  localStorage.setItem(KEY_BUILDINGS_DB, JSON.stringify(rows));
}

function slugCode(code){
  return String(code || "")
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "_")
    .replace(/^_+|_+$/g, "");
}

/* ubaci zgrade iz DB u runtime BUILDINGS (da rade svuda) */
function mergeBuildingsFromDB(){
  const rows = loadBuildingsDB();
  rows.forEach(b => {
    if(!b?.id) return;
    if(!BUILDINGS.some(x => x.id === b.id)){
      BUILDINGS.push(b);
    }
  });
}

/* pozovi odmah pri startu aplikacije */
mergeBuildingsFromDB();

/* Admin helper: dodaj novu zgradu (UI u sledeƒáem koraku) */
function adminAddBuilding({ code, title, street, number, units }){
  const c = String(code || "").trim().toUpperCase();
  const t = String(title || "").trim();
  const s = String(street || "").trim();
  const n = String(number || "").trim();
  const u = Number(units || 0);

  if(!c || !t || !s || !n || !u){
    throw new Error("Popuni sva polja za zgradu.");
  }

  const id = `b_${slugCode(c)}`; // npr. b_bm25

  // ne dozvoli duplikate
  if(BUILDINGS.some(x => x.id === id)){
    throw new Error("Zgrada sa tom ≈°ifrom veƒá postoji.");
  }

  const newB = { id, code: c, title: t, street: s, number: n, units: u };

  // upi≈°i u DB
  const db = loadBuildingsDB();
  db.push(newB);
  saveBuildingsDB(db);

  // odmah ubaci i u runtime
  BUILDINGS.push(newB);

  return newB;
}


function normalizeBuildingId(id){
  return String(id || "")
    .normalize("NFKD")
    .replace(/[\u0300-\u036f]/g, "")  // skida dijakritike
    .replace(/ƒç/g, "c").replace(/ƒá/g, "c")
    .replace(/≈°/g, "s").replace(/ƒë/g, "dj").replace(/≈æ/g, "z")
    .toLowerCase()
    .trim();
}

function getBuildingById(id){
  const direct = BUILDINGS.find(b => b.id === id);
  if(direct) return direct;

  const nid = normalizeBuildingId(id);
  return BUILDINGS.find(b => normalizeBuildingId(b.id) === nid) || null;
}


/* ====== Users (demo) ====== */
const USERS = [
  { username: "ADMIN-001", pass: "123456", role: "admin", buildings: ["b_bm25","b_bp10","b_nƒç28"] },
  { username: "UPR-001",   pass: "123456", role: "upravnik", buildings: ["b_bp10","b_nƒç28"] },
  { username: "UPR-002",   pass: "123456", role: "upravnik", buildings: ["b_bm25"] },

  { username: "BM25-001", pass: "2B3H1", role: "stanar", buildings: ["b_bm25"] },
  { username: "BM25-002", pass: "8K1Q9", role: "stanar", buildings: ["b_bm25"] },
  { username: "BM25-003", pass: "4Z7M2", role: "stanar", buildings: ["b_bm25"] },

  { username: "BP10-001", pass: "7A2D5", role: "stanar", buildings: ["b_bp10"] },
  { username: "BP10-002", pass: "9P3R1", role: "stanar", buildings: ["b_bp10"] },

  { username: "NC28-001", pass: "A7K3P", role: "stanar", buildings: ["b_nƒç28"] },
  { username: "NC28-002", pass: "Q9M2L", role: "stanar", buildings: ["b_nƒç28"] },
  { username: "NC28-003", pass: "Z4R8W", role: "stanar", buildings: ["b_nƒç28"] }
];


/* ===== session keys ===== */
const KEY_PERSIST = "pu_session_persist_v8";
const KEY_SESSION = "pu_session_session_v8";

/* ===== storage keys (po zgradi) ===== */
function kFin(bid){ return "pu_finance_items_v3__" + bid; }
function kFirm(bid){ return "pu_finance_firms_v3__" + bid; }
function kForum(bid){ return "pu_forum_proposals_v2__" + bid; }
function kBoard(bid){ return "pu_board_posts_v2__" + bid; }

function normalizeText(str){
  return (str || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}
  
/* ‚úÖ IZMENJENO: umesto jednog balansa, cuvamo POCETNO STANJE po zgradi */
function kOpeningBalance(bid){ return "pu_opening_balance_v1__" + bid; }

  /* =========================
   DUG/PRETPLATA (po zgradi, po stanaru)
========================= */
function kDues(bid){ return "pu_dues_v1__" + bid; }

function loadDues(bid){
  const raw = localStorage.getItem(kDues(bid));
  if(!raw){
    const now = new Date();
    const startMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
    const seed = { monthlyFee: 2000, startMonth, paymentsByUser: {} };
    localStorage.setItem(kDues(bid), JSON.stringify(seed));
    return seed;
  }
  try{
    const obj = JSON.parse(raw) || {};
    obj.monthlyFee = Number(obj.monthlyFee ?? 2000);
    obj.startMonth = String(obj.startMonth || "2025-01");
    obj.paymentsByUser = obj.paymentsByUser || {};
    return obj;
  }catch{
    return { monthlyFee: 2000, startMonth: "2025-01", paymentsByUser: {} };
  }
}

function saveDues(bid, obj){
  localStorage.setItem(kDues(bid), JSON.stringify(obj));
}

function ymNow(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
}
function ymToIndex(ym){
  const [y,m] = String(ym||"").split("-").map(Number);
  if(!Number.isFinite(y) || !Number.isFinite(m)) return 0;
  return y*12 + (m-1);
}
function monthsBetweenInclusive(startYM, endYM){
  return Math.max(0, ymToIndex(endYM) - ymToIndex(startYM) + 1);
}
function sumPayments(payments){
  return (payments||[]).reduce((s,p)=> s + Number(p.amount||0), 0);
}

function listResidentsForBuilding(bid){
  return USERS
    .filter(u => u.role === "stanar" && (u.buildings||[]).includes(bid))
    .map(u => u.username);
}

function computeUserDue(bid, username){
  const dues = loadDues(bid);
  const fee = Number(dues.monthlyFee||0);
  const start = String(dues.startMonth||ymNow());
  const months = monthsBetweenInclusive(start, ymNow());
  const expected = fee * months;

  const payments = dues.paymentsByUser?.[username] || [];
  const paid = sumPayments(payments);

  const saldo = paid - expected; // + pretplata, - dug
  return { fee, start, months, expected, paid, saldo, payments };
}

function addDuesPayment(bid, username, pay){
  const dues = loadDues(bid);
  dues.paymentsByUser = dues.paymentsByUser || {};
  dues.paymentsByUser[username] = dues.paymentsByUser[username] || [];
  dues.paymentsByUser[username].push(pay);
  saveDues(bid, dues);
}
function renderDuesTenant(bid){
  // samo stanar
  if(CURRENT_SESSION?.role !== "stanar") return;

  // dozvoli da se pozove i bez parametra
  const buildingId = bid || activeBid();
  if(!buildingId) return;

  // DOM postoji?
  if(!tPaid || !tExpected || !tSaldoBadge || !tPeriod) return;

  const r = computeUserDue(buildingId, CURRENT_SESSION.username);

  tPaid.textContent = formatRSD(r.paid);
  tExpected.textContent = formatRSD(r.expected);

  // uvek prikazujemo Potra≈æivanje SZ
tSaldoBadge.classList.remove(
  "status-dug",
  "status-obaveza",
  "status-uplaceno"
);

if (r.saldo < 0) {
  // dug ‚Üí crveno
  tSaldoBadge.textContent =
    `Potra≈æivanje SZ: ${formatRSD(-r.saldo)} RSD`;
  tSaldoBadge.classList.add("status-dug");

} else if (r.saldo === 0) {
  // nula ‚Üí ≈æuto
  tSaldoBadge.textContent =
    `Potra≈æivanje SZ: 0,00 RSD`;
  tSaldoBadge.classList.add("status-obaveza");

} else {
  // pretplata ‚Üí zeleno + znak
  tSaldoBadge.textContent =
    `Potra≈æivanje SZ: +${formatRSD(r.saldo)} RSD`;
  tSaldoBadge.classList.add("status-uplaceno");
}


tPeriod.textContent = `Obraƒçun od ${formatDateDMY(r.start)} ‚Ä¢ ${r.months} meseci`;
}

/* ‚úÖ OVDE LEPI≈† */
function renderTenantFinanceHeaderBadge(bid){
  if(CURRENT_SESSION?.role !== "stanar") return;

  const buildingId = bid || activeBid();
  if(!buildingId) return;

  const badge = document.getElementById("finTenantBadge");
  const textEl = document.getElementById("finTenantBadgeText");
  if(!badge || !textEl) return;

  const r = computeUserDue(buildingId, CURRENT_SESSION.username);

  badge.classList.remove(
  "status-dug",
  "status-obaveza",
  "status-uplaceno"
);

if (r.saldo < 0) {
  textEl.textContent =
    `Potra≈æivanje SZ: ${formatRSD(-r.saldo)} RSD`;
  badge.classList.add("status-dug");

} else if (r.saldo === 0) {
  textEl.textContent =
    `Potra≈æivanje SZ: 0,00 RSD`;
  badge.classList.add("status-obaveza");

} else {
  textEl.textContent =
    `Potra≈æivanje SZ: +${formatRSD(r.saldo)} RSD`;
  badge.classList.add("status-uplaceno");
}

badge.style.display = "";
}
  
/* ===== DOM refs ===== */
const usernameEl = document.getElementById("username");
const passEl = document.getElementById("pass");
const loginBtn = document.getElementById("loginBtn");
const errEl = document.getElementById("loginError");
const togglePass = document.getElementById("togglePass");
const remember = document.getElementById("remember");
const bsLogoutBtn = document.getElementById("bsLogoutBtn");
  const openingBalanceInputAdmin = document.getElementById("openingBalanceInputAdmin");
const saveOpeningBalanceBtnAdmin = document.getElementById("saveOpeningBalanceBtnAdmin");
const editOpeningBalanceBtnAdmin = document.getElementById("editOpeningBalanceBtnAdmin");
  
  /* =========================
   REMEMBER USER+PASS (login autofill)
========================= */
const KEY_LOGIN_REMEMBER = "pu_login_remember_v1";
const KEY_LOGIN_CREDS    = "pu_login_creds_v1"; // { username, pass }

function saveLoginCredsIfNeeded(){
  if(!usernameEl || !passEl || !remember) return;

  const u = (usernameEl.value || "").trim();
  const p = (passEl.value || "").trim();

  if(remember.checked){
    localStorage.setItem(KEY_LOGIN_REMEMBER, "1");
    localStorage.setItem(KEY_LOGIN_CREDS, JSON.stringify({ username: u, pass: p }));
  }else{
    localStorage.removeItem(KEY_LOGIN_REMEMBER);
    localStorage.removeItem(KEY_LOGIN_CREDS);
  }
}

function loadLoginCreds(){
  if(!usernameEl || !passEl || !remember) return;

  const on = localStorage.getItem(KEY_LOGIN_REMEMBER) === "1";
  remember.checked = on;

  if(!on) return;

  try{
    const creds = JSON.parse(localStorage.getItem(KEY_LOGIN_CREDS) || "{}");
    if(creds.username) usernameEl.value = creds.username;
    if(creds.pass) passEl.value = creds.pass;
  }catch(e){
    // ako je nesto puklo u storage-u, ocisti
    localStorage.removeItem(KEY_LOGIN_CREDS);
  }
}


// ‚úÖ FIN TABOVI (upravnik)
const finTabEntries = document.getElementById("finTabEntries");
const finTabDues    = document.getElementById("finTabDues");
const finEntriesWrap= document.getElementById("finEntriesWrap");
const finDuesWrap   = document.getElementById("finDuesWrap");
function showFinTab(tab){
  if(!finEntriesWrap || !finDuesWrap || !finTabEntries || !finTabDues) return;

  if(tab === "entries"){
    finEntriesWrap.style.display = "";
    finDuesWrap.style.display = "none";
    finTabEntries.className = "btn btnPrimary";
    finTabDues.className = "btn btnGhost";
  }else{
    finEntriesWrap.style.display = "none";
    finDuesWrap.style.display = "";
    finTabEntries.className = "btn btnGhost";
    finTabDues.className = "btn btnPrimary";
  }
}
  
if(finTabEntries && finTabDues){
  finTabEntries.addEventListener("click", () => showFinTab("entries"));
  finTabDues.addEventListener("click", () => showFinTab("dues"));
}

  
const buildingPickList = document.getElementById("buildingPickList");

const userPill = document.getElementById("userPill");
const buildingPill = document.getElementById("buildingPill");
const switchBuildingBtn = document.getElementById("switchBuildingBtn");

const buildingMeta = document.getElementById("buildingMeta");
const balanceValue = document.getElementById("balanceValue");

const globalSearch = document.getElementById("globalSearch");
const searchResults = document.getElementById("searchResults");

/* ‚úÖ DODATO: inputs za pocetno stanje */
const openingBalanceInput = document.getElementById("openingBalanceInput");
const saveOpeningBalanceBtn = document.getElementById("saveOpeningBalanceBtn");
const editOpeningBalanceBtn = document.getElementById("editOpeningBalanceBtn");
  const openingBalanceLock = document.getElementById("openingBalanceLock");

  function setOpeningBalanceEditing(on){
  const input = openingBalanceInput;
  const btnEdit = editOpeningBalanceBtn;
  const btnSave = saveOpeningBalanceBtn;
  const lock = openingBalanceLock;

  if(!input || !btnEdit || !btnSave) return;

  input.readOnly = !on;
  input.style.opacity = on ? "1" : ".65";

  btnEdit.style.display = on ? "none" : "";
  btnSave.style.display = on ? "" : "none";

  if(lock){
    lock.classList.toggle("locked", !on);
    lock.classList.toggle("unlocked", on);
    lock.title = on
      ? "Otkljuƒçano ‚Äì mo≈æete menjati iznos"
      : "Zakljuƒçano ‚Äì kliknite Izmeni";
  }

  if(on){
    input.focus();
    input.select();
  }
}
  /* dues DOM */
const monthlyFeeInput = document.getElementById("monthlyFeeInput");
const duesStartMonth = document.getElementById("duesStartMonth");
const saveDuesSettingsBtn = document.getElementById("saveDuesSettingsBtn");
const duesGrid = document.getElementById("duesGrid");
const duesPayWrap = document.getElementById("duesPayWrap");
const duesPayTitle = document.getElementById("duesPayTitle");
const duesPayDate = document.getElementById("duesPayDate");
const duesPayAmount = document.getElementById("duesPayAmount");
const duesPayNote = document.getElementById("duesPayNote");
const duesPayDocs = document.getElementById("duesPayDocs");
const duesPaySaveBtn = document.getElementById("duesPaySaveBtn");
const duesPayCancelBtn = document.getElementById("duesPayCancelBtn");
const duesPayError = document.getElementById("duesPayError");

  // ‚úÖ dues adjust (Izmena) DOM
const duesAdjWrap   = document.getElementById("duesAdjWrap");
const duesAdjTitle  = document.getElementById("duesAdjTitle");
const duesAdjDate   = document.getElementById("duesAdjDate");
const duesAdjKind   = document.getElementById("duesAdjKind");
const duesAdjAmount = document.getElementById("duesAdjAmount");
const duesAdjNote   = document.getElementById("duesAdjNote");
const duesAdjSaveBtn= document.getElementById("duesAdjSaveBtn");
const duesAdjCancelBtn = document.getElementById("duesAdjCancelBtn");
const duesAdjError  = document.getElementById("duesAdjError");

function canAdjustDues(){
  const r = (CURRENT_SESSION?.role || "").toLowerCase();
  return r === "upravnik" || r === "admin" || r === "administrator";
}

function openDuesAdjust(username){
  if(!canAdjustDues()) return alert("Nemate dozvolu.");

  DUES_ACTIVE_USER = username; // koristimo isti ‚Äúactive user‚Äù

  if(!duesAdjWrap || !duesAdjTitle || !duesAdjDate || !duesAdjKind || !duesAdjAmount) return;

  const d = new Date();
  duesAdjTitle.textContent = `Izmena: ${username}`;
  duesAdjDate.value = d.toISOString().slice(0,10);
  duesAdjKind.value = "plus";
  duesAdjAmount.value = "";
  if(duesAdjNote) duesAdjNote.value = "";
  if(duesAdjError){ duesAdjError.style.display="none"; duesAdjError.textContent=""; }

  // sakrij uplatu ako je otvorena, da ne zbunjuje
  if(duesPayWrap) duesPayWrap.style.display = "none";

  duesAdjWrap.style.display = "block";
  duesAdjWrap.scrollIntoView({behavior:"smooth", block:"start"});
}

function cancelDuesAdjust(){
  if(duesAdjWrap) duesAdjWrap.style.display = "none";
  DUES_ACTIVE_USER = null;
}

function saveDuesAdjust(){
  const bid = activeBid();
  if(!bid) return;
  if(!canAdjustDues()) return;

  if(!DUES_ACTIVE_USER) return;

  const date = (duesAdjDate?.value || "").trim();
  const kind = (duesAdjKind?.value || "plus");
  const amtRaw = Number((duesAdjAmount?.value || "").trim());
  const note = (duesAdjNote?.value || "").trim();

  if(!date || !Number.isFinite(amtRaw) || amtRaw <= 0){
    if(duesAdjError){
      duesAdjError.textContent = "Gre≈°ka: datum i iznos (veƒái od 0) su obavezni.";
      duesAdjError.style.display = "block";
    }
    return;
  }
  if(note.length < 3){
    if(duesAdjError){
      duesAdjError.textContent = "Gre≈°ka: razlog je obavezan (min 3 karaktera).";
      duesAdjError.style.display = "block";
    }
    return;
  }

  const delta = (kind === "minus") ? -Math.abs(amtRaw) : Math.abs(amtRaw);

  addDuesPayment(bid, DUES_ACTIVE_USER, {
    id: cryptoRandom(),
    createdAt: Date.now(),
    date,
    amount: delta,
    note: `IZMENA: ${note}`,
    docs: [] // za izmenu ne uploadujemo, ostavi prazno
  });

  if(duesAdjWrap) duesAdjWrap.style.display = "none";
  DUES_ACTIVE_USER = null;

  renderDuesAdmin();
}

if(duesAdjSaveBtn) duesAdjSaveBtn.addEventListener("click", saveDuesAdjust);
if(duesAdjCancelBtn) duesAdjCancelBtn.addEventListener("click", cancelDuesAdjust);


  // ‚úÖ dues toolbar (search/filter/sort)
const duesSearch = document.getElementById("duesSearch");
const duesFilter = document.getElementById("duesFilter");
const duesSort   = document.getElementById("duesSort");

  // stanar ‚Äì moj dug / pretplata
const tenantDuesBox = document.getElementById("tenantDuesBox");
const tPaid = document.getElementById("tPaid");
const tExpected = document.getElementById("tExpected");
const tSaldoBadge = document.getElementById("tSaldoBadge");
const tPeriod = document.getElementById("tPeriod");

/* finance elements */
const financeList = document.getElementById("financeList");
const addFinanceBtn = document.getElementById("addFinanceBtn");
const financeFormWrap = document.getElementById("financeFormWrap");
const saveFinanceBtn = document.getElementById("saveFinanceBtn");
const cancelFinanceBtn = document.getElementById("cancelFinanceBtn");
const financeError = document.getElementById("financeError");

/* ‚úÖ MESEƒåNI UPLOAD (finansije + oglasna) */
const uplMonthPick = document.getElementById("uplMonthPick");
const uplFinEntries = document.getElementById("uplFinEntries");
const uplFinFiles = document.getElementById("uplFinFiles");
const uplFinMB = document.getElementById("uplFinMB");

const uplBrdEntries = document.getElementById("uplBrdEntries");
const uplBrdFiles = document.getElementById("uplBrdFiles");
const uplBrdMB = document.getElementById("uplBrdMB");

const uplTotalFiles = document.getElementById("uplTotalFiles");
const uplTotalMB = document.getElementById("uplTotalMB");

/* ‚úÖ MESEƒåNI UPLOAD (admin) */
const uplMonthPickAdmin = document.getElementById("uplMonthPickAdmin");
const uplFinEntriesA = document.getElementById("uplFinEntriesA");
const uplFinFilesA = document.getElementById("uplFinFilesA");
const uplFinMBA = document.getElementById("uplFinMBA");

const uplBrdEntriesA = document.getElementById("uplBrdEntriesA");
const uplBrdFilesA = document.getElementById("uplBrdFilesA");
const uplBrdMBA = document.getElementById("uplBrdMBA");

const uplTotalFilesA = document.getElementById("uplTotalFilesA");
const uplTotalMBA = document.getElementById("uplTotalMBA");

  
const fDate = document.getElementById("fDate");
const fType = document.getElementById("fType");
const fCategory = document.getElementById("fCategory");
const fFirm = document.getElementById("fFirm");
const fFirmNew = document.getElementById("fFirmNew");
const fDesc = document.getElementById("fDesc");
const fAmount = document.getElementById("fAmount");
const fDocs = document.getElementById("fDocs");

  /* finance header controls */
const finLocalSearch = document.getElementById("finLocalSearch");
const finFilterType = document.getElementById("finFilterType");
const finFilterCategory = document.getElementById("finFilterCategory");
const finSortBy = document.getElementById("finSortBy");
  
  const existingDocsWrap = document.getElementById("existingDocsWrap");
const existingDocsList = document.getElementById("existingDocsList");


/* forum elements */
const forumList = document.getElementById("forumList");
const pTitle = document.getElementById("pTitle");
const pBody = document.getElementById("pBody");
const createProposalBtn = document.getElementById("createProposalBtn");
const clearProposalBtn = document.getElementById("clearProposalBtn");
const forumError = document.getElementById("forumError");

/* oglasna elements */
const boardList = document.getElementById("boardList");
const addBoardBtn = document.getElementById("addBoardBtn");
const boardFormWrap = document.getElementById("boardFormWrap");
const saveBoardBtn = document.getElementById("saveBoardBtn");
const cancelBoardBtn = document.getElementById("cancelBoardBtn");
const boardError = document.getElementById("boardError");

const bTitle = document.getElementById("bTitle");
const bDate = document.getElementById("bDate");
const bDesc = document.getElementById("bDesc");
const bDocs = document.getElementById("bDocs");

/* static lists */
const regList = document.getElementById("regList");
const kontaktList = document.getElementById("kontaktList");

/* home */
const homeLastChange = document.getElementById("homeLastChange");
const homePinned = document.getElementById("homePinned");
const homeForum = document.getElementById("homeForum");

let CURRENT_SESSION = null;
let CURRENT_QUERY = "";

  let EDIT_FIN_ID = null;          
let EDIT_FIN_CREATED_AT = null;  
let EDIT_DOCS = [];              

  // ===== FINANSIJE: filter/sort state =====
let FIN_FILTER_TYPE = "svi";        // "svi" | "prihod" | "rashod"
let FIN_FILTER_CATEGORY = "";       // npr. "lift"
let FIN_SORT_BY = "date-desc";      // "date-desc" | "date-asc" | "amount-desc" | "amount-asc"


/* ---------- helpers ---------- */
function setMode(mode){
  document.body.classList.toggle("mode-login", mode === "login");
  document.body.classList.toggle("mode-buildingSelect", mode === "buildingSelect");
  document.body.classList.toggle("mode-portal", mode === "portal");
}
function clearSessions(){
  localStorage.removeItem(KEY_PERSIST);
  sessionStorage.removeItem(KEY_SESSION);
}
function saveSession(sessionObj){
  const payload = JSON.stringify(sessionObj);
  if(remember && remember.checked){
    localStorage.setItem(KEY_PERSIST, payload);
    sessionStorage.removeItem(KEY_SESSION);
  }else{
    sessionStorage.setItem(KEY_SESSION, payload);
    localStorage.removeItem(KEY_PERSIST);
  }
}
function getSession(){
  const raw = localStorage.getItem(KEY_PERSIST) || sessionStorage.getItem(KEY_SESSION);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}
function norm(s){ return String(s||"").toLowerCase().trim(); }
function includesQuery(text, q){
  if(!q) return true;
  return normalizeText(text).includes(normalizeText(q));
}
  function canManage(){
  const r = (CURRENT_SESSION?.role || "").toLowerCase();
  return r === "upravnik" || r === "admin" || r === "administrator";
}

function cryptoRandom(){
  return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

  /* =========================
   CUSTOM CONFIRM MODAL
========================= */
const cModal = document.getElementById("cModal");
const cModalOverlay = document.getElementById("cModalOverlay");
const cModalX = document.getElementById("cModalX");
const cTitle = document.getElementById("cTitle");
const cText = document.getElementById("cText");
const cCancel = document.getElementById("cCancel");
const cOk = document.getElementById("cOk");

let _confirmResolve = null;

function showConfirm({ title = "Potvrda", text = "Da li ste sigurni?", okText = "Obri≈°i" } = {}){
  return new Promise((resolve) => {
    _confirmResolve = resolve;

    if(cTitle) cTitle.textContent = title;
    if(cText) cText.textContent = text;
    if(cOk) cOk.textContent = okText;

    if(cModal) cModal.style.display = "block";

    // fokus na "Otka≈æi" (sigurnije)
    setTimeout(() => { try{ cCancel?.focus(); }catch{} }, 0);
  });
}

function _closeConfirm(result){
  if(cModal) cModal.style.display = "none";
  const r = _confirmResolve;
  _confirmResolve = null;
  if(typeof r === "function") r(!!result);
}

// klikovi
cCancel?.addEventListener("click", () => _closeConfirm(false));
cOk?.addEventListener("click", () => _closeConfirm(true));
cModalOverlay?.addEventListener("click", () => _closeConfirm(false));
cModalX?.addEventListener("click", () => _closeConfirm(false));

// Esc
document.addEventListener("keydown", (e) => {
  if(!cModal || cModal.style.display === "none") return;
  if(e.key === "Escape") _closeConfirm(false);
});

/* password eye */
togglePass.addEventListener("click", () => {
  const isPass = passEl.type === "password";
  passEl.type = isPass ? "text" : "password";
  togglePass.textContent = isPass ? "üôà" : "üëÅ";
});

function applyRoleUI(role){
  const roleEls = document.querySelectorAll("[data-role]");

  roleEls.forEach(el => {
  const need = el.getAttribute("data-role");

  // ‚úÖ manage = upravnik ili admin
  if(need === "manage"){
    el.style.display = (role === "upravnik" || role === "admin") ? "" : "none";
    return;
  }

  // Admin vidi i admin i upravnik blokove
  if(role === "admin"){
    el.style.display = (need === "admin" || need === "upravnik") ? "" : "none";
    return;
  }

  // Ostali: samo svoje
  el.style.display = (need === role) ? "" : "none";
});
}
/* ===== building context UI ===== */
function setActiveBuilding(bid){
  if(!CURRENT_SESSION) return;
  CURRENT_SESSION.activeBuildingId = bid;
  saveSession(CURRENT_SESSION);
  renderBuildingUI();
  refreshAllModules();
}

function renderBuildingUI(){
  const bid = CURRENT_SESSION?.activeBuildingId;
  const b = getBuildingById(bid);

  // ‚ùå ne prikazuj naziv zgrade pored (pill)
  if(buildingPill){
    buildingPill.textContent = "";
    buildingPill.style.display = "none";
  }

  // (opciono) ako NEƒÜE≈† ni meta tekst (levo ‚ÄúStambena zajednica...‚Äù), ugasi ga:
  // if(buildingMeta){ buildingMeta.innerHTML = ""; }

  // ako HOƒÜE≈† da meta ostane, ali samo kad postoji zgrada:
  if(buildingMeta){
    buildingMeta.innerHTML = b ? `
      Stambena zajednica: ${b.title}<br>
      Broj jedinica: ${b.units}
    ` : "";
  }

  // balans (ako ti je ovo potrebno)
  const bal = computeBalanceFromFinance(bid);
  balanceValue.textContent = formatRSD(bal);

  // popuni input za poƒçetno stanje (ako postoji)
  if(bid){
    const opening = getOpeningBalance(bid);
    if(openingBalanceInput) openingBalanceInput.value = String(opening);
    if(openingBalanceInputAdmin) openingBalanceInputAdmin.value = String(opening);
    setOpeningBalanceEditing(false);
  }

  // ‚úÖ dugme "Promeni zgradu" ostaje
  const isManager = (CURRENT_SESSION?.role === "upravnik" || CURRENT_SESSION?.role === "admin");
if(switchBuildingBtn) switchBuildingBtn.style.display = isManager ? "" : "none";
}

/* ===== login flow ===== */
function attemptLogin(username, pass){
  const u = USERS.find(x => x.username === username && x.pass === pass);
  if(!u){
    errEl.style.display = "block";
    return;
  }
  errEl.style.display = "none";

  CURRENT_SESSION = {
  username: u.username,
  role: u.role,
  buildings: (u.buildings || []).slice(),
  activeBuildingId: null
};

// üîí sakrij upravnik blokove stanarima
document.querySelectorAll('[data-role="upravnik"]').forEach(el => {
  if (CURRENT_SESSION?.role !== "upravnik") el.style.display = "none";
});

// stanar ide odmah u svoju zgradu
if(CURRENT_SESSION.role === "stanar"){
  CURRENT_SESSION.activeBuildingId = CURRENT_SESSION.buildings[0] || null;
  saveSession(CURRENT_SESSION);
  enterPortal();
  return;
}

  // upravnik/admin: ako vi≈°e zgrada -> izbor, ako jedna -> direktno
  if((CURRENT_SESSION.buildings || []).length > 1){
    saveSession(CURRENT_SESSION);
    showBuildingSelect();
  }else{
    CURRENT_SESSION.activeBuildingId = CURRENT_SESSION.buildings[0] || null;
    saveSession(CURRENT_SESSION);
    enterPortal();
  }
}

loginBtn.addEventListener("click", () => {
  saveLoginCredsIfNeeded();
  attemptLogin((usernameEl.value||"").trim(), (passEl.value||"").trim());
});

document.addEventListener("keydown", (e) => {
  if(document.body.classList.contains("mode-login") && e.key === "Enter"){
    saveLoginCredsIfNeeded();
    attemptLogin((usernameEl.value||"").trim(), (passEl.value||"").trim());
  }
});


/* ===== building select screen ===== */
function showBuildingSelect(){
  setMode("buildingSelect");

  const list = (CURRENT_SESSION?.buildings || []).map(id => {
  const b = getBuildingById(id);
  return b ? b : { id, title: "Nepoznata zgrada", street: "ID", number: String(id), units: "-" };
});


  buildingPickList.innerHTML = "";
  list.forEach(b => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "pickBtn";
    btn.innerHTML = `
      <div class="t">${b.title}</div>
      <div class="s">${b.street} ${b.number} ‚Ä¢ ${b.units} jedinica</div>
    `;
    btn.addEventListener("click", () => {
      setActiveBuilding(b.id);
      enterPortal();
    });
    buildingPickList.appendChild(btn);
  });
}

bsLogoutBtn.addEventListener("click", () => {
  clearSessions();
  CURRENT_SESSION = null;
  setMode("login");
});

/* ==== enter portal ==== */
function enterPortal(){
  if(userPill){
    userPill.textContent = "";
    userPill.style.display = "none";
  }

  applyRoleUI(CURRENT_SESSION?.role || "stanar");
  setMode("portal");
  
  renderUserBadge();
  
  // Uvek po ulasku u portal postavi Home kao aktivnu stranu (da bi header bio vidljiv)
showPage("home");


  // set active building if missing
  if(!CURRENT_SESSION.activeBuildingId){
    CURRENT_SESSION.activeBuildingId = CURRENT_SESSION.buildings[0] || null;
    saveSession(CURRENT_SESSION);
  }

  renderBuildingUI();
  refreshAllModules();
  ensureStaticSids();
  updateHomeSummary();
  bindHomeShortcuts();
}

/* logout (portal) */
const logoutBtn = document.getElementById("logoutBtn");
if (logoutBtn) {
  logoutBtn.addEventListener("click", () => {
    clearSessions();
    CURRENT_SESSION = null;
    closeS();
    setMode("login");
  });
}

/* switch building (portal) */
switchBuildingBtn.addEventListener("click", () => {
  if(!CURRENT_SESSION) return;
  showBuildingSelect();
});

/* ===== SIDEBAR behavior ===== */
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("overlay");
const edge = document.getElementById("edgeHotspot");
const burger = document.getElementById("hamburger");

function openS(){
  sidebar.classList.add("open");
  overlay.classList.add("show");
  document.body.classList.add("sidebar-open");
}
function closeS(){
  sidebar.classList.remove("open");
  overlay.classList.remove("show");
  document.body.classList.remove("sidebar-open");
}

edge.addEventListener("mouseenter", openS);

/* MOBILE / TOUCH FIX */
edge.addEventListener("touchstart", openS, { passive: true });
overlay.addEventListener("touchstart", closeS, { passive: true });

burger.addEventListener("click", () => {
  sidebar.classList.contains("open") ? closeS() : openS();
});
overlay.addEventListener("click", closeS);
document.addEventListener("keydown", (e) => {
  if(e.key === "Escape") closeS();
});


/* ===== SPA NAV ===== */
const nav = document.getElementById("nav");
const pages = {
  home: document.getElementById("page-home"),
  finansije: document.getElementById("page-finansije"),
  oglasna: document.getElementById("page-oglasna"),
  forum: document.getElementById("page-forum"),
  regulative: document.getElementById("page-regulative"),
  kontakt: document.getElementById("page-kontakt"),
  statistika: document.getElementById("page-statistika")
};
function showPage(name){
  // page flags (radi za sve stranice)
document.body.classList.remove(
  "page-home",
  "page-finansije",
  "page-oglasna",
  "page-forum",
  "page-regulative",
  "page-statistika"
);

// dodaj klasu za trenutnu stranu
if(name) document.body.classList.add(`page-${name}`);

  Object.values(pages).forEach(p => p.classList.remove("active"));
  (pages[name] || pages.home).classList.add("active");

  // ‚úÖ FINANSIJE: default tab za upravnika
if(name === "finansije" && CURRENT_SESSION?.role === "upravnik"){
  showFinTab("entries");
}

  [...nav.querySelectorAll("a[data-page]")].forEach(a => {
    a.classList.toggle("active", a.dataset.page === name);
  });

  if(name === "finansije"){
  renderTenantFinanceHeaderBadge(activeBid());
}

if(name === "statistika"){
  initAdminFinanceUploads(); // ‚úÖ admin blok sada ≈æivi u statistici
}
  
  closeS();
  window.scrollTo({ top: 0, behavior: "smooth" });
}

nav.addEventListener("click", (e) => {
  const a = e.target.closest("a[data-page]");
  if(!a) return;
  e.preventDefault();
  showPage(a.dataset.page);
});

/* =========================================================
   STORAGE PER BUILDING
   ========================================================= */
function activeBid(){
  return CURRENT_SESSION?.activeBuildingId || null;
}

function currentUser(){
  return CURRENT_SESSION?.username || "anon";
}

function kRead(bid, kind){
  const user = currentUser();
  return `pu_read_v2__${bid}__${kind}__${user}`; // po zgradi + po korisniku
}

function getReadMap(bid, kind){
  try{
    return JSON.parse(localStorage.getItem(kRead(bid, kind)) || "{}");
  }catch{
    return {};
  }
}

function isRead(bid, kind, id){
  const map = getReadMap(bid, kind);
  return !!map[id];
}

function markRead(bid, kind, id){
  const map = getReadMap(bid, kind);
  map[id] = true;
  localStorage.setItem(kRead(bid, kind), JSON.stringify(map));
}

function kindFromSid(sid){
  if(!sid) return null;
  const p = String(sid).split(":")[0];
  if(p === "fin") return "fin";
  if(p === "brd") return "brd";
  if(p === "frm") return "frm";
  return null;
}

function idFromSid(sid){
  if(!sid) return null;
  const parts = String(sid).split(":");
  return parts.length >= 2 ? parts.slice(1).join(":") : null;
}
  
/* ‚úÖ NOVO: Pocetno stanje (seed + edit) */
function getOpeningBalance(bid){
  const raw = localStorage.getItem(kOpeningBalance(bid));
  if(raw == null || raw === ""){
    // seed (kao sto si imao pre)
    const seed = (bid === "b_bm25") ? 948889 : 312450;
    localStorage.setItem(kOpeningBalance(bid), String(seed));
    return seed;
  }
  const n = Number(raw);
  return Number.isFinite(n) ? n : 0;
}
function setOpeningBalance(bid, val){
  localStorage.setItem(kOpeningBalance(bid), String(Number(val||0)));
}

/* finance */
function formatRSD(n){
  const x = Number(n||0);
  return x.toLocaleString("sr-RS", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function daysBetween(aMs, bMs){
  const day = 1000*60*60*24;
  return Math.floor(Math.abs(aMs - bMs) / day);
}
function canEdit(item){
  return daysBetween(Date.now(), item.createdAt) <= 30;
}
function loadItems(bid){
  const raw = localStorage.getItem("pu_finance_items_v3__" + bid);
  if(!raw){
    const seed = [
      { id: cryptoRandom(), createdAt: Date.now()-1000*60*60*24*2, date: "2026-01-02", type:"rashod", category:"tekuƒáe odr≈æavanje", firm:"Servis DOO", desc:"Uplata servisu", amount: 24000, docs: [] },
      { id: cryptoRandom(), createdAt: Date.now()-1000*60*60*24*6, date: "2025-12-28", type:"prihod", category:"ostalo", firm:"", desc:"Uplata stanara", amount: 120000, docs: [] },
      { id: cryptoRandom(), createdAt: Date.now()-1000*60*60*24*20, date: "2025-12-15", type:"rashod", category:"hitna intervencija", firm:"Vodoinstalater", desc:"Hitna intervencija", amount: 18000, docs: [] }
    ];
    localStorage.setItem("pu_finance_items_v3__" + bid, JSON.stringify(seed));
    return seed;
  }
  try { return JSON.parse(raw) || []; } catch { return []; }
}
function saveItems(bid, items){
  localStorage.setItem("pu_finance_items_v3__" + bid, JSON.stringify(items));
}

function loadFirms(bid){
  const raw = localStorage.getItem("pu_finance_firms_v3__" + bid);
  if(!raw){
    const seed = ["Servis DOO","Vodoinstalater","Lift Servis"];
    localStorage.setItem("pu_finance_firms_v3__" + bid, JSON.stringify(seed));
    return seed;
  }
  try { return JSON.parse(raw) || []; } catch { return []; }
}
function saveFirms(bid, firms){
  localStorage.setItem("pu_finance_firms_v3__" + bid, JSON.stringify(firms));
}
function renderFirmSelect(bid){
  const firms = loadFirms(bid);
  fFirm.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "(Izaberi firmu)";
  fFirm.appendChild(opt0);

  firms.forEach(name => {
    const o = document.createElement("option");
    o.value = name;
    o.textContent = name;
    fFirm.appendChild(o);
  });
}
function fileToDataURL(file){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result || ""));
    r.onerror = () => reject(new Error("File read error"));
    r.readAsDataURL(file);
  });
}
function totalFilesSizeBytes(fileList){
  let sum = 0;
  for(const f of fileList) sum += (f.size || 0);
  return sum;
}

/* ================= MESEƒåNI UPLOAD KALKULATOR ================= */
function bytesToMB(bytes){
  return (Number(bytes || 0) / (1024 * 1024));
}
  /* === NAPLATA UPLOADA: minimum 0.5MB po fajlu === */
const MIN_UPLOAD_MB = 0.5;

function billableMBFromBytes(bytes){
  const real = bytesToMB(bytes);
  return Math.max(MIN_UPLOAD_MB, real);
}
function monthFromDateStr(dateStr){
  // oƒçekuje "YYYY-MM-DD" ‚Üí vraƒáa "YYYY-MM"
  if(!dateStr || typeof dateStr !== "string") return "";
  return dateStr.slice(0,7);
}
function sumDocs(docs){
  let files = 0;
  let bytes = 0;
  let billMB = 0; // ‚úÖ naplativi MB

  (docs || []).forEach(d => {
    files += 1;

    // mi ƒçuvamo sizeKB u objektu
    const kb = Number(d.sizeKB || 0);
    const b = kb * 1024;
    bytes += b;

    // ‚úÖ svaka datoteka minimum 0.5MB
    billMB += billableMBFromBytes(b);
  });

  return { files, bytes, billMB };
}

function calcMonthlyUploads(bid, monthYYYYMM){
  
  // Finansije
  const finAll = loadItems(bid) || [];
  const finInMonth = finAll.filter(it => monthFromDateStr(it.date) === monthYYYYMM);

  let finEntries = finInMonth.length;
  let finFiles = 0;
  let finBytes = 0;
  let finBillMB = 0;

  finInMonth.forEach(it => {
    const s = sumDocs(it.docs || []);
    finFiles += s.files;
    finBytes += s.bytes;
    finBillMB += (s.billMB || 0);
  });

  // Oglasna
  const brdAll = loadBoardPosts(bid) || [];
  const brdInMonth = brdAll.filter(p => monthFromDateStr(p.date) === monthYYYYMM);

  let brdEntries = brdInMonth.length;
  let brdFiles = 0;
  let brdBytes = 0;
  let brdBillMB = 0;

  brdInMonth.forEach(p => {
    const s = sumDocs(p.docs || []);
    brdFiles += s.files;
    brdBytes += s.bytes;
    brdBillMB += (s.billMB || 0);
  });

  const totalFiles = finFiles + brdFiles;
  const totalMB = finBillMB + brdBillMB; // ‚úÖ naplativi MB

  return {
    finEntries, finFiles, finMB: finBillMB,
    brdEntries, brdFiles, brdMB: brdBillMB,
    totalFiles, totalMB
  };
}
  
// ‚úÖ kada klikne≈° "Primeni" u month pickeru ‚Üí osve≈æi novi admin prikaz (ako je admin)
if(uplMonthPick && !uplMonthPick.dataset.adminBound){
  uplMonthPick.addEventListener("change", () => {
    if(CURRENT_SESSION?.role === "admin"){
      initAdminFinanceUploads();
    }
  });
  uplMonthPick.dataset.adminBound = "1";
}

/* ===============================
   ADMIN (FINANSIJE) ‚Äî brza pretraga po zgradi
   =============================== */
function initAdminFinanceUploads(){
  if(CURRENT_SESSION?.role !== "admin") return;

  const input = document.getElementById("uplAdminSearchFin");
  const menu  = document.getElementById("adminBuildingMenuFin");
  const grid  = document.getElementById("uplAdminGridFin");
  const totF  = document.getElementById("uplAdminTotalFilesFin");
  const totMB = document.getElementById("uplAdminTotalMBFin");

  if(!input || !menu || !grid) return;

  function ymNowYYYYMM(){
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  }
  function getMonth(){
    const m = (uplMonthPick?.value || "").trim();
    return m || ymNowYYYYMM();
  }
  function renderTotals(files, mb){
    if(totF) totF.textContent = String(files || 0);
    if(totMB) totMB.textContent = Number(mb || 0).toFixed(2);
  }

  function closeMenu(){
    menu.classList.add("hidden");
    menu.innerHTML = "";
  }
  function openMenu(){
    menu.classList.remove("hidden");
  }

  // da klik unutar menija NE zatvori pre nego ≈°to obradi stavku
  menu.addEventListener("pointerdown", (e) => e.stopPropagation());

  // klik van zatvara
  if(!document.body.dataset.adminMenuBound){
    document.addEventListener("pointerdown", (e) => {
      const wrap = input.closest(".adminTopWrap");
      if(wrap && wrap.contains(e.target)) return;
      closeMenu();
    });
    document.body.dataset.adminMenuBound = "1";
  }

  function renderSelectedBuildingCard(b){
    closeMenu();
    
    const month = getMonth();
    const r = calcMonthlyUploads(b.id, month);

    const files = Number(r.totalFiles || 0);
    const mb    = Number(r.totalMB || 0);

    grid.innerHTML = "";

    const el = document.createElement("div");
    el.className = "adminCard";
    el.style.cursor = "pointer";

    el.innerHTML = `
      <div class="adminCardTitle">${escapeHTML(b.title)}</div>

      <div class="adminCardRow">
        <span>Finansije</span>
        <b>${Number(r.finMB||0).toFixed(2)} MB</b>
        <button type="button" class="adminNavBtn adminGoFin">Otvori</button>
      </div>

      <div class="adminCardRow">
        <span>Oglasna tabla</span>
        <b>${Number(r.brdMB||0).toFixed(2)} MB</b>
        <button type="button" class="adminNavBtn adminGoBrd">Otvori</button>
      </div>

      <div class="adminCardRow total" style="cursor:pointer;">
        <span>UKUPNO</span>
        <b>${mb.toFixed(2)} MB</b>
      </div>

      <div class="smallText" style="margin-top:10px; opacity:.75;">
        Mesec: ${escapeHTML(month)}
      </div>
    `;

    el.querySelector(".adminGoFin")?.addEventListener("click", (e) => {
      e.stopPropagation();
      setActiveBuilding(b.id);
      input.value = b.title;
      updateMonthlyUploadUI(false);
      showPage("finansije");
    });

    el.querySelector(".adminGoBrd")?.addEventListener("click", (e) => {
      e.stopPropagation();
      setActiveBuilding(b.id);
      input.value = b.title;
      updateMonthlyUploadUI(false);
      showPage("oglasna");
    });

    el.addEventListener("click", () => {
      setActiveBuilding(b.id);
      input.value = b.title;
      updateMonthlyUploadUI(false);
    });

    grid.appendChild(el);
    renderTotals(files, mb);
  }

  function renderMenuForQuery(q){
    const qq = (q || "").trim();
    menu.innerHTML = "";

    if(!qq){
      closeMenu();
      grid.innerHTML = ""; 
      renderTotals(0, 0);
      return;
    }

    const nq = normalizeText(qq);
    const matches = (BUILDINGS || [])
      .filter(b => normalizeText(b.title + " " + b.id).includes(nq))
      .slice(0, 8);

    if(!matches.length){
      openMenu();
      menu.innerHTML = `<div class="smallText" style="padding:10px 12px;"><span class="badge">Nema rezultata</span></div>`;
      renderTotals(0, 0);
      return;
    }

    openMenu();

    matches.forEach(b => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "adminMenuItem";
      btn.textContent = b.title;

      // pointerdown je sigurniji od click (pre ‚Äúoutside close‚Äù)
      btn.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        e.stopPropagation();

        closeMenu();
        input.value = b.title;

        setActiveBuilding(b.id);
        updateMonthlyUploadUI(false);
        renderSelectedBuildingCard(b);
      });

      menu.appendChild(btn);
    });
  }

  // bind samo jednom
  if(!input.dataset.bound){
    input.addEventListener("input", () => renderMenuForQuery(input.value));
    input.addEventListener("focus", () => renderMenuForQuery(input.value));
    input.dataset.bound = "1";
  }

  // init stanje
  grid.innerHTML = "";
  renderTotals(0, 0);
  closeMenu();
}

  
function setText(el, val){
  if(!el) return;
  el.textContent = String(val);
}

function updateMonthlyUploadUI(isAdmin){
  const bid = activeBid();
  if(!bid) return;

  const picker = uplMonthPick;
  if(!picker) return;

  if(!picker.value){
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    picker.value = `${yyyy}-${mm}`;
  }

  const m = picker.value; // "YYYY-MM"
  const r = calcMonthlyUploads(bid, m);

  setText(uplFinEntries, r.finEntries);
  setText(uplFinFiles, r.finFiles);
  setText(uplFinMB, r.finMB.toFixed(2));

  setText(uplBrdEntries, r.brdEntries);
  setText(uplBrdFiles, r.brdFiles);
  setText(uplBrdMB, r.brdMB.toFixed(2));

  setText(uplTotalFiles, r.totalFiles);
  setText(uplTotalMB, r.totalMB.toFixed(2));
}

/* listenersi */
if(uplMonthPick){
  uplMonthPick.addEventListener("change", () => updateMonthlyUploadUI(false));
}
if(uplMonthPickAdmin){
  uplMonthPickAdmin.addEventListener("change", () => updateMonthlyUploadUI(true));
}

  
/* ‚úÖ NOVO: racunanje stanja iz finansija */
function computeBalanceFromFinance(bid){
  const opening = getOpeningBalance(bid);
  const items = loadItems(bid);
  let delta = 0;
  for(const it of (items||[])){
    const amt = Number(it.amount||0);
    if(!Number.isFinite(amt)) continue;
    if(it.type === "prihod") delta += amt;
    else delta -= amt;
  }
  const next = Math.max(0, opening + delta);
  return next;
}
function refreshBalanceUI(bid){
  const next = computeBalanceFromFinance(bid);
  balanceValue.textContent = formatRSD(next);
}

/* ‚úÖ NOVO: snimi pocetno stanje (admin/upravnik) */
function saveOpeningBalanceFromUI(){
  const bid = activeBid();
  if(!bid) return;

  if(!CURRENT_SESSION || (CURRENT_SESSION.role !== "upravnik" && CURRENT_SESSION.role !== "admin")){
    alert("Nemate dozvolu.");
    return;
  }

  const src = (CURRENT_SESSION.role === "admin" ? openingBalanceInputAdmin : openingBalanceInput);
  if(!src) return;

  const n = Number((src.value||"").trim());
  if(!Number.isFinite(n)){
    alert("Unesite ispravan broj.");
    return;
  }

  setOpeningBalance(bid, n);
  refreshBalanceUI(bid);
  updateHomeSummary();
  
  setOpeningBalanceEditing(false);

}

if(saveOpeningBalanceBtn){
  saveOpeningBalanceBtn.addEventListener("click", saveOpeningBalanceFromUI);
}
if(saveOpeningBalanceBtnAdmin){
  saveOpeningBalanceBtnAdmin.addEventListener("click", saveOpeningBalanceFromUI);
}
if(editOpeningBalanceBtn){
  editOpeningBalanceBtn.addEventListener("click", () => {
    setOpeningBalanceEditing(true);
  });
}

if(editOpeningBalanceBtnAdmin){
  editOpeningBalanceBtnAdmin.addEventListener("click", () => {
    setOpeningBalanceEditing(true);
  });
}

  
function financeMatches(item, q){
  const docsNames = (item.docs||[]).map(d => d.name).join(" ");
  const hay = `${item.date} ${item.type} ${item.category} ${item.firm||""} ${item.desc||""} ${item.amount||""} ${docsNames}`;
  return includesQuery(hay, q);
}

  function escapeHTML(s){
  return String(s ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

  function renderFinanceList(bid, q){
  
  let items = loadItems(bid).slice();

// 1) pretraga
if(q){
  items = items.filter(it => financeMatches(it, q));
}

// 2) filter po tipu
if(FIN_FILTER_TYPE !== "svi"){
  items = items.filter(it => it.type === FIN_FILTER_TYPE);
}

// 3) filter po kategoriji
if(FIN_FILTER_CATEGORY){
  items = items.filter(it => it.category === FIN_FILTER_CATEGORY);
}

// 4) sortiranje
items.sort((a,b) => {
  if(FIN_SORT_BY === "date-desc") return (b.date||"").localeCompare(a.date||"");
  if(FIN_SORT_BY === "date-asc")  return (a.date||"").localeCompare(b.date||"");
  if(FIN_SORT_BY === "amount-desc") return Number(b.amount||0) - Number(a.amount||0);
  if(FIN_SORT_BY === "amount-asc")  return Number(a.amount||0) - Number(b.amount||0);
  return 0;
});


  financeList.innerHTML = "";

  items.forEach(item => {
  const li = document.createElement("li");
  li.dataset.sid = "fin:" + item.id;
li.classList.add("finCard"); 

  // ako stavka ima upload dokumente -> oboji plavo
  if(item.docs && item.docs.length){
    li.classList.add("hasDocs");
  }

  const firmPart = item.firm ? (" ‚Äî " + item.firm) : "";

  // ===== TOP RED (naslov + dugmad) =====
  const top = document.createElement("div");
  top.className = "finRowTop";

  const title = document.createElement("div");
  title.className = "finRowTitle";
  const dmy = formatDateDMY(item.date);
const typeLabel = (item.type === "rashod") ? "Rashod" : "Prihod";
const typeClass = (item.type === "rashod") ? "type-rashod" : "type-prihod";

title.innerHTML = `
  <div class="itemHead">
    <div class="itemLeft">
      <div class="itemMeta">
        <span class="pill">${escapeHTML(dmy)}</span>
        <span class="pill ${typeClass}">${escapeHTML(typeLabel)}</span>
        <span class="pill">${escapeHTML(item.category)}</span>
        ${item.firm ? `<span class="pill">${escapeHTML(item.firm)}</span>` : ``}

        ${
          (CURRENT_SESSION?.role === "upravnik" || CURRENT_SESSION?.role === "admin")
            ? `<span class="pill">${escapeHTML(getUnitLabel(activeBid(), item.user || item.unit || item.createdBy || ""))}</span>`
            : ``
        }
      </div>

      <div class="itemDesc">${escapeHTML(item.desc || "")}</div>
    </div>

    <div class="itemAmount ${item.type === "rashod" ? "rashod" : "prihod"}">
      ${escapeHTML(formatRSD(item.amount))} RSD
    </div>
  </div>
`;

  top.appendChild(title);

if(CURRENT_SESSION && canManage()){
  const actions = document.createElement("div");
  actions.className = "finRowActions";

  const edit = document.createElement("button");
  edit.className = "finActBtn";
  edit.type = "button";
  edit.textContent = "Izmeni";
    edit.disabled = !canEdit(item);
    edit.addEventListener("click", () => {
      if(!canEdit(item)) return alert("Izmena je moguƒáa samo u roku od 30 dana.");
      renderFirmSelect(bid);
      setFinanceEditMode(item);
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    const del = document.createElement("button");
    del.className = "finActBtn danger";
    del.type = "button";
    del.textContent = "Obri≈°i";
    del.disabled = !canEdit(item);
    
    del.addEventListener("click", async () => {
  const ok = await showConfirm({
    title: "Brisanje finansijske stavke",
    text: "Da li ste sigurni da ≈æelite da obri≈°ete ovu finansijsku stavku? Ova radnja je trajna.",
    okText: "Obri≈°i"
  });
  if(!ok) return;

  const next = loadItems(bid).filter(x => x.id !== item.id);
  saveItems(bid, next);
  renderFinanceList(bid, CURRENT_QUERY);
  renderSearchDropdown(CURRENT_QUERY);
  updateHomeSummary();
  refreshBalanceUI(bid);
});

    actions.appendChild(edit);
    actions.appendChild(del);
    top.appendChild(actions);
  }

  li.appendChild(top);
  // ===== /TOP RED =====

  // ===== PDF LISTA (ostaje ispod) =====
  if(item.docs && item.docs.length){
    const ul = document.createElement("ul");
    ul.className = "fileList";

    item.docs.forEach(d => {
      const fli = document.createElement("li");
      fli.style.cursor = "pointer";
      fli.title = "Klik za otvaranje";
      fli.innerHTML = `<span>${d.name}</span><small>${d.sizeKB} KB</small>`;

      fli.addEventListener("click", () => {
        if(!d.dataURL){
          alert("Fajl je sacuvan bez sadr≈æaja. Uploaduj ponovo.");
          return;
        }
        const w = window.open();
        if(!w){
          alert("Browser je blokirao pop-up. Dozvoli pop-up za ovaj sajt.");
          return;
        }
        w.document.write(`
          <title>${d.name}</title>
          <iframe src="${d.dataURL}" style="position:fixed; inset:0; width:100%; height:100%; border:0;"></iframe>
        `);
        w.document.close();
      });

      ul.appendChild(fli);
    });

    li.appendChild(ul);
  }
  // ===== /PDF LISTA =====

  financeList.appendChild(li);
});

}
/* ===== FINANCE HEADER CONTROLS LISTENERS ===== */

function applyFinanceControls(){
  const bid = activeBid();
  if(!bid) return;

  // lokalna pretraga ima prednost nad globalnom
  const localQ = (finLocalSearch?.value || "").trim();
  const q = localQ || CURRENT_QUERY;

  renderFinanceList(bid, q);
}

// tip
if(finFilterType){
  finFilterType.addEventListener("change", (e) => {
    FIN_FILTER_TYPE = e.target.value;
    applyFinanceControls();
  });
}

// kategorija
if(finFilterCategory){
  finFilterCategory.addEventListener("change", (e) => {
    FIN_FILTER_CATEGORY = e.target.value;
    applyFinanceControls();
  });
}

// sortiranje
if(finSortBy){
  finSortBy.addEventListener("change", (e) => {
    FIN_SORT_BY = e.target.value;
    applyFinanceControls();
  });
}

// lokalna pretraga
if(finLocalSearch){
  finLocalSearch.addEventListener("input", () => {
    applyFinanceControls();
  });
}

function resetFinanceForm(){
  financeError.style.display = "none";
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,"0");
  const dd = String(today.getDate()).padStart(2,"0");
  fDate.value = `${yyyy}-${mm}-${dd}`;
  fType.value = "rashod";
  fCategory.value = "tekuƒáe odr≈æavanje";
  fFirm.value = "";
  fFirmNew.value = "";
  fDesc.value = "";
  fAmount.value = "";
  if(fDocs) fDocs.value = "";
}

function financeInit(bid){
  if(!financeList) return;
  renderFirmSelect(bid);
  renderFinanceList(bid, CURRENT_QUERY);
  resetFinanceForm();
  clearFinanceEditMode(); // ‚úÖ bitno: svaki put kad inicijalizuje≈°, izlazi iz edit moda
  if(financeFormWrap) financeFormWrap.style.display = "none";
  refreshBalanceUI(bid);
}

/* ===== EDIT MODE HELPERS ===== */
function clearFinanceEditMode(){
  EDIT_FIN_ID = null;
  EDIT_FIN_CREATED_AT = null;
  EDIT_DOCS = [];

  if(existingDocsWrap) existingDocsWrap.style.display = "none";
  if(existingDocsList) existingDocsList.innerHTML = "";

  if(saveFinanceBtn) saveFinanceBtn.textContent = "Saƒçuvaj";
}

function renderExistingDocs(){
  if(!existingDocsWrap || !existingDocsList) return;

  if(!EDIT_DOCS || !EDIT_DOCS.length){
    existingDocsWrap.style.display = "none";
    existingDocsList.innerHTML = "";
    return;
  }

  existingDocsWrap.style.display = "block";
  existingDocsList.innerHTML = "";

  EDIT_DOCS.forEach((d, idx) => {
    const li = document.createElement("li");

    const left = document.createElement("span");
    left.textContent = d.name;

    const right = document.createElement("small");
    right.style.display = "flex";
    right.style.gap = "10px";
    right.style.alignItems = "center";

    const size = document.createElement("span");
    size.textContent = `${d.sizeKB} KB`;

    const rm = document.createElement("button");
    rm.type = "button";
    rm.className = "btn btnGhost";
    rm.textContent = "Ukloni";
    rm.style.padding = "8px 12px";
    rm.style.borderRadius = "12px";

    rm.addEventListener("click", (e) => {
      e.preventDefault();
      EDIT_DOCS.splice(idx, 1);
      renderExistingDocs();
    });

    right.appendChild(size);
    right.appendChild(rm);

    li.appendChild(left);
    li.appendChild(right);
    existingDocsList.appendChild(li);
  });
}

function setFinanceEditMode(item){
  EDIT_FIN_ID = item.id;
  EDIT_FIN_CREATED_AT = item.createdAt;
  EDIT_DOCS = (item.docs || []).map(d => ({ ...d }));

  if(financeFormWrap) financeFormWrap.style.display = "block";
  if(saveFinanceBtn) saveFinanceBtn.textContent = "Saƒçuvaj izmene";

  // popuni formu
  fDate.value = item.date || "";
  fType.value = item.type || "rashod";
  fCategory.value = item.category || "tekuƒáe odr≈æavanje";
  fDesc.value = item.desc || "";
  fAmount.value = String(item.amount ?? "");
  fFirmNew.value = "";

  // dropdown firm
  const bid = activeBid();
  if(bid) renderFirmSelect(bid);
  fFirm.value = item.firm || "";

  // reset upload input
  if(fDocs) fDocs.value = "";

  renderExistingDocs();
}

/* ===== UI LISTENERS ===== */
if(addFinanceBtn){
  addFinanceBtn.addEventListener("click", () => {
    if(!financeFormWrap) return;

    const open = (financeFormWrap.style.display === "none" || financeFormWrap.style.display === "");
    financeFormWrap.style.display = open ? "block" : "none";

    if(open){
      // ako otvaramo formu ruƒçno za NOVU stavku
      resetFinanceForm();
      clearFinanceEditMode();
      const bid = activeBid();
      if(bid) renderFirmSelect(bid);
    }
  });
}

if(cancelFinanceBtn){
  cancelFinanceBtn.addEventListener("click", () => {
    if(financeFormWrap) financeFormWrap.style.display = "none";
    resetFinanceForm();
    clearFinanceEditMode(); // ‚úÖ izlaz iz edit moda
  });
}

if(saveFinanceBtn){
  saveFinanceBtn.addEventListener("click", async () => {
    if(financeError) financeError.style.display = "none";

    const bid = activeBid();
    if(!bid){
      if(financeError){
        financeError.textContent = "Nije izabrana zgrada.";
        financeError.style.display = "block";
      }
      return;
    }

    if(!CURRENT_SESSION || !canManage()){
  if(financeError){
    financeError.textContent = "Nemate dozvolu.";
    financeError.style.display = "block";
  }
  return;
}
    const date = (fDate.value||"").trim();
    const type = fType.value;
    const category = fCategory.value;

    const firmNew = (fFirmNew.value||"").trim();
    let firm = firmNew || (fFirm.value||"").trim();

    const desc = (fDesc.value||"").trim();
    const amount = Number((fAmount.value||"").trim());

    if(!date || !type || !category || !desc || !Number.isFinite(amount)){
      if(financeError){
        financeError.textContent = "Gre≈°ka: popuni obavezna polja (datum, opis, iznos).";
        financeError.style.display = "block";
      }
      return;
    }

    // upload limit
    const files = [...(fDocs?.files || [])];
    const total = totalFilesSizeBytes(files);
    const LIMIT = 10 * 1024 * 1024;
    if(total > LIMIT){
      if(financeError){
        financeError.textContent = "Gre≈°ka: ukupna velicina fajlova prelazi 10MB.";
        financeError.style.display = "block";
      }
      return;
    }

    // dodaj novu firmu u listu ako je uneta
    if(firmNew){
      const firms = loadFirms(bid);
      if(!firms.includes(firmNew)){
        firms.push(firmNew);
        saveFirms(bid, firms);
      }
      renderFirmSelect(bid);
    }

    // procitaj nove upload fajlove
    const newDocs = [];
    try{
      for(const f of files){
        const dataURL = await fileToDataURL(f);
        newDocs.push({
          name: f.name,
          sizeKB: Math.ceil((f.size||0)/1024),
          mime: f.type || "application/pdf",
          dataURL
        });
      }
    }catch(err){
      if(financeError){
        financeError.textContent = "Gre≈°ka: ne mogu da procitam fajl (FileReader).";
        financeError.style.display = "block";
      }
      return;
    }

    // snimi CREATE ili UPDATE
    try{
      const items = loadItems(bid);

      if(EDIT_FIN_ID){
        const idx = items.findIndex(x => x.id === EDIT_FIN_ID);
        if(idx === -1){
          if(financeError){
            financeError.textContent = "Gre≈°ka: stavka za izmenu nije pronaƒëena.";
            financeError.style.display = "block";
          }
          return;
        }

        const updated = {
          ...items[idx],
          id: EDIT_FIN_ID,
          createdAt: EDIT_FIN_CREATED_AT ?? items[idx].createdAt,
          date,
          type,
          category,
          firm,
          desc,
          amount,
          docs: [...(EDIT_DOCS || []), ...newDocs] // ‚úÖ postojeƒái (posle uklanjanja) + novi
        };

        items[idx] = updated;
        saveItems(bid, items);

      }else{
        const item = {
          id: cryptoRandom(),
          createdAt: Date.now(),
          date,
          type,
          category,
          firm,
          desc,
          amount,
          docs: newDocs
        };

        items.push(item);
        saveItems(bid, items);
      }

    }catch(e){
      if(financeError){
        financeError.textContent = "Gre≈°ka: localStorage limit (PDF je prevelik). Probaj manji PDF.";
        financeError.style.display = "block";
      }
      return;
    }

    // reset UI
    if(financeFormWrap) financeFormWrap.style.display = "none";
    resetFinanceForm();
    clearFinanceEditMode();

    // rerender
    renderFinanceList(bid, CURRENT_QUERY);
    renderSearchDropdown(CURRENT_QUERY);
    updateHomeSummary();
    refreshBalanceUI(bid);
  });
}


/* ================= OGLASNA ================= */
function loadBoardPosts(bid){
  const raw = localStorage.getItem(kBoard(bid));
  if(!raw){
    const seed = [
      { id: cryptoRandom(), createdAt: Date.now()-1000*60*60*24*3, date: "2026-01-01", title: "Akcija ƒçi≈°cenja", desc: "Obave≈°tenje o terminu akcije ƒçi≈°cenja", docs: [] },
      { id: cryptoRandom(), createdAt: Date.now()-1000*60*60*24*7, date: "2025-12-28", title: "Popravka krova", desc: "Plan radova i obave≈°tenje", docs: [] }
    ];
    localStorage.setItem(kBoard(bid), JSON.stringify(seed));
    return seed;
  }
  try { return JSON.parse(raw) || []; } catch { return []; }
}
function saveBoardPosts(bid, items){
  localStorage.setItem(kBoard(bid), JSON.stringify(items));
}
function resetBoardForm(){
  if(boardError) boardError.style.display = "none";

  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,"0");
  const dd = String(today.getDate()).padStart(2,"0");
  if(bDate) bDate.value = `${yyyy}-${mm}-${dd}`;

  if(bTitle) bTitle.value = "";
  if(bDesc) bDesc.value = "";
  if(bDocs) bDocs.value = "";
}
function boardMatches(post, q){
  const docsNames = (post.docs||[]).map(d => d.name).join(" ");
  const hay = `${post.date} ${post.title} ${post.desc||""} ${docsNames}`;
  return includesQuery(hay, q);
}
function renderBoard(bid, q){
  if(!boardList) return;

  const all = loadBoardPosts(bid).slice().sort((a,b) => (b.date||"").localeCompare(a.date||""));
  const items = q ? all.filter(p => boardMatches(p, q)) : all;

  boardList.innerHTML = "";

  items.forEach(post => {
    const li = document.createElement("li");
    li.dataset.sid = "brd:" + post.id;
    li.classList.add("finCard");


    // ===== TOP RED (naslov + dugme Obri≈°i) =====
const top = document.createElement("div");
top.className = "finRowTop"; // koristi isti CSS kao finansije

const title = document.createElement("div");
title.className = "finRowTitle";
const dmy = formatDateDMY(post.date);

title.innerHTML = `
  <div class="itemHead">
    <div class="itemLeft">
      <div class="itemMeta">
        <span class="pill">${escapeHTML(dmy)}</span>
        <span class="pill">${escapeHTML(post.title || "")}</span>

        ${
          (CURRENT_SESSION?.role === "upravnik" || CURRENT_SESSION?.role === "admin")
            ? `<span class="pill">${escapeHTML(getUnitLabel(activeBid(), post.createdBy || ""))}</span>`
            : ``
        }
      </div>

      ${post.desc ? `<div class="itemDesc">${escapeHTML(post.desc)}</div>` : ``}
    </div>
  </div>
`;


top.appendChild(title);

// samo upravnik vidi obri≈°i
if (CURRENT_SESSION && CURRENT_SESSION.role === "upravnik") {
  const actions = document.createElement("div");
  actions.className = "finRowActions";

  const del = document.createElement("button");
  del.className = "finActBtn danger";
  del.type = "button";
  del.textContent = "Obri≈°i";

  del.addEventListener("click", async () => {
  const ok = await showConfirm({
    title: "Brisanje objave",
    text: "Da li ste sigurni da ≈æelite da obri≈°ete ovu objavu sa oglasne table? Ova radnja je trajna.",
    okText: "Obri≈°i"
  });
  if(!ok) return;

  const next = loadBoardPosts(bid).filter(x => x.id !== post.id);
  saveBoardPosts(bid, next);
  renderBoard(bid, CURRENT_QUERY);
  renderSearchDropdown(CURRENT_QUERY);
  updateHomeSummary();
});


  actions.appendChild(del);
  top.appendChild(actions);
}

li.appendChild(top);
// ===== /TOP RED =====

    if(post.docs && post.docs.length){
      li.classList.add("hasDocs");
      
      const ul = document.createElement("ul");
      ul.className = "fileList";

      post.docs.forEach(d => {
        const fli = document.createElement("li");
        fli.style.cursor = "pointer";
        fli.title = "Klik za otvaranje";
        fli.innerHTML = `<span>${d.name}</span><small>${d.sizeKB} KB</small>`;

        fli.addEventListener("click", () => {
          if(!d.dataURL){
            alert("Fajl je sacuvan bez sadr≈æaja. Uploaduj ponovo.");
            return;
          }
          const w = window.open();
          if(!w){
            alert("Browser je blokirao pop-up. Dozvoli pop-up za ovaj sajt.");
            return;
          }
          w.document.write(`
            <title>${d.name}</title>
            <iframe src="${d.dataURL}" style="position:fixed; inset:0; width:100%; height:100%; border:0;"></iframe>
          `);
          w.document.close();
        });

        ul.appendChild(fli);
      });

      li.appendChild(ul);
    }

    boardList.appendChild(li);
  });
}
function boardInit(bid){
  renderBoard(bid, CURRENT_QUERY);
  resetBoardForm();
  if(boardFormWrap) boardFormWrap.style.display = "none";
}
if(addBoardBtn){
  addBoardBtn.addEventListener("click", () => {
    if(!boardFormWrap) return;
    boardFormWrap.style.display =
      (boardFormWrap.style.display === "none" || boardFormWrap.style.display === "") ? "block" : "none";
    if(boardFormWrap.style.display === "block") resetBoardForm();
  });
}
if(cancelBoardBtn){
  cancelBoardBtn.addEventListener("click", () => {
    if(boardFormWrap) boardFormWrap.style.display = "none";
    resetBoardForm();
  });
}
if(saveBoardBtn){
  saveBoardBtn.addEventListener("click", async () => {
    const bid = activeBid();
    if(!bid){
      if(boardError){
        boardError.textContent = "Nije izabrana zgrada.";
        boardError.style.display = "block";
      }
      return;
    }

    if(!CURRENT_SESSION || CURRENT_SESSION.role !== "upravnik"){
      if(boardError){
        boardError.textContent = "Nemate dozvolu.";
        boardError.style.display = "block";
      }
      return;
    }

    if(boardError) boardError.style.display = "none";

    const title = (bTitle?.value || "").trim();
    const date = (bDate?.value || "").trim();
    const desc = (bDesc?.value || "").trim();

    if(!title || !date){
      if(boardError){
        boardError.textContent = "Gre≈°ka: naslov i datum su obavezni.";
        boardError.style.display = "block";
      }
      return;
    }

    const files = [...(bDocs?.files || [])];
    const total = totalFilesSizeBytes(files);
    const LIMIT = 10 * 1024 * 1024;
    if(total > LIMIT){
      if(boardError){
        boardError.textContent = "Gre≈°ka: ukupna velicina fajlova prelazi 10MB.";
        boardError.style.display = "block";
      }
      return;
    }

    const docs = [];
    try{
      for(const f of files){
        const dataURL = await fileToDataURL(f);
        docs.push({
          name: f.name,
          sizeKB: Math.ceil((f.size||0)/1024),
          mime: f.type || "application/pdf",
          dataURL
        });
      }
    }catch(e){
      if(boardError){
        boardError.textContent = "Gre≈°ka: ne mogu da procitam fajl (FileReader).";
        boardError.style.display = "block";
      }
      return;
    }

    const post = {
      id: cryptoRandom(),
      createdAt: Date.now(),
      date,
      title,
      desc,
      docs
    };

    try{
      const items = loadBoardPosts(bid);
      items.push(post);
      saveBoardPosts(bid, items);
    }catch(e){
      if(boardError){
        boardError.textContent = "Gre≈°ka: localStorage limit (PDF je prevelik). Probaj manji PDF.";
        boardError.style.display = "block";
      }
      return;
    }

    if(boardFormWrap) boardFormWrap.style.display = "none";
    resetBoardForm();
    renderBoard(bid, CURRENT_QUERY);
    renderSearchDropdown(CURRENT_QUERY);
    updateHomeSummary();
  });
}

/* ================= FORUM ================= */
function loadProposals(bid){
  const raw = localStorage.getItem(kForum(bid));
  if(!raw){
    const seed = [
      {
        id: cryptoRandom(),
        createdAt: Date.now() - 1000*60*60*24*3,
        title: "Nova rasveta u hodniku",
        body: "Predlog da se zamene sijalice LED rasvetom zbog ustede.",
        createdBy: "BM25-001",
        poll: { enabled: true, endsAt: Date.now() + 1000*60*60*24*4, votesYes: [], votesNo: [] }
      },
      {
        id: cryptoRandom(),
        createdAt: Date.now() - 1000*60*60*24*10,
        title: "Zamena interfona",
        body: "Predlog da se proveri ponuda za zamenu interfona u zgradi.",
        createdBy: "BM25-002",
        poll: { enabled: true, endsAt: Date.now() - 1000*60*60*24*1, votesYes: ["demo@x"], votesNo: [] }
      }
    ];
localStorage.setItem(kForum(bid), JSON.stringify(seed));
    return seed;
  }
  try { return JSON.parse(raw) || []; } catch { return []; }
}

function saveProposals(bid, items){
  localStorage.setItem(kForum(bid), JSON.stringify(items));
}

function fmtDateTime(ms){
  const d = new Date(ms);
  return d.toLocaleString("sr-RS");
}

function daysLeftUntil(ms){
  const diff = Number(ms || 0) - Date.now();
  return Math.max(0, Math.ceil(diff / (1000*60*60*24)));
}

function fmtDateOnly(ms){
  if(!ms) return "";
  return new Date(ms).toLocaleDateString("sr-RS");
}

function forumMatches(p, q){
  const hay = `${p.title} ${p.body}`;
  return includesQuery(hay, q);
}

function ensurePollSR(p){
  if(!p || !p.poll) return null;

  // migracija starog tipa u srpski ("da/ne")
  if(Array.isArray(p.poll.votesYes) && !Array.isArray(p.poll.da)) p.poll.da = p.poll.votesYes.slice();
  if(Array.isArray(p.poll.votesNo)  && !Array.isArray(p.poll.ne)) p.poll.ne = p.poll.votesNo.slice();

  p.poll.da = Array.isArray(p.poll.da) ? p.poll.da : [];
  p.poll.ne = Array.isArray(p.poll.ne) ? p.poll.ne : [];
  p.poll.endsAt = Number(p.poll.endsAt || 0);
  p.poll.enabled = !!p.poll.enabled;

  return p.poll;
}

/* ‚úÖ KOD 1) ‚Äî PROCENTI GLASANJA */
function getVoteStats(poll){
  const yes = poll?.da?.length || 0;
  const no  = poll?.ne?.length || 0;
  const total = yes + no;

  return {
    yes,
    no,
    total,
    yesPct: total ? Math.round((yes / total) * 100) : 0,
    noPct: total ? Math.round((no / total) * 100) : 0
  };
}

/* ================= VLASNICI STANOVA ================= */

function kUnits(bid){
  return `units_${bid}`;
}

function loadUnits(bid){
  try{
    return JSON.parse(localStorage.getItem(kUnits(bid))) || {};
  }catch{
    return {};
  }
}

function saveUnits(bid, data){
  localStorage.setItem(kUnits(bid), JSON.stringify(data));
}

function renderUnitOwners(bid){
  const wrap = document.getElementById("unitOwnersWrap");
  const table = document.getElementById("unitOwnersTable");
  if(!wrap || !table) return;

  // samo ADMIN sme da unosi/menja vlasnike
if(CURRENT_SESSION?.role !== "admin"){
  wrap.style.display = "none";
  return;
}

  wrap.style.display = "block";
  table.innerHTML = "";

  const units = loadUnits(bid);
  const building = BUILDINGS.find(b => b.id === bid);
  if(!building) return;

  for(let i = 1; i <= building.units; i++){
    const code = `${building.id.toUpperCase().replace("B_","")}-${String(i).padStart(3,"0")}`;

    const row = document.createElement("div");
    row.className = "unitOwnerRow fRow";

    const label = document.createElement("div");
    label.className = "unitCode";
    label.textContent = code;

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "Ime i prezime vlasnika";
    input.value = units[code]?.fullName || "";

    input.addEventListener("change", () => {
      const data = loadUnits(bid);
      if(input.value.trim()){
        data[code] = { fullName: input.value.trim() };
      }else{
        delete data[code];
      }
      saveUnits(bid, data);
    });

    row.appendChild(label);
    row.appendChild(input);
    table.appendChild(row);
  }
}

/* ===== HELPER: PRIKAZ STANA + IME (SAMO UPRAVNIK / ADMIN) ===== */
function getUnitLabel(bid, unitCode){
  const isPrivileged =
    CURRENT_SESSION?.role === "upravnik" ||
    CURRENT_SESSION?.role === "admin";

  // ‚õî stanar vidi samo ID stana
  if(!isPrivileged) return unitCode;

  const code = String(unitCode || "").trim().toUpperCase();
  if(!code) return "";

  // ‚úÖ GLAVNI IZVOR: admin unos (UnitsDB)
  const rows = loadUnitsDB(bid);
  const hit = rows.find(r =>
    String(r.unitCode || "").trim().toUpperCase() === code
  );

  const fullName = (hit?.ownerFullName || "").trim();
  if(fullName) return `${code} (${fullName})`;

  // ‚ö†Ô∏è fallback: stari sistem (ako negde jo≈° postoji)
  const units = loadUnits(bid);
  const legacyName =
    units?.[code]?.fullName ||
    units?.[code]?.ownerFullName ||
    "";

  return legacyName ? `${code} (${legacyName})` : code;
}

function bindAdminFinSwitch(){
  const host = document.getElementById("adminFinBuildingSwitch");
  if(!host) return;

  // samo admin
  if(CURRENT_SESSION?.role !== "admin"){
    host.style.display = "none";
    host.innerHTML = "";
    return;
  }

  // ako je veƒá bindovano, ne dupliraj
  if(host.dataset.bound === "1") return;

  host.style.display = "block";

  // ‚úÖ koristimo ISTI markup/klase kao na poƒçetnoj
  host.innerHTML = `
    <div class="adminTopWrap">
      <button type="button" class="btn btnGhost" id="adminFinArrowBtn">
        Promeni zgradu <span style="opacity:.7">‚ñæ</span>
      </button>

      <div class="adminBuildingMenu hidden" id="adminFinBuildingMenu" style="margin-top:10px;">
        <div class="field">
          <label>Pretraga zgrade</label>
          <input type="text" id="adminFinBuildingSearch" placeholder="npr. Bore Markoviƒáa 25">
        </div>

        <div class="adminBuildingGrid" id="adminFinBuildingGrid" style="margin-top:10px;"></div>
      </div>
    </div>
  `;

  const adminArrowBtn = document.getElementById("adminFinArrowBtn");
  const adminBuildingMenu = document.getElementById("adminFinBuildingMenu");
  const input = document.getElementById("adminFinBuildingSearch");
  const grid = document.getElementById("adminFinBuildingGrid");

  function renderForQuery(q){
    const query = (q || "").trim().toLowerCase();
    const rows = BUILDINGS.filter(b => {
      if(!query) return true;
      const hay = `${b.title} ${b.street} ${b.number}`.toLowerCase();
      return hay.includes(query);
    });

    grid.innerHTML = "";
    if(!rows.length){
      grid.innerHTML = `<div class="smallText"><span class="badge">Nema rezultata</span></div>`;
      return;
    }

    rows.forEach(b => {
      const el = document.createElement("button");
      el.type = "button";
      el.className = "btn btnGhost";
      el.style.justifyContent = "flex-start";
      el.textContent = b.title;

      el.addEventListener("click", (e) => {
        e.stopPropagation();
        setActiveBuilding(b.id);
        input.value = b.title;

        updateMonthlyUploadUI(false);
        applySearchFilter();
        showPage("finansije");

        adminBuildingMenu.classList.add("hidden");
      });

      grid.appendChild(el);
    });
  }

  // toggle menu
  adminArrowBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    adminBuildingMenu.classList.toggle("hidden");
    if(!adminBuildingMenu.classList.contains("hidden")){
      renderForQuery(input.value);
    }
  });

  // input search
  input.addEventListener("input", () => renderForQuery(input.value));

  // klik van -> zatvori
  document.addEventListener("click", (e) => {
    if(adminBuildingMenu.classList.contains("hidden")) return;
    const wrap = host.querySelector(".adminTopWrap");
    if(wrap && wrap.contains(e.target)) return;
    adminBuildingMenu.classList.add("hidden");
  });

  // init lista
  renderForQuery("");

  host.dataset.bound = "1";
}

/* ================= UNITS DB (backend-ready) ================= */
function kUnitsDB(bid){ return `unitsdb_${bid}`; }

function loadUnitsDB(bid){
  try{ return JSON.parse(localStorage.getItem(kUnitsDB(bid))) || []; }
  catch{ return []; }
}

function saveUnitsDB(bid, rows){
  localStorage.setItem(kUnitsDB(bid), JSON.stringify(rows));
}

function findUnitDB(bid, unitCode){
  return loadUnitsDB(bid).find(x => x.unitCode === unitCode) || null;
}

function upsertUnitDB(bid, unit){
  const rows = loadUnitsDB(bid);
  const idx = rows.findIndex(x => x.unitCode === unit.unitCode);
  if(idx === -1) rows.push(unit);
  else rows[idx] = { ...rows[idx], ...unit };
  saveUnitsDB(bid, rows);
}

function deleteUnitDB(bid, unitCode){
  saveUnitsDB(bid, loadUnitsDB(bid).filter(x => x.unitCode !== unitCode));
}

function nextUnitCodeDB(bid){
  const building = BUILDINGS.find(b => b.id === bid);
  if(!building) return null;

  const prefix = building.id.replace("b_","").toUpperCase(); // BM25
  const rows = loadUnitsDB(bid);

  const nums = rows.map(x => {
    const m = String(x.unitCode||"").match(/-(\d{3})$/);
    return m ? Number(m[1]) : null;
  }).filter(n => Number.isFinite(n));

  const next = (nums.length ? Math.max(...nums) : 0) + 1;
  return `${prefix}-${String(next).padStart(3,"0")}`;
}

/* ================= ADMIN: UPRAVLJANJE STANOVIMA ================= */
function renderAdminUnits(bid){
  const wrap = document.getElementById("adminUnitsWrap");
  const list = document.getElementById("adminUnitsList");
  const addBtn = document.getElementById("adminAddUnitBtn");
  const form = document.getElementById("adminAddUnitForm");
const bCodeI = document.getElementById("adminUnitBCode");
const addrI  = document.getElementById("adminUnitAddr");
const ownerI = document.getElementById("adminUnitOwner");
const unitI  = document.getElementById("adminUnitCode");
const saveBtn = document.getElementById("adminSaveUnitBtn");
const cancelBtn = document.getElementById("adminCancelUnitBtn");
  const det = document.getElementById("adminUnitDetails");
const audTitle = document.getElementById("audTitle");
const audUnitCode = document.getElementById("audUnitCode");
const audOwner = document.getElementById("audOwner");
const audSaveBtn = document.getElementById("audSaveBtn");
const audCloseBtn = document.getElementById("audCloseBtn");
const audDeleteBtn = document.getElementById("audDeleteBtn");
  
if(!wrap || !list || !addBtn || !form || !bCodeI || !addrI || !ownerI || !unitI || !saveBtn || !cancelBtn ||
   !det || !audTitle || !audUnitCode || !audOwner || !audSaveBtn || !audCloseBtn || !audDeleteBtn) return;
 
  if(CURRENT_SESSION?.role !== "admin"){
    wrap.style.display = "none";
    return;
  }

  wrap.style.display = "block";

  function redraw(){
    const rows = loadUnitsDB(bid);
    list.innerHTML = "";

    if(!rows.length){
      list.innerHTML = `<div class="smallText"><span class="badge">Nema unetih stanova</span></div>`;
      return;
    }

    rows
  .slice()
  .sort((a,b) => String(a.unitCode).localeCompare(String(b.unitCode)))
  .forEach(u => {
    const row = document.createElement("div");
    row.className = "fRow";
    row.style.display = "flex";
    row.style.gap = "10px";
    row.style.alignItems = "center";
    row.style.justifyContent = "space-between";

    // ‚¨Ö 4.3: klik na red otvara detalje stana
    row.style.cursor = "pointer";
    row.addEventListener("click", () => {
      form.style.display = "none";
      det.style.display = "block";
      audTitle.textContent = `Stan: ${u.unitCode}`;
      audUnitCode.value = u.unitCode;
      audOwner.value = u.ownerFullName || "";
      audOwner.focus();
    });

    const left = document.createElement("div");
    left.innerHTML = `
      <div style="font-weight:900">${escapeHTML(u.unitCode)}</div>
      <div class="smallText" style="opacity:.75">
        Vlasnik: <b>${escapeHTML(u.ownerFullName || "‚Äî")}</b>
      </div>
    `;

    const actions = document.createElement("div");
    actions.style.display = "flex";
    actions.style.gap = "8px";

    const del = document.createElement("button");
    del.type = "button";
    del.className = "btn btnGhost";
    del.textContent = "Obri≈°i";
    del.addEventListener("click", (e) => {
      e.stopPropagation(); // da klik na Obri≈°i ne otvara detalje
      if(!confirm(`Obrisati ${u.unitCode}?`)) return;
      deleteUnitDB(bid, u.unitCode);
      redraw();
    });

    actions.appendChild(del);

    row.appendChild(left);
    row.appendChild(actions);
    list.appendChild(row);
  });
}
  
  addBtn.onclick = () => {
  // ako su otvoreni detalji, sakrij ih
  det.style.display = "none";

  const building = BUILDINGS.find(b => b.id === bid);
  if(!building) return;

  const bcode = building.id.replace("b_","").toUpperCase(); // BM25
  const addr = `${building.street || ""} ${building.number || ""}`.trim();

  bCodeI.value = bcode;
  addrI.value = (building.title || addr || "");
  ownerI.value = "";
  unitI.value = nextUnitCodeDB(bid) || `${bcode}-001`;

  form.style.display = "block";
  ownerI.focus();
};

cancelBtn.onclick = () => {
  form.style.display = "none";
};

saveBtn.onclick = () => {
  const unitCode = (unitI.value || "").trim().toUpperCase();
  const ownerFullName = (ownerI.value || "").trim();

  if(!unitCode || !ownerFullName){
    alert("Popuni: Ime i prezime + ID stana.");
    return;
  }

  const rows = loadUnitsDB(bid);
  if(rows.some(x => String(x.unitCode).toUpperCase() === unitCode)){
    alert("Taj ID stana veƒá postoji.");
    return;
  }

  upsertUnitDB(bid, { unitCode, ownerFullName, active: true });
  form.style.display = "none";
  redraw();
};

// 4.4 ‚Äî dugmad u detaljima stana
audCloseBtn.onclick = () => {
  det.style.display = "none";
};

audSaveBtn.onclick = () => {
  const unitCode = (audUnitCode.value || "").trim().toUpperCase();
  const ownerFullName = (audOwner.value || "").trim();

  if(!unitCode) return;
  if(!ownerFullName){
    alert("Unesi ime i prezime vlasnika.");
    return;
  }

  upsertUnitDB(bid, { unitCode, ownerFullName, active: true });
  det.style.display = "none";
  redraw();
};

audDeleteBtn.onclick = () => {
  const unitCode = (audUnitCode.value || "").trim().toUpperCase();
  if(!unitCode) return;

  if(!confirm(`Obrisati ${unitCode}?`)) return;
  deleteUnitDB(bid, unitCode);
  det.style.display = "none";
  redraw();
};

redraw();
  }
  
  /* ================= ADMIN: UPRAVLJANJE ZGRADAMA ================= */
function renderAdminBuildings(){
  const wrap = document.getElementById("adminBuildingsWrap");
  const list = document.getElementById("adminBuildingsList");
  const btn  = document.getElementById("adminAddBuildingBtn");

  const codeI   = document.getElementById("adminBCode");
  const titleI  = document.getElementById("adminBTitle");
  const streetI = document.getElementById("adminBStreet");
  const numberI = document.getElementById("adminBNumber");
  const unitsI  = document.getElementById("adminBUnits");

  if(!wrap || !list || !btn) return;

  if(CURRENT_SESSION?.role !== "admin"){
    wrap.style.display = "none";
    return;
  }
  wrap.style.display = "block";

  function redraw(){
    const rows = loadBuildingsDB();
    list.innerHTML = "";

    if(!rows.length){
      list.innerHTML = `<div class="smallText"><span class="badge">Nema dodatih zgrada</span></div>`;
      return;
    }

    rows.forEach(b => {
      const row = document.createElement("div");
      row.className = "fRow";
      row.style.display = "flex";
      row.style.justifyContent = "space-between";
      row.style.alignItems = "center";
      row.style.gap = "10px";

      const left = document.createElement("div");
      left.innerHTML = `
        <div style="font-weight:900">${escapeHTML(b.title || "")}</div>
        <div class="smallText" style="opacity:.75">
          ${escapeHTML(b.street || "")} ${escapeHTML(b.number || "")}
          ‚Ä¢ ≈°ifra: <b>${escapeHTML((b.code||"").toUpperCase())}</b>
          ‚Ä¢ stanova: <b>${escapeHTML(String(b.units||0))}</b>
        </div>
      `;

      const actions = document.createElement("div");
      actions.style.display = "flex";
      actions.style.gap = "8px";

      const del = document.createElement("button");
      del.type = "button";
      del.className = "btn btnGhost";
      del.textContent = "Obri≈°i";
      del.addEventListener("click", () => {
        if(!confirm(`Obrisati zgradu "${b.title}"?`)) return;

        // izbri≈°i iz DB
        const leftRows = loadBuildingsDB().filter(x => x.id !== b.id);
        saveBuildingsDB(leftRows);

        // ukloni iz runtime BUILDINGS
        const idx = BUILDINGS.findIndex(x => x.id === b.id);
        if(idx !== -1) BUILDINGS.splice(idx, 1);

        redraw();
        applySearchFilter();
      });

      actions.appendChild(del);

      row.appendChild(left);
      row.appendChild(actions);
      list.appendChild(row);
    });
  }
  
  btn.onclick = () => {
    try{
      const code   = (codeI?.value || "").trim();
      const title  = (titleI?.value || "").trim();
      const street = (streetI?.value || "").trim();
      const number = (numberI?.value || "").trim();
      const units  = Number(unitsI?.value || 0);

      const newB = adminAddBuilding({ code, title, street, number, units });

      // oƒçisti polja
      codeI.value = "";
      titleI.value = "";
      streetI.value = "";
      numberI.value = "";
      unitsI.value = "";

      redraw();

      // prebaci admina na novu zgradu
      setActiveBuilding(newB.id);
      applySearchFilter();
      showPage("finansije");
    }catch(err){
      alert(err?.message || "Gre≈°ka pri dodavanju zgrade.");
    }
  };

  redraw();
}
  
function voteOnProposal(bid, proposalId, choice){ // "da" | "ne"
  if(!bid || !proposalId) return;

  if(CURRENT_SESSION?.role !== "stanar"){
    alert("Glasanje je dostupno samo stanarima.");
    return;
  }

  const user = CURRENT_SESSION.username;
  const items = loadProposals(bid);
  const idx = items.findIndex(x => x.id === proposalId);
  if(idx === -1) return;

  const p = items[idx];
  const poll = ensurePollSR(p);
  if(!poll?.enabled) return;

  if(poll.endsAt && Date.now() >= poll.endsAt){
    alert("Anketa je zavr≈°ena.");
    return;
  }

  const wasInDa = poll.da.includes(user);
  const wasInNe = poll.ne.includes(user);

  poll.da = poll.da.filter(u => u !== user);
  poll.ne = poll.ne.filter(u => u !== user);

  if(choice === "da" && !wasInDa) poll.da.push(user);
  if(choice === "ne" && !wasInNe) poll.ne.push(user);

  items[idx] = p;
  saveProposals(bid, items);

  renderForum(bid, CURRENT_QUERY);
  renderSearchDropdown(CURRENT_QUERY);
  updateHomeSummary();
}

function renderForum(bid, q){
  if(!forumList) return;
  const all = loadProposals(bid).slice().sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
  const items = q ? all.filter(p => forumMatches(p, q)) : all;

  forumList.innerHTML = "";

  items.forEach(p => {
    const li = document.createElement("li");
    li.dataset.sid = "frm:" + p.id;

    const top = document.createElement("div");
    top.style.display = "flex";
    top.style.justifyContent = "space-between";
    top.style.gap = "10px";
    top.style.flexWrap = "wrap";

    const left = document.createElement("div");
    left.style.fontWeight = "900";
    left.textContent = p.title;

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.alignItems = "center";
    right.style.flexWrap = "wrap";

    const meta = document.createElement("span");
    meta.className = "badge";
    meta.textContent = fmtDateTime(p.createdAt);

    right.appendChild(meta);

    // ‚úÖ NOVO: ko je pokrenuo (svima vidljivo, ali ime samo admin/upravnik)
    const by = document.createElement("span");
    by.className = "badge";
    by.textContent = `Pokrenuo: ${getUnitLabel(bid, p.createdBy || "")}`;
    right.appendChild(by);
    
    top.appendChild(left);
    top.appendChild(right);

    const body = document.createElement("div");
body.className = "smallText";
body.style.marginTop = "8px";
body.textContent = p.body;

li.appendChild(top);
li.appendChild(body);

/* ‚úÖ AUTOMATSKA ANKETA ‚Äì 30 DANA (suptilno) */
if (p.poll?.enabled) {
  const pollInfo = document.createElement("div");
  pollInfo.className = "smallText";
  pollInfo.style.marginTop = "6px";
  pollInfo.style.opacity = ".7";

  const daysLeft = daysLeftUntil(p.poll.endsAt);

  pollInfo.textContent =
    daysLeft > 0
      ? `Anketa traje 30 dana ‚Ä¢ preostalo ${daysLeft} dana`
      : `Anketa je zavr≈°ena`;

  li.appendChild(pollInfo);
}

// ‚úÖ GLASANJE (DA / NE) ‚Äì samo stanar glasa, svi vide rezultate
const poll = ensurePollSR(p);
if(poll?.enabled){
  const ended = poll.endsAt && Date.now() >= poll.endsAt;

  const wrap = document.createElement("div");
  wrap.style.display = "flex";
  wrap.style.gap = "10px";
  wrap.style.flexWrap = "wrap";
  wrap.style.alignItems = "center";
  wrap.style.marginTop = "8px";

  const user = CURRENT_SESSION?.username || "";
  const iVotedDa = poll.da.includes(user);
  const iVotedNe = poll.ne.includes(user);

  const btnDa = document.createElement("button");
  btnDa.type = "button";
  btnDa.className = "btn btnGhost";
  btnDa.textContent = `DA (${poll.da.length})`;
  btnDa.disabled = ended || (CURRENT_SESSION?.role !== "stanar");
  if(iVotedDa) btnDa.style.boxShadow = "0 0 0 4px rgba(22,163,74,.18)";

  const btnNe = document.createElement("button");
  btnNe.type = "button";
  btnNe.className = "btn btnGhost";
  btnNe.textContent = `NE (${poll.ne.length})`;
  btnNe.disabled = ended || (CURRENT_SESSION?.role !== "stanar");
  if(iVotedNe) btnNe.style.boxShadow = "0 0 0 4px rgba(220,38,38,.18)";

  btnDa.addEventListener("click", () => voteOnProposal(activeBid(), p.id, "da"));
  btnNe.addEventListener("click", () => voteOnProposal(activeBid(), p.id, "ne"));

  const status = document.createElement("div");
  status.className = "smallText";
  status.style.opacity = ".75";
  status.textContent = ended
    ? "Glasanje je zatvoreno."
    : "Klikni DA ili NE (mo≈æe≈° promeniti glas).";

  // ‚úÖ NOVO: PROCENTI + BAR (vidljivo svima)
  const stats = getVoteStats(poll);

  const statsWrap = document.createElement("div");
  statsWrap.className = "pollStats";
  statsWrap.style.width = "100%";         // da bar ide ispod dugmadi u novi red
  statsWrap.style.marginTop = "6px";

  statsWrap.innerHTML = `
    <div class="pollBar">
      <div class="pollYes" style="width:${stats.yesPct}%"></div>
      <div class="pollNo" style="width:${stats.noPct}%"></div>
    </div>

    <div class="pollText">
      <span>üëç Da: <b>${stats.yesPct}%</b> (${stats.yes})</span>
      <span class="pollSep">‚Ä¢</span>
      <span>üëé Ne: <b>${stats.noPct}%</b> (${stats.no})</span>
      <span class="pollSep">‚Ä¢</span>
      <span>Ukupno: ${stats.total}</span>
    </div>
  `;

  wrap.appendChild(btnDa);
  wrap.appendChild(btnNe);
  wrap.appendChild(status);
  wrap.appendChild(statsWrap); // ‚úÖ NOVO

  li.appendChild(wrap);
}

forumList.appendChild(li);
});
}
  
let DUES_ACTIVE_USER = null;

function saldoClass(s){
  if(s < 0) return "status-dug";
  if(s === 0) return "status-obaveza";
  return "status-uplaceno";
}

function renderDuesAdmin(){
  const bid = activeBid();
if(!bid) return;

if(!canManage()) return;

if(!monthlyFeeInput || !duesStartMonth || !saveDuesSettingsBtn || !duesGrid) return;
  const dues = loadDues(bid);

  // pode≈°avanja (meseƒçna obaveza + start mesec)
  monthlyFeeInput.value = String(Number(dues.monthlyFee || 2000));
  duesStartMonth.value = dues.startMonth || ymNow();

  saveDuesSettingsBtn.onclick = () => {
    const fee = Number(monthlyFeeInput.value || 0);
    const sm  = String(duesStartMonth.value || "").trim();

    const obj = loadDues(bid);
    obj.monthlyFee = Number.isFinite(fee) ? fee : 0;
    if(sm) obj.startMonth = sm;

    saveDues(bid, obj);
    renderDuesAdmin();
  };
  
  // ===== lista stanara =====
  let users = listResidentsForBuilding(bid).map(u => {
    const r = computeUserDue(bid, u);

    // normalizuj saldo na ‚Äútaƒçno 0‚Äù (da ne bude -0.000001)
    const saldo = Math.abs(r.saldo) < 0.0001 ? 0 : r.saldo;

    return {
      username: u,
      paid: r.paid,
      expected: r.expected,
      saldo
    };
  });

  // ===== pretraga =====
  const q = (duesSearch?.value || "").trim();
  if(q){
    const nq = normalizeText(q);
    users = users.filter(x => normalizeText(x.username).includes(nq));
  }

  // ===== filter =====
  const f = duesFilter?.value || "svi";
  if(f === "dug") users = users.filter(x => x.saldo < 0);
  if(f === "nula") users = users.filter(x => x.saldo === 0);
  if(f === "pretplata") users = users.filter(x => x.saldo > 0);

  // ===== sortiranje =====
  const srt = duesSort?.value || "user-asc";
  users.sort((a,b) => {
    if(srt === "user-asc") return (a.username||"").localeCompare(b.username||"");
    if(srt === "saldo-asc") return (a.saldo - b.saldo);   // najvi≈°e duga (najmanji saldo) prvo
    if(srt === "saldo-desc") return (b.saldo - a.saldo);  // najvi≈°e pretplate prvo
    return 0;
  });

  // ===== render =====
  duesGrid.innerHTML = "";

  if(!users.length){
    const empty = document.createElement("div");
    empty.className = "smallText";
    empty.style.marginTop = "10px";
    empty.innerHTML = `<span class="badge">Nema rezultata</span>`;
    duesGrid.appendChild(empty);
    return;
  }

  users.forEach(u => {
    const row = document.createElement("div");
    row.className = "duesRow";

    const left = document.createElement("div");

const unitLabel = (CURRENT_SESSION?.role === "upravnik" || CURRENT_SESSION?.role === "admin")
  ? getUnitLabel(activeBid(), u.username)
  : u.username;

left.innerHTML = `
  <div class="duesUser">${escapeHTML(unitLabel)}</div>
  <div class="duesMeta">Pregled za aktivnu zgradu</div>
`;

    const paid = document.createElement("div");
    paid.className = "duesBadges";
    paid.style.justifyContent = "flex-start";
    paid.innerHTML = `
      <span class="duesBadge status-uplaceno">Uplaƒáeno: <b>${formatRSD(u.paid)}</b> RSD</span>
    `;

    const exp = document.createElement("div");
    exp.className = "duesBadges";
    exp.style.justifyContent = "flex-start";
    exp.innerHTML = `
      <span class="duesBadge status-obaveza">Obaveza: <b>${formatRSD(u.expected)}</b> RSD</span>
    `;

    const sal = document.createElement("div");
    sal.className = "duesBadges";
    sal.style.justifyContent = "flex-start";

    const salBadge = document.createElement("span");
    salBadge.className = `duesBadge ${saldoClass(u.saldo)}`;

    if(u.saldo < 0){
      salBadge.textContent = `Potra≈æivanje SZ: ${formatRSD(-u.saldo)} RSD`;
    }else if(u.saldo === 0){
      salBadge.textContent = `Potra≈æivanje SZ: 0,00 RSD`;
    }else{
      salBadge.textContent = `Potra≈æivanje SZ: +${formatRSD(u.saldo)} RSD`;
    }

    sal.appendChild(salBadge);

    const actions = document.createElement("div");
    actions.className = "duesActions";

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "btn btnGhost";
    btn.textContent = "Uplata";

    // sugestija: ako je dug, predlo≈æi ‚Äúrazliku do nule‚Äù; ako nije, predlo≈æi meseƒçnu obavezu
    const suggested = u.saldo < 0 ? Math.ceil((-u.saldo)) : Number(loadDues(bid).monthlyFee || 0);

    btn.addEventListener("click", () => openDuesPay(u.username, suggested));
    actions.appendChild(btn);

    const edit = document.createElement("button");
edit.type = "button";
edit.className = "btn btnGhost";
edit.textContent = "Izmena";

// (opciono) zabrani ako nije upravnik/admin
edit.disabled = !canAdjustDues();

edit.addEventListener("click", () => openDuesAdjust(u.username));
actions.appendChild(edit);

    row.appendChild(left);
    row.appendChild(paid);
    row.appendChild(exp);
    row.appendChild(sal);
    row.appendChild(actions);

    duesGrid.appendChild(row);
  });

  // ===== listeners (jednom) =====
  if(duesSearch && !duesSearch.dataset.bound){
    duesSearch.addEventListener("input", renderDuesAdmin);
    duesSearch.dataset.bound = "1";
  }
  if(duesFilter && !duesFilter.dataset.bound){
    duesFilter.addEventListener("change", renderDuesAdmin);
    duesFilter.dataset.bound = "1";
  }
  if(duesSort && !duesSort.dataset.bound){
    duesSort.addEventListener("change", renderDuesAdmin);
    duesSort.dataset.bound = "1";
  }
}

function openDuesPay(username, suggested){
  DUES_ACTIVE_USER = username;

  if(!duesPayWrap || !duesPayTitle || !duesPayDate || !duesPayAmount || !duesPayDocs) return;

  const d = new Date();
  duesPayTitle.textContent = `Uplata: ${username}`;
  duesPayDate.value = d.toISOString().slice(0,10);
  duesPayAmount.value = String(Number(suggested||0) || "");
  if(duesPayNote) duesPayNote.value = "";
  duesPayDocs.value = "";
  if(duesPayError){ duesPayError.style.display="none"; duesPayError.textContent=""; }

  duesPayWrap.style.display = "block";
  duesPayWrap.scrollIntoView({behavior:"smooth", block:"start"});
}

async function saveDuesPay(){
  const bid = activeBid();
  if(!bid) return;

  // ‚úÖ upravnik + admin smeju
  if(!CURRENT_SESSION || !canManage()) return;

  if(!DUES_ACTIVE_USER) return;

  const date = (duesPayDate?.value || "").trim();
  const amount = Number((duesPayAmount?.value || "").trim());
  const note = (duesPayNote?.value || "").trim();

  if(!date || !Number.isFinite(amount)){
    if(duesPayError){
      duesPayError.textContent = "Gre≈°ka: datum i iznos su obavezni.";
      duesPayError.style.display = "block";
    }
    return;
  }

  const files = [...(duesPayDocs?.files || [])];
  const total = totalFilesSizeBytes(files);
  const LIMIT = 10 * 1024 * 1024;
  if(total > LIMIT){
    if(duesPayError){
      duesPayError.textContent = "Gre≈°ka: ukupna veliƒçina PDF-ova prelazi 10MB.";
      duesPayError.style.display = "block";
    }
    return;
  }

  const docs = [];
  try{
    for(const f of files){
      const dataURL = await fileToDataURL(f);
      docs.push({
        name: f.name,
        sizeKB: Math.ceil((f.size||0)/1024),
        mime: f.type || "application/pdf",
        dataURL
      });
    }
  }catch{
    if(duesPayError){
      duesPayError.textContent = "Gre≈°ka: ne mogu da proƒçitam PDF (FileReader).";
      duesPayError.style.display = "block";
    }
    return;
  }

  addDuesPayment(bid, DUES_ACTIVE_USER, {
    id: cryptoRandom(),
    createdAt: Date.now(),
    date,
    amount,
    note,
    docs
  });

  duesPayWrap.style.display = "none";
  DUES_ACTIVE_USER = null;

  renderDuesAdmin();
}

function cancelDuesPay(){
  if(duesPayWrap) duesPayWrap.style.display = "none";
  DUES_ACTIVE_USER = null;
}

if(duesPaySaveBtn) duesPaySaveBtn.addEventListener("click", saveDuesPay);
if(duesPayCancelBtn) duesPayCancelBtn.addEventListener("click", cancelDuesPay);
  
function resetProposalForm(){
  if(!pTitle) return;
  forumError.style.display = "none";
  pTitle.value = "";
  pBody.value = "";
}
function forumInit(bid){
  if(!forumList) return;
  renderForum(bid, CURRENT_QUERY);
  resetProposalForm();
}
if(createProposalBtn){
  createProposalBtn.addEventListener("click", () => {
    forumError.style.display = "none";

    const bid = activeBid();
    if(!bid){
      forumError.textContent = "Nije izabrana zgrada.";
      forumError.style.display = "block";
      return;
    }

    if(!CURRENT_SESSION || CURRENT_SESSION.role !== "stanar"){
      forumError.textContent = "Nemate dozvolu.";
      forumError.style.display = "block";
      return;
    }

    const title = (pTitle.value||"").trim();
    const body = (pBody.value||"").trim();

    if(!title || !body){
      forumError.textContent = "Gre≈°ka: popuni naslov i opis.";
      forumError.style.display = "block";
      return;
    }

const now = Date.now();

const proposal = {
  id: cryptoRandom(),
  createdAt: now,
  expiresAt: now + 1000 * 60 * 60 * 24 * 30, // 30 dana
  title,
  body,
  createdBy: CURRENT_SESSION.username,

  // ‚úÖ AUTOMATSKA ANKETA (srpsko: DA / NE)
  poll: {
    enabled: true,
    endsAt: now + 1000 * 60 * 60 * 24 * 30,
    da: [],
    ne: []
  }
};
    
   const items = loadProposals(bid);
    items.push(proposal);
    saveProposals(bid, items);

    resetProposalForm();
    renderForum(bid, CURRENT_QUERY);
    renderSearchDropdown(CURRENT_QUERY);
    updateHomeSummary();
  });
}
  
if(clearProposalBtn){
  clearProposalBtn.addEventListener("click", resetProposalForm);
}

/* ================= GLOBAL SEARCH ================= */
function tagForPage(page){
  if(page === "finansije") return "Finansije";
  if(page === "oglasna") return "Oglasna";
  if(page === "forum") return "Forum";
  if(page === "regulative") return "Regulative";
  if(page === "kontakt") return "Kontakt";
  return "Rezultat";
}
function ensureStaticSids(){
  if(regList){
    [...regList.querySelectorAll("li")].forEach((li, idx) => {
      if(!li.dataset.sid) li.dataset.sid = "reg:" + idx;
    });
  }
  if(kontaktList){
    [...kontaktList.querySelectorAll("li")].forEach((li, idx) => {
      if(!li.dataset.sid) li.dataset.sid = "kon:" + idx;
    });
  }
}
function buildSearchHits(q){
  const bid = activeBid();
  const qq = norm(q);
  if(!qq || !bid) return [];

  const hits = [];

  // finansije (samo aktivna zgrada)
  try{
    const items = loadItems(bid).slice().sort((a,b) => (b.date||"").localeCompare(a.date||""));
    for(const it of items){
      if(financeMatches(it, qq)){
        const firmPart = it.firm ? (" ‚Äî " + it.firm) : "";
        hits.push({
          page: "finansije",
          sid: "fin:" + it.id,
          text: `${it.date} ‚Äî ${it.type === "rashod" ? "Rashod" : "Prihod"} ‚Äî ${it.category}${firmPart}`,
          sub: `"${it.desc}" ‚Äî ${formatRSD(it.amount)} RSD`
        });
      }
    }
  }catch{}

  // oglasna
  try{
    const posts = loadBoardPosts(bid).slice().sort((a,b) => (b.date||"").localeCompare(a.date||""));
    for(const p of posts){
      if(boardMatches(p, qq)){
        hits.push({
          page: "oglasna",
          sid: "brd:" + p.id,
          text: `${p.date} ‚Äî ${p.title}`,
          sub: p.desc || ""
        });
      }
    }
  }catch{}

  // forum
  try{
    const props = loadProposals(bid).slice().sort((a,b) => (b.createdAt||0)-(a.createdAt||0));
    for(const p of props){
      if(forumMatches(p, qq)){
        hits.push({
          page: "forum",
          sid: "frm:" + p.id,
          text: p.title,
          sub: p.body
        });
      }
    }
  }catch{}

  // regulative (static)
  if(regList){
    [...regList.querySelectorAll("li")].forEach(li => {
      if(includesQuery(li.textContent, qq)){
        hits.push({ page:"regulative", sid: li.dataset.sid || "", text: li.textContent, sub:"" });
      }
    });
  }

  // kontakt (static)
  if(kontaktList){
    [...kontaktList.querySelectorAll("li")].forEach(li => {
      if(includesQuery(li.textContent, qq)){
        hits.push({ page:"kontakt", sid: li.dataset.sid || "", text: li.textContent, sub:"" });
      }
    });
  }

  return hits.slice(0, 12);
}
function renderSearchDropdown(q){
  if(!searchResults) return;

  const qq = norm(q);
  if(!qq){
    searchResults.style.display = "none";
    searchResults.innerHTML = "";
    return;
  }

  const hits = buildSearchHits(qq);

  if(!hits.length){
    searchResults.innerHTML = `
      <div class="srHead">Rezultati</div>
      <div class="srItem" style="cursor:default;">
        <div class="srText">Nema rezultata za ‚Äú${q}‚Äù.<div class="srSub">Probaj drugi pojam (npr. ‚Äúkrov‚Äù, ‚Äúlift‚Äù, ‚Äú193‚Äù).</div></div>
      </div>
    `;
    searchResults.style.display = "block";
    return;
  }

  const grouped = new Map();
  for(const h of hits){
    const key = h.page;
    if(!grouped.has(key)) grouped.set(key, []);
    grouped.get(key).push(h);
  }

  let html = `<div class="srHead">Rezultati za ‚Äú${q}‚Äù</div>`;
  const order = ["finansije","oglasna","forum","regulative","kontakt"];

  for(const page of order){
    const arr = grouped.get(page);
    if(!arr || !arr.length) continue;

    const slice = arr.slice(0, 3);
    for(const item of slice){
      html += `
        <div class="srItem" data-page="${item.page}" data-sid="${item.sid}">
          <div class="srTag">${tagForPage(item.page)}</div>
          <div class="srText">
            ${item.text}
            ${item.sub ? `<div class="srSub">${item.sub}</div>` : ``}
          </div>
        </div>
      `;
    }
  }

  searchResults.innerHTML = html;
  searchResults.style.display = "block";
}
function applySearchFilter(){
  const bid = activeBid();
  if(!bid) return;

  renderFinanceList(bid, CURRENT_QUERY);

  bindAdminFinSwitch();

  // ‚úÖ admin panel: stanovi + zgrade
  renderAdminUnits(bid);
  renderAdminBuildings();

  renderBoard(bid, CURRENT_QUERY);
  renderForum(bid, CURRENT_QUERY);
}
function scrollToSid(sid){
  if(!sid) return;
  const el = document.querySelector(`[data-sid="${sid}"]`);
  if(!el) return;

  el.scrollIntoView({ behavior:"smooth", block:"center" });
  el.classList.add("searchHitFlash");
  setTimeout(() => el.classList.remove("searchHitFlash"), 1200);
}

  function goToHit(page, sid){
  // ‚úÖ samo stanar ima read/unread
  if(CURRENT_SESSION?.role === "stanar" && sid){
    const bid = activeBid();
    const kind = kindFromSid(sid);
    const id = idFromSid(sid);

    if(bid && kind && id){
      markRead(bid, kind, id);
      updateHomeSummary(); // skini NOVO odmah
    }
  }

  showPage(page);

  setTimeout(() => {
    applySearchFilter();
    setTimeout(() => scrollToSid(sid), 60);
  }, 60);

  if(searchResults) searchResults.style.display = "none";
}

  function bindHomeShortcuts(){
  const map = [
    document.getElementById("homeLastChange"),
    document.getElementById("homePinned"),
    document.getElementById("homeForum")
  ];

  map.forEach(el => {
    if(!el) return;
    el.addEventListener("click", () => {
      const page = el.dataset.page || "";
      const sid  = el.dataset.sid  || "";
      if(page && sid) goToHit(page, sid);
    });
  });
}
  
if(globalSearch){
  globalSearch.addEventListener("input", () => {
    CURRENT_QUERY = (globalSearch.value || "").trim();
    applySearchFilter();
    renderSearchDropdown(CURRENT_QUERY);
  });

  globalSearch.addEventListener("focus", () => {
    renderSearchDropdown((globalSearch.value || "").trim());
  });

  globalSearch.addEventListener("keydown", (e) => {
    if(e.key === "Escape"){
      if(searchResults) searchResults.style.display = "none";
    }
  });
}
if(searchResults){
  searchResults.addEventListener("click", (e) => {
    const row = e.target.closest(".srItem");
    if(!row) return;
    const page = row.getAttribute("data-page");
    const sid  = row.getAttribute("data-sid");
    if(page) goToHit(page, sid);
  });
}
document.addEventListener("click", (e) => {
  if(!searchResults || !globalSearch) return;
  const wrap = globalSearch.closest(".searchInline");
  if(wrap && wrap.contains(e.target)) return;
  searchResults.style.display = "none";
});

/* ===== refresh modules for active building ===== */
function refreshAllModules(){
  const bid = activeBid();
  if(!bid) return;

  financeInit(bid);
  renderDuesAdmin();
  forumInit(bid);
  boardInit(bid);
renderDuesTenant(bid);
  renderTenantFinanceHeaderBadge(bid);

  // refresh filtered view
  applySearchFilter();
  renderSearchDropdown(CURRENT_QUERY);
  updateHomeSummary();
  refreshBalanceUI(bid); /* ‚úÖ IZMENJENO */

// ‚úÖ MESEƒåNI UPLOAD: osve≈æi badge-ove
  updateMonthlyUploadUI(false);
  updateMonthlyUploadUI(true);
}

/* ===== home summary ===== */
function updateHomeSummary(){
  const bid = activeBid();
  if(!bid) return;

  // ---------- FINANSIJE (Poslednja promena) ----------
  const fin = loadItems(bid).slice().sort((a,b) => (b.date||"").localeCompare(a.date||""));
  if(fin.length){
    const it = fin[0];
    const sid = "fin:" + it.id;

    const unread = (CURRENT_SESSION?.role === "stanar") && !isRead(bid, "fin", it.id);

    homeLastChange.innerHTML =
      `Poslednja promena: ${it.type === "rashod" ? "Rashod" : "Prihod"} - ${it.category} (${formatDateDMY(it.date)})` +
      (unread ? ` <span class="unreadBadge">NOVO</span>` : ``);

    homeLastChange.dataset.page = "finansije";
    homeLastChange.dataset.sid  = sid;
  }else{
    homeLastChange.textContent = "Poslednja promena: (nema)";
    homeLastChange.dataset.page = "";
    homeLastChange.dataset.sid  = "";
  }

  // ---------- OGLASNA (Istaknuto) ----------
  const brd = loadBoardPosts(bid).slice().sort((a,b) => (b.date||"").localeCompare(a.date||""));
  if(brd.length){
    const p = brd[0];
    const sid = "brd:" + p.id;

    const unread = (CURRENT_SESSION?.role === "stanar") && !isRead(bid, "brd", p.id);

    homePinned.innerHTML =
      `Istaknuto: ${p.title} (${formatDateDMY(p.date)})` +
      (unread ? ` <span class="unreadBadge">NOVO</span>` : ``);

    homePinned.dataset.page = "oglasna";
    homePinned.dataset.sid  = sid;
  }else{
    homePinned.textContent = "Istaknuto: (nema)";
    homePinned.dataset.page = "";
    homePinned.dataset.sid  = "";
  }

  // ---------- FORUM ----------
  const frm = loadProposals(bid).slice().sort((a,b) => (b.createdAt||0)-(a.createdAt||0));
  if(frm.length){
    const f = frm[0];
    const sid = "frm:" + f.id;

    const unread = (CURRENT_SESSION?.role === "stanar") && !isRead(bid, "frm", f.id);

    homeForum.innerHTML =
      `Forum: ${f.title}` +
      (unread ? ` <span class="unreadBadge">NOVO</span>` : ``);

    homeForum.dataset.page = "forum";
    homeForum.dataset.sid  = sid;
  }else{
    homeForum.textContent = "Forum: (nema)";
    homeForum.dataset.page = "";
    homeForum.dataset.sid  = "";
  }
}
  
/* INIT */
(function init(){
  ensureStaticSids();

  const session = getSession();
  if(session && session.username && session.role){
    CURRENT_SESSION = session;
    userPill.textContent = session.username;
    applyRoleUI(session.role);

    if(!CURRENT_SESSION.activeBuildingId){
      if(CURRENT_SESSION.role === "stanar"){
        CURRENT_SESSION.activeBuildingId = (CURRENT_SESSION.buildings || [])[0] || null;
        saveSession(CURRENT_SESSION);
        enterPortal();
      }else{
        if((CURRENT_SESSION.buildings || []).length > 1){
          showBuildingSelect();
        }else{
          CURRENT_SESSION.activeBuildingId = (CURRENT_SESSION.buildings || [])[0] || null;
          saveSession(CURRENT_SESSION);
          enterPortal();
        }
      }
      return;
    }

    enterPortal();
  }else{
    CURRENT_SESSION = null;
    applyRoleUI("stanar");
    setMode("login");
    loadLoginCreds();
  }
})();

/* =========================
   STATISTIKA - SR mesec/godina picker
   (radi sa hidden input #uplMonthPick kao YYYY-MM)
========================= */
(function initSrMonthPicker(){
  const monthSel = document.getElementById("uplMonthMonth");
  const yearSel  = document.getElementById("uplMonthYear");
  const applyBtn = document.getElementById("uplMonthApply");
  const hidden   = document.getElementById("uplMonthPick");
  const hint     = document.getElementById("uplMonthHint");

  if(!monthSel || !yearSel || !applyBtn || !hidden) return;

  // 1) Napuni godine (npr poslednjih 5 + sledeƒáih 1)
  const now = new Date();
  const thisYear = now.getFullYear();
  const startY = thisYear - 5;
  const endY   = thisYear + 1;

  // Ako select godina nema opcije ili nema dovoljno, popuni
  if (yearSel.options.length <= 1) {
    yearSel.innerHTML = '<option value="">Godina</option>';
    for(let y = endY; y >= startY; y--){
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      yearSel.appendChild(opt);
    }
  }

  // 2) Postavi default na trenutni mesec/godinu
  const mm = String(now.getMonth() + 1).padStart(2,"0");
  monthSel.value = mm;
  yearSel.value = String(thisYear);

  function updateHiddenAndTrigger(){
    const m = monthSel.value;
    const y = yearSel.value;

    if(!m || !y){
      if(hint) hint.textContent = "Izaberi mesec i godinu";
      return;
    }

    hidden.value = `${y}-${m}`;

    // okini change event da postojeƒái kod preradi statistiku
    hidden.dispatchEvent(new Event("change", { bubbles:true }));

    if(hint) hint.textContent = `Izabrano: ${m}.${y}`;
  }

  applyBtn.addEventListener("click", updateHiddenAndTrigger);

  // opcionalno: kada promeni mesec/godinu odmah upi≈°i hint
  monthSel.addEventListener("change", () => { if(hint) hint.textContent = "Klikni Primeni"; });
  yearSel.addEventListener("change", () => { if(hint) hint.textContent = "Klikni Primeni"; });

  // inicijalno pokreni odmah
  updateHiddenAndTrigger();
})();

  /* =========================
   SIDEBAR LOGOUT
========================= */

const sidebarLogout = document.getElementById("sidebarLogout");

if (sidebarLogout) {
  sidebarLogout.addEventListener("click", (e) => {
    e.preventDefault();

    // (opciono) potvrda
    // if (!confirm("Da li ste sigurni da ≈æelite da se odjavite?")) return;

    clearSessions();
    CURRENT_SESSION = null;
    closeS();
    setMode("login");
  });
}

function formatDateDMY(dateStr){
  if(!dateStr) return "";
  const [y, m, d] = dateStr.split("-");
  return `${d}.${m}.${y}`;
}

  
function renderUserBadge(){
  const el = document.getElementById("userBadge");
  if(!el || !CURRENT_SESSION) return;

  // Prika≈æi taƒçno korisniƒçko ime (npr. NC28-003)
  el.textContent = CURRENT_SESSION.username || "";
}

  // ================= ADMIN STATISTIKA: zatvaranje dropdowna klikom van =================
document.addEventListener("click", (e) => {
  const wrap = document.querySelector("#page-statistika .adminTopWrap");
  const menu = document.getElementById("adminBuildingMenuFin");
  const input = document.getElementById("uplAdminSearchFin");

  if(!menu) return;

  // klik unutar inputa ili dropdowna -> ne zatvaramo
  if(
    (wrap && wrap.contains(e.target)) ||
    (input && input.contains(e.target)) ||
    menu.contains(e.target)
  ) return;

  // klik van -> zatvori
  menu.classList.add("hidden");
});

// ================= ADMIN STATISTIKA: otvori/sakrij dropdown po unosu =================
(() => {
  const input = document.getElementById("uplAdminSearchFin");
  const menu  = document.getElementById("adminBuildingMenuFin");
  if(!input || !menu) return;

  // kad klikne≈° u input: ako veƒá ima ne≈°to ukucano, prika≈æi listu
  input.addEventListener("focus", () => {
    if(input.value.trim().length) menu.classList.remove("hidden");
  });

  // dok kuca≈°: ako ima teksta -> poka≈æi, ako je prazno -> sakrij
  input.addEventListener("input", () => {
    const q = input.value.trim();
    if(q.length){
      menu.classList.remove("hidden");
      // tvoja funkcija koja renderuje/filteruje zgrade
      // ako se kod tebe zove drugaƒçije, zameni ovu liniju:
      if(typeof renderForQuery === "function") renderForQuery(q);
    }else{
      menu.classList.add("hidden");
    }
  });
})();

// ================= ADMIN STATISTIKA: klik na "Otvori" -> zatvori dropdown =================
(() => {
  const menu  = document.getElementById("adminBuildingMenuFin");
  const input = document.getElementById("uplAdminSearchFin");
  if(!menu) return;

  menu.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if(!btn) return;

    // Ako je klik na bilo koji button u meniju (npr. "Otvori"), zatvori dropdown
    menu.classList.add("hidden");

    // (opciono) skini fokus sa inputa da se ne otvori odmah opet
    if(input) input.blur();
  });
})();

  
</script>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Supabase init -->
<script>
  const SUPABASE_URL = "https://bkzczqnbeomvshqplrho.supabase.co";
  const SUPABASE_KEY = "sb_publishable_mPQn0h5Ixgyg5WQFsJk38A_qqE2kPb7";

  const supabaseClient = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
  );

  // samo za proveru
  console.log("Supabase connected:", supabaseClient);
</script>

























































