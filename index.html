<!DOCTYPE html>
<html lang="sr-Latn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Portal Upravnik</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<style>
:root{
  --bg-url: url("bg.png");

  --sidebar-w: min(340px, 50vw);
--edge-w: 0px;

  --main-pad: 18px;

  --ink:#0f172a;
  --muted:rgba(15,23,42,.65);
  --glass:rgba(248,250,252,.92);
  --border:rgba(15,23,42,.14);
  --shadow:0 18px 40px rgba(2,6,23,.10);

  --side1:rgba(10,35,56,.92);
  --side2:rgba(6,24,40,.92);
}
@media(min-width:900px){
  :root{ --main-pad: 52px; }
}
  
/* ===== SIDEBAR LOGOUT ===== */
.nav .logoutItem{
  margin-top: auto;
  background: rgba(220, 38, 38, .12);
  border: 1px solid rgba(220, 38, 38, .45);
  color: #fecaca;
  font-weight: 900;
  letter-spacing: .04em;
  text-align: center;
}

.nav .logoutItem:hover{
  background: rgba(220, 38, 38, .22);
  box-shadow: 0 0 0 4px rgba(220, 38, 38, .18);
}


*{margin:0;padding:0;box-sizing:border-box;font-family:"Inter",system-ui,Arial,sans-serif}

body{
  min-height:100vh;
  background: var(--bg-url) center/cover no-repeat fixed;
  color: var(--ink);
  overflow-x:hidden;
}

body::before{
  content:"";
  position:fixed;
  inset:0;
  background: rgba(255,255,255,.22);
  backdrop-filter: blur(1.4px);
  filter: contrast(1.35) saturate(1.25);
  z-index:-2;
}

/* ambient blobs */
.ambient{
  position:fixed;
  inset:-20%;
  z-index:-1;
  pointer-events:none;
  background:
    radial-gradient(600px 380px at 18% 22%, rgba(59,130,246,.22), transparent 60%),
    radial-gradient(620px 420px at 82% 26%, rgba(14,165,233,.18), transparent 60%),
    radial-gradient(720px 520px at 50% 84%, rgba(15,23,42,.12), transparent 62%);
  filter: blur(2px);
}

/* TOP RIGHT */
.topRightBar{
  position:absolute;
  top:calc(10px + env(safe-area-inset-top));
  right:calc(var(--main-pad) + env(safe-area-inset-right));
  display:flex;
  align-items:center;
  gap:12px;
  z-index:95;
  pointer-events:none;
}
.topRightTitle{
  text-align:left;
  font-weight:900;
  line-height:1.05;
}
.topRightTitle span{
  display:block;
  font-size:18px;
}
.topRightLogo{
  padding:6px;
  background:rgba(255,255,255,.72);
  border:1px solid var(--border);
  border-radius:22px;
  box-shadow:var(--shadow);
}
.topRightLogo img{
  height:56px;
  width:auto;
  display:block;
  border-radius:16px;
}
@media(min-width:900px){
  .topRightTitle span{font-size:22px;}
  .topRightLogo img{height:92px;}
}

/* SCREENS */
.loginWrap{
  min-height:100vh;
  display:grid;
  place-items:center;
  padding:24px var(--main-pad);
}

.loginCard{
  width:min(560px, 100%);
  border-radius:30px;
  background:rgba(255,255,255,.90);
  border:1px solid rgba(15,23,42,.14);
  box-shadow:var(--shadow);
  padding:22px;
  position:relative;
  overflow:hidden;
}
.loginCard::before{
  content:"";
  position:absolute;
  inset:-2px;
  background:
    radial-gradient(520px 320px at 22% 18%, rgba(59,130,246,.14), transparent 60%),
    radial-gradient(520px 320px at 86% 18%, rgba(14,165,233,.10), transparent 60%);
  pointer-events:none;
}
.loginInner{position:relative; z-index:1;}

.loginHead{
  padding-bottom:12px;
  border-bottom:1px solid rgba(15,23,42,.10);
}
.formTitle{
  margin:0;
  font-weight:900;
  font-size:26px;
  letter-spacing:.02em;
}
.formSub{
  margin-top:12px;
  color:var(--muted);
  font-weight:700;
  font-size:13px;
  line-height:1.4;
}

.field{ margin-top:12px; }
.field label{
  display:block;
  font-size:12px;
  font-weight:900;
  letter-spacing:.12em;
  text-transform:uppercase;
  opacity:.7;
  margin-bottom:6px;
}
.inputWrap{ position:relative; }
.field input, .field select, .field textarea{
  width:100%;
  border-radius:18px;
  border:1px solid rgba(15,23,42,.14);
  background:rgba(255,255,255,.94);
  padding:14px 14px;
  font-size:15px;
  outline:none;
  transition:.15s;
}
.field textarea{min-height:86px; resize:vertical;}
.field input:focus, .field select:focus, .field textarea:focus{
  border-color:rgba(15,23,42,.28);
  box-shadow:0 0 0 5px rgba(15,23,42,.06);
}

.eyeBtn{
  position:absolute;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  border:none;
  background:rgba(15,23,42,.06);
  border:1px solid rgba(15,23,42,.14);
  border-radius:14px;
  padding:8px 10px;
  cursor:pointer;
  font-weight:900;
  user-select:none;
}

.row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-top:12px;
  flex-wrap:wrap;
}
.check{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:800;
  color:rgba(15,23,42,.75);
  font-size:13px;
}
.check input{width:18px;height:18px}

.btnRow{ display:flex; gap:10px; margin-top:14px; }
.btn{
  flex:1;
  border:none;
  cursor:pointer;
  border-radius:18px;
  padding:14px 16px;
  font-weight:900;
  letter-spacing:.02em;
  transition:.15s;
}
.btnPrimary{
  background:rgba(15,23,42,.92);
  color:white;
  box-shadow:0 18px 36px rgba(2,6,23,.18);
}
.btnPrimary:hover{ transform:translateY(-1px); }
.btnGhost{
  background:rgba(255,255,255,.72);
  border:1px solid rgba(15,23,42,.14);
  box-shadow:var(--shadow);
  color:rgba(15,23,42,.92);
}
.error{
  margin-top:10px;
  font-weight:900;
  color:#9f1239;
  display:none;
}
.miniHint{
  margin-top:10px;
  font-weight:800;
  color:rgba(15,23,42,.62);
  font-size:12px;
  line-height:1.4;
}

/* overlay + hover zona (PORTAL) */
.overlay{
  position:fixed; inset:0;
  background:rgba(2,6,23,.25);
  opacity:0; pointer-events:none;
  transition:.2s;
  z-index:40;
}
.overlay.show{opacity:1;pointer-events:auto}
.edgeHotspot{
  position:fixed; left:0; top:0;
  width:var(--edge-w); height:100vh;
  z-index:60;
}

/* SIDEBAR */
.sidebar{
  position:fixed; left:0; top:0;
  width:var(--sidebar-w); height:100vh;
  padding:16px 20px;
  background:linear-gradient(180deg,var(--side1),var(--side2)),var(--bg-url);
  background-size:cover;
  color:#fff;
  box-shadow:18px 0 40px rgba(0,0,0,.28);
  transform:translateX(-100%);
  transition:.2s;
  z-index:70;
}
.sidebar.open{transform:translateX(0)}
body:not(.sidebar-open) .sidebar{ filter: brightness(1.20); }
body.sidebar-open .sidebar{ filter:none; }
.sidebar::before{
  content:"";
  position:absolute; inset:0;
  background:rgba(0,0,0,.22);
  backdrop-filter:blur(8px);
}
.sidebar>*{position:relative;z-index:1}

.brand{height:92px}
.brand h1{font-size:24px;font-weight:900;letter-spacing:.16em}
.brand p{font-size:13px;opacity:.78;margin-top:8px}

.nav{margin-top:26px;display:flex;flex-direction:column;gap:12px}
.nav a{
  padding:16px 18px;
  border-radius:18px;
  color:#fff;
  text-decoration:none;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.14);
  font-size:19px;
  font-weight:700;
  display:block;
}
.nav a.active{background:rgba(255,255,255,.14)}

  /* ‚úÖ PREMIUM STATISTIKA BUTTON (plavi gradient + glow) */
.nav a[data-page="statistika"]{
  position: relative;
  overflow: hidden;

  background: linear-gradient(135deg,
    rgba(59,130,246,.35),
    rgba(14,165,233,.22)
  );
  border: 1px solid rgba(147,197,253,.65);
  box-shadow:
    0 18px 40px rgba(37, 99, 235, .22),
    0 6px 14px rgba(2, 6, 23, .22);

  font-weight: 900;
  letter-spacing: .02em;
}

/* shine / svetlucanje */
.nav a[data-page="statistika"]::before{
  content:"";
  position:absolute;
  inset:-2px;
  background: radial-gradient(260px 120px at 15% 25%,
    rgba(255,255,255,.22),
    transparent 60%
  );
  pointer-events:none;
}

/* mala linija sa leve strane (premium bar) */
.nav a[data-page="statistika"]::after{
  content:"";
  position:absolute;
  left:10px;
  top:50%;
  transform:translateY(-50%);
  width:6px;
  height:60%;
  border-radius:999px;
  background: linear-gradient(180deg,
    rgba(191,219,254,.95),
    rgba(59,130,246,.95)
  );
  box-shadow: 0 0 18px rgba(59,130,246,.45);
  pointer-events:none;
}

/* hover efekat */
.nav a[data-page="statistika"]:hover{
  transform: translateY(-1px);
  background: linear-gradient(135deg,
    rgba(59,130,246,.45),
    rgba(14,165,233,.30)
  );
  box-shadow:
    0 22px 50px rgba(37, 99, 235, .30),
    0 8px 16px rgba(2, 6, 23, .25);
}

/* active (kada si u statistici) */
.nav a[data-page="statistika"].active{
  background: linear-gradient(135deg,
    rgba(59,130,246,.72),
    rgba(14,165,233,.55)
  );
  border-color: rgba(191,219,254,.95);
  box-shadow:
    0 26px 60px rgba(37, 99, 235, .36),
    0 10px 20px rgba(2, 6, 23, .28);
}


/* hamburger */
.hamburger{
  position:fixed;
  left:18px; top:18px;
  width:56px; height:56px;
  border-radius:17px;
  background:var(--glass);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  display:grid; place-items:center;
  cursor:pointer;
  z-index:80;
  user-select:none;
}

/* MAIN */
.main{ padding:0 var(--main-pad) 22px; }
.contentWrap{ padding-top:calc(86px + 14px); }
@media(min-width:900px){
  .contentWrap{padding-top:calc(120px + 14px);}
}
.pageHeader{
  display:flex;
  justify-content:space-between;
  gap:14px;
  margin-bottom:18px;
}
.leftInfo{max-width:52vw}
.meta{
  font-size:18px;
  color:rgba(15,23,42,.62);
  font-weight:600;
  line-height:1.28;
}
.rightCol{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:10px;
}

.searchInline,
.balanceCard{
  width:clamp(180px,42vw,300px);
  border-radius:18px;
  background:var(--glass);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
}

.searchInline{ padding:10px 14px; }
.searchInline input{
  border:none;
  background:transparent;
  width:100%;
  outline:none;
  font-size:14px;
}

/* stanje */
.balanceCard{
  padding:12px;
  text-align:right;
}
.balanceCard .label{
  font-size:12px;
  font-weight:700;
  display:block;
  margin-bottom:6px;
}
.balanceAmount{ white-space:nowrap; }
.balanceAmount .value{
  font-size:20px;
  font-weight:900;
  letter-spacing:0.2px;
}
.balanceAmount .currency{
  font-size:11px;
  font-weight:700;
  opacity:.55;
  margin-left:4px;
}

@media(min-width:900px){
  .meta{font-size:26px;}
  .balanceAmount .value{font-size:25px;}
  .balanceAmount .currency{font-size:13px;}
  .balanceCard{padding:18px;}
}
/* MOBILE FIX ‚Äì veliki iznosi da ne izlaze iz kartice */
@media (max-width: 520px){
  .balanceCard{ overflow:hidden; }
  .balanceAmount{ white-space: normal; }
  .balanceAmount .value{ font-size: 18px; }
}

/* cards */
.card{
  background:rgba(248,250,252,.86);
  border-radius:26px;
  padding:22px;
  box-shadow:var(--shadow);
}
.card h3{
  text-transform:uppercase;
  letter-spacing:.16em;
  font-size:22px;
  font-weight:900;
}
@media(min-width:900px){
  .card{padding:28px;}
  .card h3{font-size:26px;}
}

.boardList{
  margin-top:14px;
  list-style:none;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.boardList li{
  background:rgba(15,23,42,.06);
  border:1px solid rgba(15,23,42,.10);
  padding:12px 14px;
  border-radius:16px;
  font-weight:700;
}

.smallText{
  margin-top:10px;
  font-weight:700;
  color:rgba(15,23,42,.65);
  line-height:1.45;
}

/* pills */
.topMini{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.pill{
  border-radius:999px;
  padding:10px 12px;
  background:rgba(255,255,255,.72);
  border:1px solid rgba(15,23,42,.14);
  box-shadow:var(--shadow);
  font-weight:900;
  font-size:13px;
  user-select:none;
}
.pillBtn{ cursor:pointer; }

/* pages switch */
.page{ display:none; }
.page.active{ display:block; }

/* badge */
.badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  border:1px solid rgba(15,23,42,.14);
  background:rgba(255,255,255,.72);
  box-shadow:var(--shadow);
}

/* simple row */
.fRow{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:flex-start;
}
.fRow .grow{flex:1; min-width:220px;}
.fRow .half{flex:1; min-width:220px;}

/* files list */
.fileList{
  margin-top:10px;
  list-style:none;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.fileList li{
  background:rgba(15,23,42,.06);
  border:1px solid rgba(15,23,42,.10);
  padding:10px 12px;
  border-radius:14px;
  font-weight:800;
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.fileList small{opacity:.7; font-weight:900;}

/* mode switching */
body.mode-login #portalScreen,
body.mode-login #buildingSelectScreen{display:none;}
body.mode-buildingSelect #loginScreen,
body.mode-buildingSelect #portalScreen{display:none;}
body.mode-portal #loginScreen,
body.mode-portal #buildingSelectScreen{display:none;}
body.mode-portal #portalScreen{display:block;}

/* Global search dropdown */
.searchResults{
  position:absolute;
  left:10px;
  right:10px;
  top:calc(100% + 10px);
  z-index:999;
  border-radius:18px;
  background:rgba(255,255,255,.92);
  border:1px solid rgba(15,23,42,.14);
  box-shadow:0 18px 40px rgba(2,6,23,.12);
  overflow:hidden;
  backdrop-filter: blur(6px);
}
.searchResults .srHead{
  padding:10px 12px;
  font-weight:900;
  font-size:12px;
  letter-spacing:.12em;
  text-transform:uppercase;
  color:rgba(15,23,42,.70);
  background:rgba(15,23,42,.04);
  border-bottom:1px solid rgba(15,23,42,.10);
}
.searchResults .srItem{
  padding:10px 12px;
  cursor:pointer;
  display:flex;
  gap:10px;
  align-items:flex-start;
  border-bottom:1px solid rgba(15,23,42,.08);
}
.searchResults .srItem:last-child{ border-bottom:none; }
.searchResults .srItem:hover{ background:rgba(15,23,42,.05); }
.searchResults .srTag{
  flex:0 0 auto;
  font-weight:900;
  font-size:11px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(15,23,42,.14);
  background:rgba(255,255,255,.72);
  color:rgba(15,23,42,.85);
  white-space:nowrap;
}
.searchResults .srText{
  flex:1;
  font-weight:800;
  color:rgba(15,23,42,.88);
  line-height:1.25;
  font-size:13px;
}
.searchResults .srSub{
  margin-top:4px;
  font-weight:700;
  color:rgba(15,23,42,.60);
  font-size:12px;
}

.searchHitFlash{
  outline:3px solid rgba(59,130,246,.55);
  box-shadow:0 0 0 6px rgba(59,130,246,.14);
  transition:.2s;
  animation: srFlash .9s ease-in-out 1;
}
@keyframes srFlash{
  0%{ transform:scale(1); }
  50%{ transform:scale(1.01); }
  100%{ transform:scale(1); }
}
body.sidebar-open .hamburger{
  opacity: 0;
  pointer-events: none;
}

/* building select list */
.pickList{
  margin-top:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.pickBtn{
  width:100%;
  text-align:left;
  border:none;
  cursor:pointer;
  border-radius:18px;
  padding:14px 14px;
  background:rgba(255,255,255,.92);
  border:1px solid rgba(15,23,42,.14);
  box-shadow:var(--shadow);
}
.pickBtn .t{font-weight:900;}
.pickBtn .s{margin-top:4px; font-weight:800; color:rgba(15,23,42,.62); font-size:12px; line-height:1.3;}

  /* Finansije: stavke koje imaju uploadovane dokumente -> PLAVO */
/* FINANSIJE: samo PDF fajlovi (donji deo) da budu PLAVI */
#financeList .fileList li,
#financeList .fileList li span,
#financeList .fileList li small{
  color:#1d4ed8;
  font-weight:900;
}

/* FINANSIJE: samo PDF fajlovi (donji deo) da budu PLAVI */
#financeList .fileList li,
#financeList .fileList li span,
#financeList .fileList li small{
  color:#1d4ed8;
  font-weight:900;
}

/* ===== STATISTIKA ‚Äì uredjen layout ===== */
.statsGrid{
  margin-top:12px;
  display:grid;
  grid-template-columns: 1fr;
  gap:12px;
}

@media(min-width:900px){
  .statsGrid{
    grid-template-columns: 1fr 1fr;
  }
  .statsGrid .span2{ grid-column: 1 / -1; }
}

.statsCard{
  background: rgba(255,255,255,.72);
  border: 1px solid rgba(15,23,42,.14);
  border-radius: 20px;
  box-shadow: var(--shadow);
  padding: 14px;
}

.statsHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}

.statsTitle{
  font-weight: 900;
  letter-spacing:.08em;
  text-transform: uppercase;
  font-size: 13px;
  opacity:.85;
}

.statsRow{
  display:grid;
  grid-template-columns: 1fr auto;
  gap:10px;
  align-items:center;
  padding:10px 0;
  border-top:1px solid rgba(15,23,42,.08);
}

.statsRow:first-of-type{ border-top:none; padding-top:0; }

.statsLabel{
  font-weight:800;
  color: rgba(15,23,42,.78);
  font-size: 13px;
}

.statsValue{
  font-weight:900;
  font-size: 14px;
  padding:6px 10px;
  border-radius:999px;
  background: rgba(15,23,42,.06);
  border: 1px solid rgba(15,23,42,.10);
  white-space:nowrap;
}

.statsPicker{
  display:flex;
  gap:10px;
  align-items:flex-end;
  flex-wrap:wrap;
  margin-top:12px;
}

.statsPicker .field{ margin-top:0; }
.statsPicker .field input{ border-radius: 16px; }

  
  /* ====== DARKEN WHITE CARDS (soft, for eyes) ====== */
:root{
  --glass: rgba(241,245,249,.78); /* manje belo */
}

/* sve glavne kartice */
.card{
  background: rgba(241,245,249,.72) !important;
  border: 1px solid rgba(15,23,42,.18) !important;
}

/* login + building select kartice */
.loginCard{
  background: rgba(241,245,249,.82) !important;
  border: 1px solid rgba(15,23,42,.18) !important;
}

/* search, balance, hamburger, pill */
.searchInline,
.balanceCard{
  background: rgba(241,245,249,.72) !important;
  border: 1px solid rgba(15,23,42,.18) !important;
}

/* pill (Korisnik/Zgrada/Odjava) */
.pill{
  background: rgba(241,245,249,.70) !important;
  border: 1px solid rgba(15,23,42,.18) !important;
}

/* dropdown rezultati pretrage */
.searchResults{
  background: rgba(241,245,249,.92) !important;
  border: 1px solid rgba(15,23,42,.18) !important;
}

/* izbor zgrade */
.pickBtn{
  background: rgba(241,245,249,.85) !important;
  border: 1px solid rgba(15,23,42,.18) !important;
}

  /* ===== STATISTIKA: pregledniji raspored ===== */
.statsGrid{
  display:grid;
  grid-template-columns: 1fr;
  gap:12px;
  margin-top:12px;
}
@media(min-width:900px){
  .statsGrid{ grid-template-columns: 1fr 1fr; }
}

.statsCard{
  background: rgba(255,255,255,.82);
  border: 1px solid rgba(15,23,42,.12);
  border-radius: 18px;
  box-shadow: var(--shadow);
  padding: 14px;
}

.statsCard h4{
  margin:0 0 10px;
  font-size: 13px;
  font-weight: 900;
  letter-spacing: .12em;
  text-transform: uppercase;
  color: rgba(15,23,42,.75);
}

.statsRows{
  display:grid;
  gap:8px;
}

.statRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:10px 12px;
  border-radius: 14px;
  background: rgba(15,23,42,.05);
  border: 1px solid rgba(15,23,42,.08);
}

.statRow .k{
  font-weight: 800;
  color: rgba(15,23,42,.78);
  font-size: 13px;
}
.statRow .v{
  font-weight: 900;
  color: rgba(15,23,42,.92);
}

/* =========================
   STATISTIKA (grid + kartice)
========================= */

.statsGrid{
  margin-top:12px;
  display:grid;
  grid-template-columns: repeat(2, minmax(220px, 1fr));
  gap:12px;
}

.statsCard{
  background: rgba(241,245,249,.85); /* manje belo */
  border: 1px solid rgba(15,23,42,.14);
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 18px 40px rgba(2,6,23,.08);
}

.statsCard h4{
  margin:0 0 10px 0;
  font-size: 15px;
  font-weight: 900;
  color: rgba(15,23,42,.92);
  letter-spacing:.02em;
}

.statsRows{ display:flex; flex-direction:column; gap:8px; }

.statRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 10px 12px;
  border-radius: 14px;
  background: rgba(255,255,255,.55);
  border: 1px solid rgba(15,23,42,.10);
}

.statRow .k{
  color: rgba(15,23,42,.70);
  font-weight: 700;
  font-size: 13px;
}

.statRow .v{
  color: rgba(15,23,42,.92);
  font-weight: 900;
  font-size: 15px;
}

/* mobilni prikaz */
@media (max-width: 640px){
  .statsGrid{ grid-template-columns: 1fr; }
  .statsCard[style*="grid-column"]{ grid-column:auto !important; }
}

  /* =========================
   CUSTOM MONTH PICKER (SR)
========================= */

.monthPick{
  margin-top:12px;
}

.monthPickRow{
  display:flex;
  gap:10px;
  align-items:flex-end;
  flex-wrap:wrap;
}

.mpLabel{
  display:block;
  font-size:12px;
  font-weight:800;
  color:rgba(15,23,42,.72);
  margin-bottom:8px;
  letter-spacing:.02em;
}

.mpSelect{
  flex:1 1 160px;
  min-width:160px;
  padding:12px 12px;
  border-radius:16px;
  border:1px solid rgba(15,23,42,.18);
  background:rgba(255,255,255,.78);
  color:rgba(15,23,42,.92);
  font-weight:800;
  outline:none;
  box-shadow:0 10px 26px rgba(2,6,23,.06);
}

.mpSelect:focus{
  border-color:rgba(29, 78, 216, .45);
  box-shadow:0 0 0 4px rgba(29, 78, 216, .18);
}

.mpBtn{
  padding:12px 14px;
  border-radius:16px;
  font-weight:900;
  white-space:nowrap;
}

.mpHint{
  margin-top:10px;
  font-size:12px;
  font-weight:800;
  color:rgba(15,23,42,.65);
}

  /* FINANSIJE ‚Äì sakrij header */
body.page-finansije .pageHeader{
  display: none;
}

/* blago spu≈°tanje kartica po stranama */
body.page-home #page-home,
body.page-finansije #page-finansije,
body.page-oglasna #page-oglasna,
body.page-forum #page-forum,
body.page-regulative #page-regulative,
body.page-kontakt #page-kontakt,
body.page-statistika #page-statistika{
  margin-top: 28px;
}

/* ===== GLOBAL OFFSET ISPOD SIDEBARA ===== */
:root{
  --sidebar-top-offset: 72px; /* menjaj po potrebi */
}

.contentWrap{
  padding-top: var(--sidebar-top-offset);
}

/* Header (meta + pretraga + stanje) samo na Poƒçetnoj */
body.mode-portal .pageHeader{ 
  display: none; 
}

body.mode-portal.page-home .pageHeader{ 
  display: flex; 
}

/* Poƒçetna: Promeni zgradu levo od Pretrage (bez drugih promena) */
body.mode-portal.page-home .rightCol{
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 10px;
}

/* redosled elemenata */
body.mode-portal.page-home #switchBuildingBtn{
  order: 1;
}

body.mode-portal.page-home .searchInline{
  order: 2;
  flex: 1;
}

body.mode-portal.page-home .balanceCard{
  order: 3;
  align-self: flex-start;
  margin-top: 26px; /* fino spu≈°tanje da krene u visini pretrage */
}


/* Logo smanjen za ~40% */
.topRightLogo img{
  height: 34px;   /* 56px ‚Üí 34px */
}

/* desktop */
@media (min-width: 900px){
  .topRightLogo img{
    height: 55px; /* 92px ‚Üí 55px */
  }
}

  /* Logo smanjen za ~40% */
.topRightLogo img{
  height: 34px;   /* 56px ‚Üí 34px */
}

/* desktop */
@media (min-width: 900px){
  .topRightLogo img{
    height: 55px; /* 92px ‚Üí 55px */
  }
}

  /* Tekst "Portal / Upravnik" smanjen proporcionalno sa logom (‚àí40%) */
.topRightTitle span{
  font-size: 11px;   /* 18px ‚Üí 11px */
}

/* desktop */
@media (min-width: 900px){
  .topRightTitle span{
    font-size: 13px; /* 22px ‚Üí 13px */
  }
}

/* Poƒçetna: spusti Stanje raƒçuna da krene u istoj visini kao Pretraga */
body.mode-portal.page-home .balanceCard{
  align-self: flex-start;
  margin-top: 2px; /* po potrebi: 2‚Äì6px */
}

  /* Poƒçetna: fix overflow na mobilnom (vrati header elemente u kolonu) */
@media (max-width: 720px){
  body.mode-portal.page-home .rightCol{
    display: flex;
    flex-direction: column;
    align-items: stretch; /* da elementi zauzmu ≈°irinu lepo */
  }

  body.mode-portal.page-home .searchInline,
  body.mode-portal.page-home .balanceCard{
    width: 100%;
    max-width: 100%;
  }

  /* po≈°to si spu≈°tao balanceCard za desktop poravnanje */
  body.mode-portal.page-home .balanceCard{
    margin-top: 0;
    align-self: auto;
  }
}

  
</style>
</head>

<body class="mode-login">
<div class="ambient"></div>

<!-- TOP RIGHT BRAND -->
<div class="topRightBar">
  <div class="topRightTitle">
    <span>Portal</span>
    <span>Upravnik</span>
  </div>
  <div class="topRightLogo">
    <img src="logo.png" alt="Portal Upravnik logo">
  </div>
</div>

<!-- LOGIN SCREEN -->
<section class="loginWrap" id="loginScreen">
  <div class="loginCard">
    <div class="loginInner">

      <div class="loginHead">
        <div class="formTitle">Prijava</div>
      </div>

      <div class="formSub">
        Unesite korisniƒçko ime i lozinku sa kartice.
      </div>

      <div class="field">
        <label for="username">Korisniƒçko ime</label>
        <input id="username" type="text" placeholder="npr. PU7X9-001" autocomplete="username">
      </div>

      <div class="field">
        <label for="pass">Lozinka</label>
        <div class="inputWrap">
          <input id="pass" type="password" placeholder="Unesi lozinku" autocomplete="current-password">
          <button class="eyeBtn" id="togglePass" type="button">üëÅ</button>
        </div>
      </div>

      <div class="row">
        <label class="check">
          <input id="remember" type="checkbox" checked>
          Zapamti me
        </label>
      </div>

      <div class="btnRow">
        <button class="btn btnPrimary" id="loginBtn">Uloguj se</button>
      </div>

      <div class="error" id="loginError">Pogresno korisniƒçko ime ili lozinka.</div>

      <div class="miniHint">
        U sluƒçaju zaboravljenog naloga ili lozinke kontaktirajte upravnika.
      </div>

    </div>
  </div>
</section>

<!-- BUILDING SELECT SCREEN -->
<section class="loginWrap" id="buildingSelectScreen">
  <div class="loginCard">
    <div class="loginInner">

      <div class="loginHead">
        <div class="formTitle">Izaberi stambenu zajednicu</div>
      </div>

      <div class="formSub" id="bsSub">
        Izaberite zgradu koju zelite da otvorite.
      </div>

      <div class="pickList" id="buildingPickList"></div>

      <div class="btnRow" style="margin-top:16px;">
        <button class="btn btnGhost" id="bsLogoutBtn" type="button">Odjava</button>
      </div>

    </div>
  </div>
</section>

<!-- PORTAL SCREEN -->
<div id="portalScreen">

  <div class="edgeHotspot" id="edgeHotspot"></div>
  <div class="overlay" id="overlay"></div>
  <div class="hamburger" id="hamburger">‚ò∞</div>

  <aside class="sidebar" id="sidebar">
    

    <nav class="nav" id="nav">
      <a href="#" class="active" data-page="home">Poƒçetna</a>
      <a href="#" data-page="finansije">Finansije</a>
      <a href="#" data-page="oglasna">Oglasna tabla</a>
      <a href="#" data-page="forum">Forum</a>
      <a href="#" data-page="regulative">Zakonske regulative</a>
      <a href="#" data-page="kontakt">Kontakt slu≈æbe</a>

<!-- ‚úÖ STATISTIKA (samo upravnik/admin) -->
<a href="#" data-page="statistika" data-role="upravnik">Statistika</a>
<a href="#" data-page="statistika" data-role="admin">Statistika</a>

<!-- ‚úÖ ODJAVA (uvek poslednja) -->
<a href="#" id="sidebarLogout" class="logoutItem">Odjava</a>


    </nav>
  </aside>

  <main class="main">
    <div class="contentWrap">

      <section class="pageHeader">
        <div class="leftInfo">
          <div class="meta" id="buildingMeta">
            <!-- popunjava JS -->
          </div>
        </div>

        <div class="rightCol">
          <div class="topMini">
            <div class="pill" id="userPill">Korisnik</div>
            <div class="pill" id="buildingPill">Zgrada</div>
            <div class="pill pillBtn" id="switchBuildingBtn" style="display:none;">Promeni zgradu</div>
          </div>

          <div class="searchInline" style="position:relative;">
            <input id="globalSearch" placeholder="Pretraga (finansije, dokumenti, forum)">
            <div class="searchResults" id="searchResults" style="display:none;"></div>
          </div>

          <div class="balanceCard">
            <span class="label">Stanje raƒçuna</span>
            <div class="balanceAmount">
              <span class="value" id="balanceValue">0,00</span>
              <span class="currency">RSD</span>
            </div>
          </div>
        </div>
      </section>

      <section class="page active" id="page-home">
        <section class="card">
          <h3>Poƒçetna</h3>

          <div class="smallText">
            Kratak pregled (stanje raƒçuna, poslednje promene, istaknuta obave≈°tenja).
          </div>

          <ul class="boardList" style="margin-top:12px;">
            <li id="homeLastChange">Poslednja promena: (nema)</li>
            <li id="homePinned">Istaknuto: (nema)</li>
            <li id="homeForum">Forum: (nema)</li>
          </ul>


          
          <div class="smallText" data-role="admin" style="margin-top:12px;">
            Admin: placeholder (upravljanje korisnicima, regulativama i kontaktima).
          </div>
        </section>
      </section>

      <!-- FINANSIJE -->
      <section class="page" id="page-finansije">
        <section class="card">
          <h3>Finansije</h3>

<!-- FIN HEADER CONTROLS (filter/sort) -->
<div class="fRow" style="margin-top:12px; gap:10px; align-items:flex-end;">
  <div class="half field" style="margin-top:0;">
    <label for="finFilterType">Tip</label>
    <select id="finFilterType">
      <option value="svi">Svi</option>
      <option value="prihod">Prihod</option>
      <option value="rashod">Rashod</option>
    </select>
  </div>

  <div class="half field" style="margin-top:0;">
    <label for="finFilterCategory">Kategorija</label>
    <select id="finFilterCategory">
      <option value="">Sve</option>
      <option value="hitna intervencija">Hitna intervencija</option>
      <option value="tekuƒáe odr≈æavanje">Tekuƒáe odr≈æavanje</option>
      <option value="lift">Lift</option>
      <option value="ostalo">Ostalo</option>
      <option value="drugo">Drugo</option>
    </select>
  </div>

  <div class="half field" style="margin-top:0;">
    <label for="finSortBy">Sortiranje</label>
    <select id="finSortBy">
      <option value="date-desc">Datum ‚Üì</option>
      <option value="date-asc">Datum ‚Üë</option>
      <option value="amount-desc">Iznos ‚Üì</option>
      <option value="amount-asc">Iznos ‚Üë</option>
    </select>
  </div>

  <div class="grow field" style="margin-top:0;">
    <label for="finLocalSearch">Pretraga</label>
    <input id="finLocalSearch" type="text" placeholder="npr. lift, servis, 120000...">
  </div>
</div>
<!-- /FIN HEADER CONTROLS -->

          
          <div class="smallText">
            Pregled finansijskih promena i dokumenata.
          </div>


          
          <!-- ‚úÖ DODATO: POCETNO STANJE (samo admin/upravnik) -->
          <div class="smallText" data-role="upravnik" style="margin-top:12px;">
            <div class="fRow">
              <div class="grow">
                <span class="badge">Poƒçetno stanje (RSD)</span>
              </div>
              <div class="half field" style="margin-top:0; min-width:220px;">
                <input id="openingBalanceInput" type="number" step="0.01" placeholder="npr. 948889">
              </div>
              <div>
                <button class="btn btnGhost" id="saveOpeningBalanceBtn" type="button" style="flex:unset;">Saƒçuvaj poƒçetno stanje</button>
              </div>
            </div>
            <div class="smallText" style="margin-top:8px;">
              Napomena: Stanje raƒçuna = poƒçetno stanje + (prihodi ‚àí rashodi).
            </div>
          </div>

          <div class="smallText" data-role="admin" style="margin-top:12px;">
            <div class="fRow">
              <div class="grow">
                <span class="badge">Poƒçetno stanje (RSD)</span>
              </div>
              <div class="half field" style="margin-top:0; min-width:220px;">
                <input id="openingBalanceInputAdmin" type="number" step="0.01" placeholder="npr. 948889">
              </div>
              <div>
                <button class="btn btnGhost" id="saveOpeningBalanceBtnAdmin" type="button" style="flex:unset;">Saƒçuvaj poƒçetno stanje</button>
              </div>
            </div>
            <div class="smallText" style="margin-top:8px;">
              Napomena: Stanje raƒçuna = poƒçetno stanje + (prihodi ‚àí rashodi).
            </div>
          </div>
          <!-- ‚úÖ /DODATO -->

          <div class="smallText" data-role="upravnik" style="margin-top:12px;">
            <div class="fRow">
              <div class="grow">
                <span class="badge">Upravnik</span>
                <span class="badge" style="margin-left:8px;">Upload limit: 10MB po unosu</span>
              </div>
              <div>
                <button class="btn btnGhost" id="addFinanceBtn" type="button">Dodaj finansijsku stavku</button>
              </div>
            </div>
          </div>

          <div id="financeFormWrap" data-role="upravnik" style="display:none; margin-top:12px;">
            <div class="fRow">
              <div class="half field">
                <label for="fDate">Datum</label>
                <input id="fDate" type="date">
              </div>

              <div class="half field">
                <label for="fType">Tip</label>
                <select id="fType">
                  <option value="rashod">Rashod</option>
                  <option value="prihod">Prihod</option>
                </select>
              </div>

              <div class="half field">
                <label for="fCategory">Kategorija</label>
                <select id="fCategory">
                  <option value="hitna intervencija">Hitna intervencija</option>
                  <option value="tekuƒáe odr≈æavanje">Tekuƒáe odr≈æavanje</option>
                  <option value="lift">Lift</option>
                  <option value="ostalo">Ostalo</option>
                  <option value="drugo">Drugo</option>
                </select>
              </div>

              <div class="half field">
                <label for="fFirm">Firma (dropdown)</label>
                <select id="fFirm"></select>
              </div>

              <div class="grow field">
                <label for="fFirmNew">Nova firma (opciono)</label>
                <input id="fFirmNew" type="text" placeholder="Unesi novu firmu ako ne postoji u listi">
              </div>

              <div class="grow field">
                <label for="fDesc">Opis</label>
                <input id="fDesc" type="text" placeholder="npr. placanje racuna / uplata stanara">
              </div>

              <div class="grow field">
                <label for="fAmount">Iznos (RSD)</label>
                <input id="fAmount" type="number" step="0.01" placeholder="npr. 12500">
              </div>

              <div class="grow field">
                <label for="fDocs">Dokumenti (vi≈°e fajlova)</label>
                <input id="fDocs" type="file" multiple accept="application/pdf">
                <div class="smallText" style="margin-top:6px;">
                  Ukupna veliƒçina fajlova po unosu max 10MB. Klik na fajl u listi = otvori PDF.
                </div>
              </div>
<div class="grow" id="existingDocsWrap" style="display:none; margin-top:6px;">
  <div class="smallText" style="margin-top:6px;">
    Postojeƒái dokumenti (klik ‚ÄúUkloni‚Äù da izbri≈°e≈° iz stavke):
  </div>
  <ul class="fileList" id="existingDocsList"></ul>
</div>

              <div class="grow" style="display:flex; gap:10px; margin-top:6px;">
                <button class="btn btnPrimary" id="saveFinanceBtn" type="button">Saƒçuvaj</button>
                <button class="btn btnGhost" id="cancelFinanceBtn" type="button">Otkazi</button>
              </div>

              <div class="error" id="financeError" style="display:none;">Gre≈°ka: proveri polja i limit fajlova (10MB).</div>
            </div>
          </div>

          <ul class="boardList" id="financeList"></ul>

          <div class="smallText" style="margin-top:10px;">
            
          </div>
        </section>
      </section>

      <!-- OGLASNA -->
      <section class="page" id="page-oglasna">
        <section class="card">
          <h3>Oglasna tabla</h3>

          <div class="smallText">
            Dokumenta i obave≈°tenja za stanare (odluke, izve≈°taji, re≈°enja, obave≈°tenja).
            Klik na fajl = otvori PDF.
          </div>

          <div class="smallText" data-role="upravnik" style="margin-top:12px;">
            <div class="fRow">
              <div class="grow">
                <span class="badge">Upravnik</span>
                <span class="badge" style="margin-left:8px;">Upload limit: 10MB po objavi</span>
              </div>
              <div>
                <button class="btn btnGhost" id="addBoardBtn" type="button">Dodaj objavu</button>
              </div>
            </div>
          </div>

          <div id="boardFormWrap" data-role="upravnik" style="display:none; margin-top:12px;">
            <div class="fRow">
              <div class="grow field">
                <label for="bTitle">Naslov objave</label>
                <input id="bTitle" type="text" placeholder="npr. Odluka skup≈°tine stanara">
              </div>

              <div class="half field">
                <label for="bDate">Datum</label>
                <input id="bDate" type="date">
              </div>

              <div class="grow field">
                <label for="bDesc">Kratak opis</label>
                <input id="bDesc" type="text" placeholder="npr. Odluka o tekuƒáe odr≈æavanje">
              </div>

              <div class="grow field">
                <label for="bDocs">PDF dokumenta (vi≈°e fajlova)</label>
                <input id="bDocs" type="file" multiple accept="application/pdf">
                <div class="smallText" style="margin-top:6px;">
                  Ukupna velicina fajlova po objavi max 10MB.
                </div>
              </div>

              <div class="grow" style="display:flex; gap:10px; margin-top:6px;">
                <button class="btn btnPrimary" id="saveBoardBtn" type="button">Objavi</button>
                <button class="btn btnGhost" id="cancelBoardBtn" type="button">Otkazi</button>
              </div>

              <div class="error" id="boardError" style="display:none;">Gre≈°ka: proveri polja i limit fajlova (10MB).</div>
            </div>
          </div>

          <ul class="boardList" id="boardList"></ul>

          <div class="smallText" style="margin-top:10px;">
            
          </div>
        </section>
      </section>

      <!-- FORUM -->
      <section class="page" id="page-forum">
        <section class="card">
          <h3>Forum</h3>

          <div class="smallText">
            Jednosmerna komunikacija: stanar predlaze. Opcionalno anketa sa vremenom trajanja.
          </div>

          <div data-role="stanar" id="forumCreateWrap" style="margin-top:12px;">
            <div class="fRow">
              <div class="grow field">
                <label for="pTitle">Naslov predloga</label>
                <input id="pTitle" type="text" placeholder="npr. Zamena svetla u hodniku">
              </div>
              <div class="grow field">
                <label for="pBody">Opis</label>
                <textarea id="pBody" placeholder="Kratak opis predloga (bez licnih podataka)"></textarea>
              </div>

              <div class="half field">
                <label for="pPoll">Anketa</label>
                <select id="pPoll">
                  <option value="ne">Ne</option>
                  <option value="da">Da (Da/Ne glasanje)</option>
                </select>
              </div>

              <div class="half field">
                <label for="pDays">Trajanje ankete (dani)</label>
                <input id="pDays" type="number" min="1" max="30" value="7">
              </div>

              <div class="grow" style="display:flex; gap:10px; margin-top:6px;">
                <button class="btn btnPrimary" id="createProposalBtn" type="button">Objavi predlog</button>
                <button class="btn btnGhost" id="clearProposalBtn" type="button">Ocisti</button>
              </div>

              <div class="error" id="forumError" style="display:none;">Gre≈°ka: proveri polja.</div>
            </div>
          </div>

          <div class="smallText" data-role="upravnik" style="margin-top:12px;">
            Upravnik: samo uvid (bez pisanja i bez glasanja).
          </div>
          <div class="smallText" data-role="admin" style="margin-top:12px;">
            Administrator: za sada samo uvid (kasnije moderacija/izve≈°taji).
          </div>

          <ul class="boardList" id="forumList"></ul>
        </section>
      </section>

      <section class="page" id="page-regulative">
        <section class="card">
          <h3>Zakonske regulative</h3>
          <div class="smallText">
            Informativna stranica sa zakonima i propisima.
          </div>

          <div class="smallText" data-role="admin">
            Admin: placeholder (upload/izmena regulativa).
          </div>

          <ul class="boardList" id="regList">
            <li>Zakon o stanovanju i odr≈æavanju zgrada (PDF)</li>
            <li>Pravilnik o upravljanju stambenim zajednicama (PDF)</li>
          </ul>
        </section>
      </section>

      <section class="page" id="page-kontakt">
        <section class="card">
          <h3>Kontakt slu≈æbe</h3>

          <div class="smallText" data-role="admin">
            Admin: placeholder (izmena kontakata i brojeva).
          </div>

          <ul class="boardList" id="kontaktList">
            <li>Vatrogasci: 193</li>
            <li>Hitna pomoc: 194</li>
            <li>Policija: 192</li>
            <li>EPS kvarovi: (placeholder)</li>
          </ul>
        </section>
      </section>

<section class="page" id="page-statistika">
  <section class="card">
    <h3>Statistika</h3>

    <div class="smallText">
      Meseƒçni obraƒçun upload-a (Finansije + Oglasna).
    </div>

<div data-role="upravnik" style="margin-top:12px;">
  <div class="half field" style="margin-top:0; min-width:220px;">
    <label for="uplMonthPick">Mesec (obraƒçun upload-a)</label>
   <div class="monthPick">
  <label class="mpLabel" for="uplMonthMonth">Mesec (obraƒçun upload-a)</label>

  <div class="monthPickRow">
    <select id="uplMonthMonth" class="mpSelect">
      <option value="">Mesec</option>
      <option value="01">Januar</option>
      <option value="02">Februar</option>
      <option value="03">Mart</option>
      <option value="04">April</option>
      <option value="05">Maj</option>
      <option value="06">Jun</option>
      <option value="07">Jul</option>
      <option value="08">Avgust</option>
      <option value="09">Septembar</option>
      <option value="10">Oktobar</option>
      <option value="11">Novembar</option>
      <option value="12">Decembar</option>
    </select>

    <select id="uplMonthYear" class="mpSelect">
      <option value="">Godina</option>
      <!-- JS automatski puni -->
    </select>

    <button type="button" class="btn btnPrimary mpBtn" id="uplMonthApply">
      Primeni
    </button>
  </div>

  <!-- hidden value kao YYYY-MM -->
  <input type="hidden" id="uplMonthPick" value="">

  <div class="mpHint" id="uplMonthHint">Izaberi mesec i godinu</div>
</div>


  <div class="statsGrid">
    <div class="statsCard">
      <h4>Finansije</h4>
      <div class="statsRows">
        <div class="statRow"><span class="k">Unosa</span><span class="v" id="uplFinEntries">0</span></div>
        <div class="statRow"><span class="k">Fajlova</span><span class="v" id="uplFinFiles">0</span></div>
        <div class="statRow"><span class="k">MB</span><span class="v" id="uplFinMB">0.00</span></div>
      </div>
    </div>

    <div class="statsCard">
      <h4>Oglasna</h4>
      <div class="statsRows">
        <div class="statRow"><span class="k">Objava</span><span class="v" id="uplBrdEntries">0</span></div>
        <div class="statRow"><span class="k">Fajlova</span><span class="v" id="uplBrdFiles">0</span></div>
        <div class="statRow"><span class="k">MB</span><span class="v" id="uplBrdMB">0.00</span></div>
      </div>
    </div>

    <div class="statsCard" style="grid-column:1/-1;">
      <h4>Ukupno</h4>
      <div class="statsRows">
        <div class="statRow"><span class="k">Ukupno fajlova</span><span class="v" id="uplTotalFiles">0</span></div>
        <div class="statRow"><span class="k">Ukupno MB</span><span class="v" id="uplTotalMB">0.00</span></div>
      </div>
    </div>
  </div>
</div>

  </section>
</section>

      
    </div>
  </main>

</div>

<script>
/* =========================================================
   PRINCIP RADA (front-only priprema)
   - svaka zgrada je "tenant" (nezavisna stambena zajednica)
   - stanari dobijaju kartice: username + lozinka (po stanu)
   - upravnik moze voditi vi≈°e zgrada -> posle logina bira zgradu
   - sve se cuva u localStorage po zgradi (kasnije Supabase)
   ========================================================= */

/* ====== Buildings (stambene zajednice) ====== */
const BUILDINGS = [
  {
    id: "b_bm25",
    title: "Bore Markoviƒáa 25",
    street: "Bore Markoviƒáa",
    number: "25",
    units: 25
  },
  {
    id: "b_bp10",
    title: "Bulevar Primer 10",
    street: "Bulevar Primer",
    number: "10",
    units: 48
  },
  {
    id: "b_nƒç28",
    title: "Nedeljka ƒåabrinoviƒáa 28",
    street: "Nedeljka ƒåabrinoviƒáa",
    number: "28",
    units: 36
  }
];


function normalizeBuildingId(id){
  return String(id || "")
    .normalize("NFKD")
    .replace(/[\u0300-\u036f]/g, "")  // skida dijakritike
    .replace(/ƒç/g, "c").replace(/ƒá/g, "c")
    .replace(/≈°/g, "s").replace(/ƒë/g, "dj").replace(/≈æ/g, "z")
    .toLowerCase()
    .trim();
}

function getBuildingById(id){
  const direct = BUILDINGS.find(b => b.id === id);
  if(direct) return direct;

  const nid = normalizeBuildingId(id);
  return BUILDINGS.find(b => normalizeBuildingId(b.id) === nid) || null;
}


/* ====== Users (demo) ====== */
const USERS = [
  { username: "ADMIN-001", pass: "123456", role: "admin", buildings: ["b_bm25","b_bp10","b_nƒç28"] },
  { username: "UPR-001",   pass: "123456", role: "upravnik", buildings: ["b_bp10","b_nƒç28"] },
{ username: "UPR-002",   pass: "123456", role: "upravnik", buildings: ["b_bm25"] },

  
  { username: "BM25-001", pass: "2B3H1", role: "stanar", buildings: ["b_bm25"] },
  { username: "BM25-002", pass: "8K1Q9", role: "stanar", buildings: ["b_bm25"] },
  { username: "BM25-003", pass: "4Z7M2", role: "stanar", buildings: ["b_bm25"] },

  { username: "BP10-001", pass: "7A2D5", role: "stanar", buildings: ["b_bp10"] },
  { username: "BP10-002", pass: "9P3R1", role: "stanar", buildings: ["b_bp10"] },

  { username: "NC28-001", pass: "A7K3P", role: "stanar", buildings: ["b_nƒç28"] },
  { username: "NC28-002", pass: "Q9M2L", role: "stanar", buildings: ["b_nƒç28"] },
  { username: "NC28-003", pass: "Z4R8W", role: "stanar", buildings: ["b_nƒç28"] }
];


/* ===== session keys ===== */
const KEY_PERSIST = "pu_session_persist_v8";
const KEY_SESSION = "pu_session_session_v8";

/* ===== storage keys (po zgradi) ===== */
function kFin(bid){ return "pu_finance_items_v3__" + bid; }
function kFirm(bid){ return "pu_finance_firms_v3__" + bid; }
function kForum(bid){ return "pu_forum_proposals_v2__" + bid; }
function kBoard(bid){ return "pu_board_posts_v2__" + bid; }

/* ‚úÖ IZMENJENO: umesto jednog balansa, cuvamo POCETNO STANJE po zgradi */
function kOpeningBalance(bid){ return "pu_opening_balance_v1__" + bid; }

/* ===== DOM refs ===== */
const usernameEl = document.getElementById("username");
const passEl = document.getElementById("pass");
const loginBtn = document.getElementById("loginBtn");
const errEl = document.getElementById("loginError");
const togglePass = document.getElementById("togglePass");
const remember = document.getElementById("remember");

const buildingPickList = document.getElementById("buildingPickList");
const bsLogoutBtn = document.getElementById("bsLogoutBtn");

const userPill = document.getElementById("userPill");
const buildingPill = document.getElementById("buildingPill");
const switchBuildingBtn = document.getElementById("switchBuildingBtn");

const buildingMeta = document.getElementById("buildingMeta");
const balanceValue = document.getElementById("balanceValue");

const globalSearch = document.getElementById("globalSearch");
const searchResults = document.getElementById("searchResults");

/* ‚úÖ DODATO: inputs za pocetno stanje */
const openingBalanceInput = document.getElementById("openingBalanceInput");
const saveOpeningBalanceBtn = document.getElementById("saveOpeningBalanceBtn");
const openingBalanceInputAdmin = document.getElementById("openingBalanceInputAdmin");
const saveOpeningBalanceBtnAdmin = document.getElementById("saveOpeningBalanceBtnAdmin");

/* finance elements */
const financeList = document.getElementById("financeList");
const addFinanceBtn = document.getElementById("addFinanceBtn");
const financeFormWrap = document.getElementById("financeFormWrap");
const saveFinanceBtn = document.getElementById("saveFinanceBtn");
const cancelFinanceBtn = document.getElementById("cancelFinanceBtn");
const financeError = document.getElementById("financeError");

/* ‚úÖ MESEƒåNI UPLOAD (finansije + oglasna) */
const uplMonthPick = document.getElementById("uplMonthPick");
const uplFinEntries = document.getElementById("uplFinEntries");
const uplFinFiles = document.getElementById("uplFinFiles");
const uplFinMB = document.getElementById("uplFinMB");

const uplBrdEntries = document.getElementById("uplBrdEntries");
const uplBrdFiles = document.getElementById("uplBrdFiles");
const uplBrdMB = document.getElementById("uplBrdMB");

const uplTotalFiles = document.getElementById("uplTotalFiles");
const uplTotalMB = document.getElementById("uplTotalMB");

/* ‚úÖ MESEƒåNI UPLOAD (admin) */
const uplMonthPickAdmin = document.getElementById("uplMonthPickAdmin");
const uplFinEntriesA = document.getElementById("uplFinEntriesA");
const uplFinFilesA = document.getElementById("uplFinFilesA");
const uplFinMBA = document.getElementById("uplFinMBA");

const uplBrdEntriesA = document.getElementById("uplBrdEntriesA");
const uplBrdFilesA = document.getElementById("uplBrdFilesA");
const uplBrdMBA = document.getElementById("uplBrdMBA");

const uplTotalFilesA = document.getElementById("uplTotalFilesA");
const uplTotalMBA = document.getElementById("uplTotalMBA");

  
const fDate = document.getElementById("fDate");
const fType = document.getElementById("fType");
const fCategory = document.getElementById("fCategory");
const fFirm = document.getElementById("fFirm");
const fFirmNew = document.getElementById("fFirmNew");
const fDesc = document.getElementById("fDesc");
const fAmount = document.getElementById("fAmount");
const fDocs = document.getElementById("fDocs");

  /* finance header controls */
const finLocalSearch = document.getElementById("finLocalSearch");
const finFilterType = document.getElementById("finFilterType");
const finFilterCategory = document.getElementById("finFilterCategory");
const finSortBy = document.getElementById("finSortBy");
const finClearBtn = document.getElementById("finClearBtn");
  
  const existingDocsWrap = document.getElementById("existingDocsWrap");
const existingDocsList = document.getElementById("existingDocsList");


/* forum elements */
const forumList = document.getElementById("forumList");
const pTitle = document.getElementById("pTitle");
const pBody = document.getElementById("pBody");
const pPoll = document.getElementById("pPoll");
const pDays = document.getElementById("pDays");
const createProposalBtn = document.getElementById("createProposalBtn");
const clearProposalBtn = document.getElementById("clearProposalBtn");
const forumError = document.getElementById("forumError");

/* oglasna elements */
const boardList = document.getElementById("boardList");
const addBoardBtn = document.getElementById("addBoardBtn");
const boardFormWrap = document.getElementById("boardFormWrap");
const saveBoardBtn = document.getElementById("saveBoardBtn");
const cancelBoardBtn = document.getElementById("cancelBoardBtn");
const boardError = document.getElementById("boardError");

const bTitle = document.getElementById("bTitle");
const bDate = document.getElementById("bDate");
const bDesc = document.getElementById("bDesc");
const bDocs = document.getElementById("bDocs");

/* static lists */
const regList = document.getElementById("regList");
const kontaktList = document.getElementById("kontaktList");

/* home */
const homeLastChange = document.getElementById("homeLastChange");
const homePinned = document.getElementById("homePinned");
const homeForum = document.getElementById("homeForum");

let CURRENT_SESSION = null;
let CURRENT_QUERY = "";

  let EDIT_FIN_ID = null;          
let EDIT_FIN_CREATED_AT = null;  
let EDIT_DOCS = [];              

  // ===== FINANSIJE: filter/sort state =====
let FIN_FILTER_TYPE = "svi";        // "svi" | "prihod" | "rashod"
let FIN_FILTER_CATEGORY = "";       // npr. "lift"
let FIN_SORT_BY = "date-desc";      // "date-desc" | "date-asc" | "amount-desc" | "amount-asc"


/* ---------- helpers ---------- */
function setMode(mode){
  document.body.classList.toggle("mode-login", mode === "login");
  document.body.classList.toggle("mode-buildingSelect", mode === "buildingSelect");
  document.body.classList.toggle("mode-portal", mode === "portal");
}
function clearSessions(){
  localStorage.removeItem(KEY_PERSIST);
  sessionStorage.removeItem(KEY_SESSION);
}
function saveSession(sessionObj){
  const payload = JSON.stringify(sessionObj);
  if(remember && remember.checked){
    localStorage.setItem(KEY_PERSIST, payload);
    sessionStorage.removeItem(KEY_SESSION);
  }else{
    sessionStorage.setItem(KEY_SESSION, payload);
    localStorage.removeItem(KEY_PERSIST);
  }
}
function getSession(){
  const raw = localStorage.getItem(KEY_PERSIST) || sessionStorage.getItem(KEY_SESSION);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}
function norm(s){ return String(s||"").toLowerCase().trim(); }
function includesQuery(text, q){
  if(!q) return true;
  return norm(text).includes(norm(q));
}
function cryptoRandom(){
  return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

/* password eye */
togglePass.addEventListener("click", () => {
  const isPass = passEl.type === "password";
  passEl.type = isPass ? "text" : "password";
  togglePass.textContent = isPass ? "üôà" : "üëÅ";
});

function applyRoleUI(role){
  const roleEls = document.querySelectorAll("[data-role]");
  roleEls.forEach(el => {
    const need = el.getAttribute("data-role");
    el.style.display = (need === role) ? "" : "none";
  });
}

/* ===== building context UI ===== */
function setActiveBuilding(bid){
  if(!CURRENT_SESSION) return;
  CURRENT_SESSION.activeBuildingId = bid;
  saveSession(CURRENT_SESSION);
  renderBuildingUI();
  refreshAllModules();
}

function renderBuildingUI(){
  const bid = CURRENT_SESSION?.activeBuildingId;
  const b = getBuildingById(bid);

  // ‚ùå ne prikazuj naziv zgrade pored (pill)
  if(buildingPill){
    buildingPill.textContent = "";
    buildingPill.style.display = "none";
  }

  // (opciono) ako NEƒÜE≈† ni meta tekst (levo ‚ÄúStambena zajednica...‚Äù), ugasi ga:
  // if(buildingMeta){ buildingMeta.innerHTML = ""; }

  // ako HOƒÜE≈† da meta ostane, ali samo kad postoji zgrada:
  if(buildingMeta){
    buildingMeta.innerHTML = b ? `
      Stambena zajednica: ${b.title}<br>
      Broj jedinica: ${b.units}
    ` : "";
  }

  // balans (ako ti je ovo potrebno)
  const bal = computeBalanceFromFinance(bid);
  balanceValue.textContent = formatRSD(bal);

  // popuni input za poƒçetno stanje (ako postoji)
  if(bid){
    const opening = getOpeningBalance(bid);
    if(openingBalanceInput) openingBalanceInput.value = String(opening);
    if(openingBalanceInputAdmin) openingBalanceInputAdmin.value = String(opening);
  }

  // ‚úÖ dugme "Promeni zgradu" ostaje
  const multi = (CURRENT_SESSION?.buildings || []).length > 1 && (CURRENT_SESSION.role !== "stanar");
  if(switchBuildingBtn) switchBuildingBtn.style.display = multi ? "" : "none";
}

/* ===== login flow ===== */
function attemptLogin(username, pass){
  const u = USERS.find(x => x.username === username && x.pass === pass);
  if(!u){
    errEl.style.display = "block";
    return;
  }
  errEl.style.display = "none";

  CURRENT_SESSION = {
    username: u.username,
    role: u.role,
    buildings: (u.buildings || []).slice(),
    activeBuildingId: null
  };

  // stanar ide odmah u svoju zgradu
  if(CURRENT_SESSION.role === "stanar"){
    CURRENT_SESSION.activeBuildingId = CURRENT_SESSION.buildings[0] || null;
    saveSession(CURRENT_SESSION);
    enterPortal();
    return;
  }

  // upravnik/admin: ako vi≈°e zgrada -> izbor, ako jedna -> direktno
  if((CURRENT_SESSION.buildings || []).length > 1){
    saveSession(CURRENT_SESSION);
    showBuildingSelect();
  }else{
    CURRENT_SESSION.activeBuildingId = CURRENT_SESSION.buildings[0] || null;
    saveSession(CURRENT_SESSION);
    enterPortal();
  }
}

loginBtn.addEventListener("click", () => {
  attemptLogin((usernameEl.value||"").trim(), (passEl.value||"").trim());
});
document.addEventListener("keydown", (e) => {
  if(document.body.classList.contains("mode-login") && e.key === "Enter"){
    attemptLogin((usernameEl.value||"").trim(), (passEl.value||"").trim());
  }
});

/* ===== building select screen ===== */
function showBuildingSelect(){
  setMode("buildingSelect");

  const list = (CURRENT_SESSION?.buildings || []).map(id => {
  const b = getBuildingById(id);
  return b ? b : { id, title: "Nepoznata zgrada", street: "ID", number: String(id), units: "-" };
});


  buildingPickList.innerHTML = "";
  list.forEach(b => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "pickBtn";
    btn.innerHTML = `
      <div class="t">${b.title}</div>
      <div class="s">${b.street} ${b.number} ‚Ä¢ ${b.units} jedinica</div>
    `;
    btn.addEventListener("click", () => {
      setActiveBuilding(b.id);
      enterPortal();
    });
    buildingPickList.appendChild(btn);
  });
}

bsLogoutBtn.addEventListener("click", () => {
  clearSessions();
  CURRENT_SESSION = null;
  setMode("login");
});

/* ==== enter portal ==== */
function enterPortal(){
  if(userPill){
    userPill.textContent = "";
    userPill.style.display = "none";
  }

  applyRoleUI(CURRENT_SESSION?.role || "stanar");
  setMode("portal");
  // Uvek po ulasku u portal postavi Home kao aktivnu stranu (da bi header bio vidljiv)
showPage("home");


  // set active building if missing
  if(!CURRENT_SESSION.activeBuildingId){
    CURRENT_SESSION.activeBuildingId = CURRENT_SESSION.buildings[0] || null;
    saveSession(CURRENT_SESSION);
  }

  renderBuildingUI();
  refreshAllModules();
  ensureStaticSids();
  updateHomeSummary();
}

/* logout (portal) */
const logoutBtn = document.getElementById("logoutBtn");
if (logoutBtn) {
  logoutBtn.addEventListener("click", () => {
    clearSessions();
    CURRENT_SESSION = null;
    closeS();
    setMode("login");
  });
}

/* switch building (portal) */
switchBuildingBtn.addEventListener("click", () => {
  if(!CURRENT_SESSION) return;
  showBuildingSelect();
});

/* ===== SIDEBAR behavior ===== */
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("overlay");
const edge = document.getElementById("edgeHotspot");
const burger = document.getElementById("hamburger");

function openS(){
  sidebar.classList.add("open");
  overlay.classList.add("show");
  document.body.classList.add("sidebar-open");
}
function closeS(){
  sidebar.classList.remove("open");
  overlay.classList.remove("show");
  document.body.classList.remove("sidebar-open");
}

edge.addEventListener("mouseenter", openS);

/* MOBILE / TOUCH FIX */
edge.addEventListener("touchstart", openS, { passive: true });
overlay.addEventListener("touchstart", closeS, { passive: true });

burger.addEventListener("click", () => {
  sidebar.classList.contains("open") ? closeS() : openS();
});
overlay.addEventListener("click", closeS);
document.addEventListener("keydown", (e) => {
  if(e.key === "Escape") closeS();
});


/* ===== SPA NAV ===== */
const nav = document.getElementById("nav");
const pages = {
  home: document.getElementById("page-home"),
  finansije: document.getElementById("page-finansije"),
  oglasna: document.getElementById("page-oglasna"),
  forum: document.getElementById("page-forum"),
  regulative: document.getElementById("page-regulative"),
  kontakt: document.getElementById("page-kontakt"),
  statistika: document.getElementById("page-statistika")
};
function showPage(name){
  // page flags (radi za sve stranice)
document.body.classList.remove(
  "page-home",
  "page-finansije",
  "page-oglasna",
  "page-forum",
  "page-regulative",
  "page-statistika"
);

// dodaj klasu za trenutnu stranu
if(name) document.body.classList.add(`page-${name}`);


  // dodaj odgovarajuƒáu
  document.body.classList.add(`page-${name}`);

  Object.values(pages).forEach(p => p.classList.remove("active"));
  (pages[name] || pages.home).classList.add("active");

  [...nav.querySelectorAll("a[data-page]")].forEach(a => {
    a.classList.toggle("active", a.dataset.page === name);
  });

  closeS();
  window.scrollTo({ top: 0, behavior: "smooth" });
}

nav.addEventListener("click", (e) => {
  const a = e.target.closest("a[data-page]");
  if(!a) return;
  e.preventDefault();
  showPage(a.dataset.page);
});

/* =========================================================
   STORAGE PER BUILDING
   ========================================================= */
function activeBid(){
  return CURRENT_SESSION?.activeBuildingId || null;
}

/* ‚úÖ NOVO: Pocetno stanje (seed + edit) */
function getOpeningBalance(bid){
  const raw = localStorage.getItem(kOpeningBalance(bid));
  if(raw == null || raw === ""){
    // seed (kao sto si imao pre)
    const seed = (bid === "b_bm25") ? 948889 : 312450;
    localStorage.setItem(kOpeningBalance(bid), String(seed));
    return seed;
  }
  const n = Number(raw);
  return Number.isFinite(n) ? n : 0;
}
function setOpeningBalance(bid, val){
  localStorage.setItem(kOpeningBalance(bid), String(Number(val||0)));
}

/* finance */
function formatRSD(n){
  const x = Number(n||0);
  return x.toLocaleString("sr-RS", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function daysBetween(aMs, bMs){
  const day = 1000*60*60*24;
  return Math.floor(Math.abs(aMs - bMs) / day);
}
function canEdit(item){
  return daysBetween(Date.now(), item.createdAt) <= 30;
}
function loadItems(bid){
  const raw = localStorage.getItem("pu_finance_items_v3__" + bid);
  if(!raw){
    const seed = [
      { id: cryptoRandom(), createdAt: Date.now()-1000*60*60*24*2, date: "2026-01-02", type:"rashod", category:"tekuƒáe odr≈æavanje", firm:"Servis DOO", desc:"Uplata servisu", amount: 24000, docs: [] },
      { id: cryptoRandom(), createdAt: Date.now()-1000*60*60*24*6, date: "2025-12-28", type:"prihod", category:"ostalo", firm:"", desc:"Uplata stanara", amount: 120000, docs: [] },
      { id: cryptoRandom(), createdAt: Date.now()-1000*60*60*24*20, date: "2025-12-15", type:"rashod", category:"hitna intervencija", firm:"Vodoinstalater", desc:"Hitna intervencija", amount: 18000, docs: [] }
    ];
    localStorage.setItem("pu_finance_items_v3__" + bid, JSON.stringify(seed));
    return seed;
  }
  try { return JSON.parse(raw) || []; } catch { return []; }
}
function saveItems(bid, items){
  localStorage.setItem("pu_finance_items_v3__" + bid, JSON.stringify(items));
}

function loadFirms(bid){
  const raw = localStorage.getItem("pu_finance_firms_v3__" + bid);
  if(!raw){
    const seed = ["Servis DOO","Vodoinstalater","Lift Servis"];
    localStorage.setItem("pu_finance_firms_v3__" + bid, JSON.stringify(seed));
    return seed;
  }
  try { return JSON.parse(raw) || []; } catch { return []; }
}
function saveFirms(bid, firms){
  localStorage.setItem("pu_finance_firms_v3__" + bid, JSON.stringify(firms));
}
function renderFirmSelect(bid){
  const firms = loadFirms(bid);
  fFirm.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "(Izaberi firmu)";
  fFirm.appendChild(opt0);

  firms.forEach(name => {
    const o = document.createElement("option");
    o.value = name;
    o.textContent = name;
    fFirm.appendChild(o);
  });
}
function fileToDataURL(file){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result || ""));
    r.onerror = () => reject(new Error("File read error"));
    r.readAsDataURL(file);
  });
}
function totalFilesSizeBytes(fileList){
  let sum = 0;
  for(const f of fileList) sum += (f.size || 0);
  return sum;
}

/* ================= MESEƒåNI UPLOAD KALKULATOR ================= */
function bytesToMB(bytes){
  return (Number(bytes || 0) / (1024 * 1024));
}
function monthFromDateStr(dateStr){
  // oƒçekuje "YYYY-MM-DD" ‚Üí vraƒáa "YYYY-MM"
  if(!dateStr || typeof dateStr !== "string") return "";
  return dateStr.slice(0,7);
}
function sumDocs(docs){
  let files = 0;
  let bytes = 0;
  (docs || []).forEach(d => {
    files += 1;
    // mi ƒçuvamo sizeKB u objektu
    const kb = Number(d.sizeKB || 0);
    bytes += kb * 1024;
  });
  return { files, bytes };
}

function calcMonthlyUploads(bid, monthYYYYMM){
  // Finansije
  const finAll = loadItems(bid) || [];
  const finInMonth = finAll.filter(it => monthFromDateStr(it.date) === monthYYYYMM);

  let finEntries = finInMonth.length;
  let finFiles = 0;
  let finBytes = 0;
  finInMonth.forEach(it => {
    const s = sumDocs(it.docs || []);
    finFiles += s.files;
    finBytes += s.bytes;
  });

  // Oglasna
  const brdAll = loadBoardPosts(bid) || [];
  const brdInMonth = brdAll.filter(p => monthFromDateStr(p.date) === monthYYYYMM);

  let brdEntries = brdInMonth.length;
  let brdFiles = 0;
  let brdBytes = 0;
  brdInMonth.forEach(p => {
    const s = sumDocs(p.docs || []);
    brdFiles += s.files;
    brdBytes += s.bytes;
  });

  const totalFiles = finFiles + brdFiles;
  const totalMB = bytesToMB(finBytes + brdBytes);

  return {
    finEntries, finFiles, finMB: bytesToMB(finBytes),
    brdEntries, brdFiles, brdMB: bytesToMB(brdBytes),
    totalFiles, totalMB
  };
}

function setText(el, val){
  if(!el) return;
  el.textContent = String(val);
}

function updateMonthlyUploadUI(isAdmin){
  const bid = activeBid();
  if(!bid) return;

  const picker = isAdmin ? uplMonthPickAdmin : uplMonthPick;
  if(!picker) return;

  // ako nije izabran mesec, postavi trenutni
  if(!picker.value){
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,"0");
    picker.value = `${yyyy}-${mm}`;
  }

  const m = picker.value; // "YYYY-MM"
  const r = calcMonthlyUploads(bid, m);

  if(isAdmin){
    setText(uplFinEntriesA, r.finEntries);
    setText(uplFinFilesA, r.finFiles);
    setText(uplFinMBA, r.finMB.toFixed(2));

    setText(uplBrdEntriesA, r.brdEntries);
    setText(uplBrdFilesA, r.brdFiles);
    setText(uplBrdMBA, r.brdMB.toFixed(2));

    setText(uplTotalFilesA, r.totalFiles);
    setText(uplTotalMBA, r.totalMB.toFixed(2));
  }else{
    setText(uplFinEntries, r.finEntries);
    setText(uplFinFiles, r.finFiles);
    setText(uplFinMB, r.finMB.toFixed(2));

    setText(uplBrdEntries, r.brdEntries);
    setText(uplBrdFiles, r.brdFiles);
    setText(uplBrdMB, r.brdMB.toFixed(2));

    setText(uplTotalFiles, r.totalFiles);
    setText(uplTotalMB, r.totalMB.toFixed(2));
  }
}

/* listenersi */
if(uplMonthPick){
  uplMonthPick.addEventListener("change", () => updateMonthlyUploadUI(false));
}
if(uplMonthPickAdmin){
  uplMonthPickAdmin.addEventListener("change", () => updateMonthlyUploadUI(true));
}

  
/* ‚úÖ NOVO: racunanje stanja iz finansija */
function computeBalanceFromFinance(bid){
  const opening = getOpeningBalance(bid);
  const items = loadItems(bid);
  let delta = 0;
  for(const it of (items||[])){
    const amt = Number(it.amount||0);
    if(!Number.isFinite(amt)) continue;
    if(it.type === "prihod") delta += amt;
    else delta -= amt;
  }
  const next = Math.max(0, opening + delta);
  return next;
}
function refreshBalanceUI(bid){
  const next = computeBalanceFromFinance(bid);
  balanceValue.textContent = formatRSD(next);
}

/* ‚úÖ NOVO: snimi pocetno stanje (admin/upravnik) */
function saveOpeningBalanceFromUI(){
  const bid = activeBid();
  if(!bid) return;

  if(!CURRENT_SESSION || (CURRENT_SESSION.role !== "upravnik" && CURRENT_SESSION.role !== "admin")){
    alert("Nemate dozvolu.");
    return;
  }

  const src = (CURRENT_SESSION.role === "admin" ? openingBalanceInputAdmin : openingBalanceInput);
  if(!src) return;

  const n = Number((src.value||"").trim());
  if(!Number.isFinite(n)){
    alert("Unesite ispravan broj.");
    return;
  }

  setOpeningBalance(bid, n);
  refreshBalanceUI(bid);
  updateHomeSummary();
}

if(saveOpeningBalanceBtn){
  saveOpeningBalanceBtn.addEventListener("click", saveOpeningBalanceFromUI);
}
if(saveOpeningBalanceBtnAdmin){
  saveOpeningBalanceBtnAdmin.addEventListener("click", saveOpeningBalanceFromUI);
}

function financeMatches(item, q){
  const docsNames = (item.docs||[]).map(d => d.name).join(" ");
  const hay = `${item.date} ${item.type} ${item.category} ${item.firm||""} ${item.desc||""} ${item.amount||""} ${docsNames}`;
  return includesQuery(hay, q);
}
function renderFinanceList(bid, q){
  
  let items = loadItems(bid).slice();

// 1) pretraga
if(q){
  items = items.filter(it => financeMatches(it, q));
}

// 2) filter po tipu
if(FIN_FILTER_TYPE !== "svi"){
  items = items.filter(it => it.type === FIN_FILTER_TYPE);
}

// 3) filter po kategoriji
if(FIN_FILTER_CATEGORY){
  items = items.filter(it => it.category === FIN_FILTER_CATEGORY);
}

// 4) sortiranje
items.sort((a,b) => {
  if(FIN_SORT_BY === "date-desc") return (b.date||"").localeCompare(a.date||"");
  if(FIN_SORT_BY === "date-asc")  return (a.date||"").localeCompare(b.date||"");
  if(FIN_SORT_BY === "amount-desc") return Number(b.amount||0) - Number(a.amount||0);
  if(FIN_SORT_BY === "amount-asc")  return Number(a.amount||0) - Number(b.amount||0);
  return 0;
});


  financeList.innerHTML = "";

  items.forEach(item => {
    const li = document.createElement("li");
    li.dataset.sid = "fin:" + item.id;

    // ako stavka ima upload dokumente -> oboji plavo
if(item.docs && item.docs.length){
  li.classList.add("hasDocs");
}


    const firmPart = item.firm ? (" ‚Äî " + item.firm) : "";
    const editTag = (CURRENT_SESSION && CURRENT_SESSION.role === "upravnik")
      ? (canEdit(item) ? " (edit 30 dana)" : " (zakljucano)")
      : "";

    li.textContent =
      `${item.date} ‚Äî ${item.type === "rashod" ? "Rashod" : "Prihod"} ‚Äî ${item.category}${firmPart} ‚Äî "${item.desc}" ‚Äî ${formatRSD(item.amount)} RSD${editTag}`;

    if(item.docs && item.docs.length){
      const ul = document.createElement("ul");
      ul.className = "fileList";

      item.docs.forEach(d => {
        const fli = document.createElement("li");
        fli.style.cursor = "pointer";
        fli.title = "Klik za otvaranje";
        fli.innerHTML = `<span>${d.name}</span><small>${d.sizeKB} KB</small>`;

        fli.addEventListener("click", () => {
          if(!d.dataURL){
            alert("Fajl je sacuvan bez sadr≈æaja. Uploaduj ponovo.");
            return;
          }
          const w = window.open();
          if(!w){
            alert("Browser je blokirao pop-up. Dozvoli pop-up za ovaj sajt.");
            return;
          }
          w.document.write(`
            <title>${d.name}</title>
            <iframe src="${d.dataURL}" style="position:fixed; inset:0; width:100%; height:100%; border:0;"></iframe>
          `);
          w.document.close();
        });

        ul.appendChild(fli);
      });

      li.appendChild(ul);
    }

    if(CURRENT_SESSION && CURRENT_SESSION.role === "upravnik"){
      const actions = document.createElement("div");
      actions.style.marginTop = "10px";
      actions.style.display = "flex";
      actions.style.gap = "10px";
      actions.style.flexWrap = "wrap";
      const edit = document.createElement("button");
      edit.className = "btn btnGhost";
      edit.type = "button";
      edit.textContent = "Izmeni";
      edit.disabled = !canEdit(item);

      edit.addEventListener("click", () => {
        if(!canEdit(item)){
          alert("Izmena je moguƒáa samo u roku od 30 dana.");
          return;
        }
        renderFirmSelect(bid);
        setFinanceEditMode(item);
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      actions.appendChild(edit);

      const del = document.createElement("button");
      del.className = "btn btnGhost";
      del.type = "button";
      del.textContent = "Obri≈°i ";
      del.disabled = !canEdit(item);
      del.addEventListener("click", () => {
        const next = loadItems(bid).filter(x => x.id !== item.id);
        saveItems(bid, next);
        renderFinanceList(bid, CURRENT_QUERY);
        renderSearchDropdown(CURRENT_QUERY);
        updateHomeSummary();
        refreshBalanceUI(bid); /* ‚úÖ IZMENJENO */
      });

      actions.appendChild(del);
      li.appendChild(actions);
    }

    financeList.appendChild(li);
  });
}
/* ===== FINANCE HEADER CONTROLS LISTENERS ===== */

function applyFinanceControls(){
  const bid = activeBid();
  if(!bid) return;

  // lokalna pretraga ima prednost nad globalnom
  const localQ = (finLocalSearch?.value || "").trim();
  const q = localQ || CURRENT_QUERY;

  renderFinanceList(bid, q);
}

// tip
if(finFilterType){
  finFilterType.addEventListener("change", (e) => {
    FIN_FILTER_TYPE = e.target.value;
    applyFinanceControls();
  });
}

// kategorija
if(finFilterCategory){
  finFilterCategory.addEventListener("change", (e) => {
    FIN_FILTER_CATEGORY = e.target.value;
    applyFinanceControls();
  });
}

// sortiranje
if(finSortBy){
  finSortBy.addEventListener("change", (e) => {
    FIN_SORT_BY = e.target.value;
    applyFinanceControls();
  });
}

// lokalna pretraga
if(finLocalSearch){
  finLocalSearch.addEventListener("input", () => {
    applyFinanceControls();
  });
}

function resetFinanceForm(){
  financeError.style.display = "none";
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,"0");
  const dd = String(today.getDate()).padStart(2,"0");
  fDate.value = `${yyyy}-${mm}-${dd}`;
  fType.value = "rashod";
  fCategory.value = "tekuƒáe odr≈æavanje";
  fFirm.value = "";
  fFirmNew.value = "";
  fDesc.value = "";
  fAmount.value = "";
  if(fDocs) fDocs.value = "";
}

function financeInit(bid){
  if(!financeList) return;
  renderFirmSelect(bid);
  renderFinanceList(bid, CURRENT_QUERY);
  resetFinanceForm();
  clearFinanceEditMode(); // ‚úÖ bitno: svaki put kad inicijalizuje≈°, izlazi iz edit moda
  if(financeFormWrap) financeFormWrap.style.display = "none";
  refreshBalanceUI(bid);
}

/* ===== EDIT MODE HELPERS ===== */
function clearFinanceEditMode(){
  EDIT_FIN_ID = null;
  EDIT_FIN_CREATED_AT = null;
  EDIT_DOCS = [];

  if(existingDocsWrap) existingDocsWrap.style.display = "none";
  if(existingDocsList) existingDocsList.innerHTML = "";

  if(saveFinanceBtn) saveFinanceBtn.textContent = "Saƒçuvaj";
}

function renderExistingDocs(){
  if(!existingDocsWrap || !existingDocsList) return;

  if(!EDIT_DOCS || !EDIT_DOCS.length){
    existingDocsWrap.style.display = "none";
    existingDocsList.innerHTML = "";
    return;
  }

  existingDocsWrap.style.display = "block";
  existingDocsList.innerHTML = "";

  EDIT_DOCS.forEach((d, idx) => {
    const li = document.createElement("li");

    const left = document.createElement("span");
    left.textContent = d.name;

    const right = document.createElement("small");
    right.style.display = "flex";
    right.style.gap = "10px";
    right.style.alignItems = "center";

    const size = document.createElement("span");
    size.textContent = `${d.sizeKB} KB`;

    const rm = document.createElement("button");
    rm.type = "button";
    rm.className = "btn btnGhost";
    rm.textContent = "Ukloni";
    rm.style.padding = "8px 12px";
    rm.style.borderRadius = "12px";

    rm.addEventListener("click", (e) => {
      e.preventDefault();
      EDIT_DOCS.splice(idx, 1);
      renderExistingDocs();
    });

    right.appendChild(size);
    right.appendChild(rm);

    li.appendChild(left);
    li.appendChild(right);
    existingDocsList.appendChild(li);
  });
}

function setFinanceEditMode(item){
  EDIT_FIN_ID = item.id;
  EDIT_FIN_CREATED_AT = item.createdAt;
  EDIT_DOCS = (item.docs || []).map(d => ({ ...d }));

  if(financeFormWrap) financeFormWrap.style.display = "block";
  if(saveFinanceBtn) saveFinanceBtn.textContent = "Saƒçuvaj izmene";

  // popuni formu
  fDate.value = item.date || "";
  fType.value = item.type || "rashod";
  fCategory.value = item.category || "tekuƒáe odr≈æavanje";
  fDesc.value = item.desc || "";
  fAmount.value = String(item.amount ?? "");
  fFirmNew.value = "";

  // dropdown firm
  const bid = activeBid();
  if(bid) renderFirmSelect(bid);
  fFirm.value = item.firm || "";

  // reset upload input
  if(fDocs) fDocs.value = "";

  renderExistingDocs();
}

/* ===== UI LISTENERS ===== */
if(addFinanceBtn){
  addFinanceBtn.addEventListener("click", () => {
    if(!financeFormWrap) return;

    const open = (financeFormWrap.style.display === "none" || financeFormWrap.style.display === "");
    financeFormWrap.style.display = open ? "block" : "none";

    if(open){
      // ako otvaramo formu ruƒçno za NOVU stavku
      resetFinanceForm();
      clearFinanceEditMode();
      const bid = activeBid();
      if(bid) renderFirmSelect(bid);
    }
  });
}

if(cancelFinanceBtn){
  cancelFinanceBtn.addEventListener("click", () => {
    if(financeFormWrap) financeFormWrap.style.display = "none";
    resetFinanceForm();
    clearFinanceEditMode(); // ‚úÖ izlaz iz edit moda
  });
}

if(saveFinanceBtn){
  saveFinanceBtn.addEventListener("click", async () => {
    if(financeError) financeError.style.display = "none";

    const bid = activeBid();
    if(!bid){
      if(financeError){
        financeError.textContent = "Nije izabrana zgrada.";
        financeError.style.display = "block";
      }
      return;
    }

    if(!CURRENT_SESSION || CURRENT_SESSION.role !== "upravnik"){
      if(financeError){
        financeError.textContent = "Nemate dozvolu.";
        financeError.style.display = "block";
      }
      return;
    }

    const date = (fDate.value||"").trim();
    const type = fType.value;
    const category = fCategory.value;

    const firmNew = (fFirmNew.value||"").trim();
    let firm = firmNew || (fFirm.value||"").trim();

    const desc = (fDesc.value||"").trim();
    const amount = Number((fAmount.value||"").trim());

    if(!date || !type || !category || !desc || !Number.isFinite(amount)){
      if(financeError){
        financeError.textContent = "Gre≈°ka: popuni obavezna polja (datum, opis, iznos).";
        financeError.style.display = "block";
      }
      return;
    }

    // upload limit
    const files = [...(fDocs?.files || [])];
    const total = totalFilesSizeBytes(files);
    const LIMIT = 10 * 1024 * 1024;
    if(total > LIMIT){
      if(financeError){
        financeError.textContent = "Gre≈°ka: ukupna velicina fajlova prelazi 10MB.";
        financeError.style.display = "block";
      }
      return;
    }

    // dodaj novu firmu u listu ako je uneta
    if(firmNew){
      const firms = loadFirms(bid);
      if(!firms.includes(firmNew)){
        firms.push(firmNew);
        saveFirms(bid, firms);
      }
      renderFirmSelect(bid);
    }

    // procitaj nove upload fajlove
    const newDocs = [];
    try{
      for(const f of files){
        const dataURL = await fileToDataURL(f);
        newDocs.push({
          name: f.name,
          sizeKB: Math.ceil((f.size||0)/1024),
          mime: f.type || "application/pdf",
          dataURL
        });
      }
    }catch(err){
      if(financeError){
        financeError.textContent = "Gre≈°ka: ne mogu da procitam fajl (FileReader).";
        financeError.style.display = "block";
      }
      return;
    }

    // snimi CREATE ili UPDATE
    try{
      const items = loadItems(bid);

      if(EDIT_FIN_ID){
        const idx = items.findIndex(x => x.id === EDIT_FIN_ID);
        if(idx === -1){
          if(financeError){
            financeError.textContent = "Gre≈°ka: stavka za izmenu nije pronaƒëena.";
            financeError.style.display = "block";
          }
          return;
        }

        const updated = {
          ...items[idx],
          id: EDIT_FIN_ID,
          createdAt: EDIT_FIN_CREATED_AT ?? items[idx].createdAt,
          date,
          type,
          category,
          firm,
          desc,
          amount,
          docs: [...(EDIT_DOCS || []), ...newDocs] // ‚úÖ postojeƒái (posle uklanjanja) + novi
        };

        items[idx] = updated;
        saveItems(bid, items);

      }else{
        const item = {
          id: cryptoRandom(),
          createdAt: Date.now(),
          date,
          type,
          category,
          firm,
          desc,
          amount,
          docs: newDocs
        };

        items.push(item);
        saveItems(bid, items);
      }

    }catch(e){
      if(financeError){
        financeError.textContent = "Gre≈°ka: localStorage limit (PDF je prevelik). Probaj manji PDF.";
        financeError.style.display = "block";
      }
      return;
    }

    // reset UI
    if(financeFormWrap) financeFormWrap.style.display = "none";
    resetFinanceForm();
    clearFinanceEditMode();

    // rerender
    renderFinanceList(bid, CURRENT_QUERY);
    renderSearchDropdown(CURRENT_QUERY);
    updateHomeSummary();
    refreshBalanceUI(bid);
  });
}


/* ================= OGLASNA ================= */
function loadBoardPosts(bid){
  const raw = localStorage.getItem(kBoard(bid));
  if(!raw){
    const seed = [
      { id: cryptoRandom(), createdAt: Date.now()-1000*60*60*24*3, date: "2026-01-01", title: "Akcija ƒçi≈°cenja", desc: "Obave≈°tenje o terminu akcije ƒçi≈°cenja", docs: [] },
      { id: cryptoRandom(), createdAt: Date.now()-1000*60*60*24*7, date: "2025-12-28", title: "Popravka krova", desc: "Plan radova i obave≈°tenje", docs: [] }
    ];
    localStorage.setItem(kBoard(bid), JSON.stringify(seed));
    return seed;
  }
  try { return JSON.parse(raw) || []; } catch { return []; }
}
function saveBoardPosts(bid, items){
  localStorage.setItem(kBoard(bid), JSON.stringify(items));
}
function resetBoardForm(){
  if(boardError) boardError.style.display = "none";

  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,"0");
  const dd = String(today.getDate()).padStart(2,"0");
  if(bDate) bDate.value = `${yyyy}-${mm}-${dd}`;

  if(bTitle) bTitle.value = "";
  if(bDesc) bDesc.value = "";
  if(bDocs) bDocs.value = "";
}
function boardMatches(post, q){
  const docsNames = (post.docs||[]).map(d => d.name).join(" ");
  const hay = `${post.date} ${post.title} ${post.desc||""} ${docsNames}`;
  return includesQuery(hay, q);
}
function renderBoard(bid, q){
  if(!boardList) return;

  const all = loadBoardPosts(bid).slice().sort((a,b) => (b.date||"").localeCompare(a.date||""));
  const items = q ? all.filter(p => boardMatches(p, q)) : all;

  boardList.innerHTML = "";

  items.forEach(post => {
    const li = document.createElement("li");
    li.dataset.sid = "brd:" + post.id;

    li.textContent = `${post.date} ‚Äî ${post.title}${post.desc ? " ‚Äî " + post.desc : ""}`;

    if(post.docs && post.docs.length){
      const ul = document.createElement("ul");
      ul.className = "fileList";

      post.docs.forEach(d => {
        const fli = document.createElement("li");
        fli.style.cursor = "pointer";
        fli.title = "Klik za otvaranje";
        fli.innerHTML = `<span>${d.name}</span><small>${d.sizeKB} KB</small>`;

        fli.addEventListener("click", () => {
          if(!d.dataURL){
            alert("Fajl je sacuvan bez sadr≈æaja. Uploaduj ponovo.");
            return;
          }
          const w = window.open();
          if(!w){
            alert("Browser je blokirao pop-up. Dozvoli pop-up za ovaj sajt.");
            return;
          }
          w.document.write(`
            <title>${d.name}</title>
            <iframe src="${d.dataURL}" style="position:fixed; inset:0; width:100%; height:100%; border:0;"></iframe>
          `);
          w.document.close();
        });

        ul.appendChild(fli);
      });

      li.appendChild(ul);
    }

    if(CURRENT_SESSION && CURRENT_SESSION.role === "upravnik"){
      const actions = document.createElement("div");
      actions.style.marginTop = "10px";
      actions.style.display = "flex";
      actions.style.gap = "10px";
      actions.style.flexWrap = "wrap";

      const del = document.createElement("button");
      del.className = "btn btnGhost";
      del.type = "button";
      del.textContent = "Obri≈°i";
      del.addEventListener("click", () => {
        const next = loadBoardPosts(bid).filter(x => x.id !== post.id);
        saveBoardPosts(bid, next);
        renderBoard(bid, CURRENT_QUERY);
        renderSearchDropdown(CURRENT_QUERY);
        updateHomeSummary();
      });

      actions.appendChild(del);
      li.appendChild(actions);
    }

    boardList.appendChild(li);
  });
}
function boardInit(bid){
  renderBoard(bid, CURRENT_QUERY);
  resetBoardForm();
  if(boardFormWrap) boardFormWrap.style.display = "none";
}
if(addBoardBtn){
  addBoardBtn.addEventListener("click", () => {
    if(!boardFormWrap) return;
    boardFormWrap.style.display =
      (boardFormWrap.style.display === "none" || boardFormWrap.style.display === "") ? "block" : "none";
    if(boardFormWrap.style.display === "block") resetBoardForm();
  });
}
if(cancelBoardBtn){
  cancelBoardBtn.addEventListener("click", () => {
    if(boardFormWrap) boardFormWrap.style.display = "none";
    resetBoardForm();
  });
}
if(saveBoardBtn){
  saveBoardBtn.addEventListener("click", async () => {
    const bid = activeBid();
    if(!bid){
      if(boardError){
        boardError.textContent = "Nije izabrana zgrada.";
        boardError.style.display = "block";
      }
      return;
    }

    if(!CURRENT_SESSION || CURRENT_SESSION.role !== "upravnik"){
      if(boardError){
        boardError.textContent = "Nemate dozvolu.";
        boardError.style.display = "block";
      }
      return;
    }

    if(boardError) boardError.style.display = "none";

    const title = (bTitle?.value || "").trim();
    const date = (bDate?.value || "").trim();
    const desc = (bDesc?.value || "").trim();

    if(!title || !date){
      if(boardError){
        boardError.textContent = "Gre≈°ka: naslov i datum su obavezni.";
        boardError.style.display = "block";
      }
      return;
    }

    const files = [...(bDocs?.files || [])];
    const total = totalFilesSizeBytes(files);
    const LIMIT = 10 * 1024 * 1024;
    if(total > LIMIT){
      if(boardError){
        boardError.textContent = "Gre≈°ka: ukupna velicina fajlova prelazi 10MB.";
        boardError.style.display = "block";
      }
      return;
    }

    const docs = [];
    try{
      for(const f of files){
        const dataURL = await fileToDataURL(f);
        docs.push({
          name: f.name,
          sizeKB: Math.ceil((f.size||0)/1024),
          mime: f.type || "application/pdf",
          dataURL
        });
      }
    }catch(e){
      if(boardError){
        boardError.textContent = "Gre≈°ka: ne mogu da procitam fajl (FileReader).";
        boardError.style.display = "block";
      }
      return;
    }

    const post = {
      id: cryptoRandom(),
      createdAt: Date.now(),
      date,
      title,
      desc,
      docs
    };

    try{
      const items = loadBoardPosts(bid);
      items.push(post);
      saveBoardPosts(bid, items);
    }catch(e){
      if(boardError){
        boardError.textContent = "Gre≈°ka: localStorage limit (PDF je prevelik). Probaj manji PDF.";
        boardError.style.display = "block";
      }
      return;
    }

    if(boardFormWrap) boardFormWrap.style.display = "none";
    resetBoardForm();
    renderBoard(bid, CURRENT_QUERY);
    renderSearchDropdown(CURRENT_QUERY);
    updateHomeSummary();
  });
}

/* ================= FORUM ================= */
function loadProposals(bid){
  const raw = localStorage.getItem(kForum(bid));
  if(!raw){
    const seed = [
      {
        id: cryptoRandom(),
        createdAt: Date.now() - 1000*60*60*24*3,
        title: "Nova rasveta u hodniku",
        body: "Predlog da se zamene sijalice LED rasvetom zbog ustede.",
        createdBy: "BM25-001",
        poll: { enabled: true, endsAt: Date.now() + 1000*60*60*24*4, votesYes: [], votesNo: [] }
      },
      {
        id: cryptoRandom(),
        createdAt: Date.now() - 1000*60*60*24*10,
        title: "Zamena interfona",
        body: "Predlog da se proveri ponuda za zamenu interfona u zgradi.",
        createdBy: "BM25-002",
        poll: { enabled: true, endsAt: Date.now() - 1000*60*60*24*1, votesYes: ["demo@x"], votesNo: [] }
      }
    ];
    localStorage.setItem(kForum(bid), JSON.stringify(seed));
    return seed;
  }
  try { return JSON.parse(raw) || []; } catch { return []; }
}
function saveProposals(bid, items){
  localStorage.setItem(kForum(bid), JSON.stringify(items));
}
function fmtDateTime(ms){
  const d = new Date(ms);
  return d.toLocaleString("sr-RS");
}
function pollStatus(poll){
  if(!poll || !poll.enabled) return { txt: "Bez ankete", open: false };
  const open = Date.now() < poll.endsAt;
  return { txt: open ? "Anketa otvorena" : "Anketa zatvorena", open };
}
function hasVoted(poll, username){
  if(!poll || !poll.enabled) return false;
  return (poll.votesYes||[]).includes(username) || (poll.votesNo||[]).includes(username);
}
function forumMatches(p, q){
  const hay = `${p.title} ${p.body}`;
  return includesQuery(hay, q);
}
function renderForum(bid, q){
  if(!forumList) return;
  const all = loadProposals(bid).slice().sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
  const items = q ? all.filter(p => forumMatches(p, q)) : all;

  forumList.innerHTML = "";

  items.forEach(p => {
    const li = document.createElement("li");
    li.dataset.sid = "frm:" + p.id;

    const top = document.createElement("div");
    top.style.display = "flex";
    top.style.justifyContent = "space-between";
    top.style.gap = "10px";
    top.style.flexWrap = "wrap";

    const left = document.createElement("div");
    left.style.fontWeight = "900";
    left.textContent = p.title;

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.alignItems = "center";

    const meta = document.createElement("span");
    meta.className = "badge";
    meta.textContent = fmtDateTime(p.createdAt);

    const pol = document.createElement("span");
    pol.className = "badge";
    const st = pollStatus(p.poll);
    pol.textContent = st.txt;

    right.appendChild(meta);
    right.appendChild(pol);

    top.appendChild(left);
    top.appendChild(right);

    const body = document.createElement("div");
    body.className = "smallText";
    body.style.marginTop = "8px";
    body.textContent = p.body;

    li.appendChild(top);
    li.appendChild(body);

    if(p.poll && p.poll.enabled){
      const pollBox = document.createElement("div");
      pollBox.className = "smallText";
      pollBox.style.marginTop = "10px";

      const yes = (p.poll.votesYes||[]).length;
      const no = (p.poll.votesNo||[]).length;
      const total = yes + no;
      const yesPct = total ? Math.round((yes / total) * 100) : 0;
      const noPct  = total ? Math.round((no / total) * 100) : 0;

      const ends = document.createElement("div");
      ends.textContent = "Istice: " + new Date(p.poll.endsAt).toLocaleString("sr-RS");
      pollBox.appendChild(ends);

      const count = document.createElement("div");
      count.style.marginTop = "6px";
      count.innerHTML = `
        <span class="badge">Da: ${yes} (${yesPct}%)</span>
        <span class="badge" style="margin-left:8px;">Ne: ${no} (${noPct}%)</span>
        <span class="badge" style="margin-left:8px;">Ukupno: ${total}</span>
      `;
      pollBox.appendChild(count);

      if(CURRENT_SESSION && CURRENT_SESSION.role === "stanar"){
        const already = hasVoted(p.poll, CURRENT_SESSION.username);
        if(st.open && !already){
          const row = document.createElement("div");
          row.style.display = "flex";
          row.style.gap = "10px";
          row.style.marginTop = "8px";
          row.style.flexWrap = "wrap";

          const btnYes = document.createElement("button");
          btnYes.className = "btn btnPrimary";
          btnYes.type = "button";
          btnYes.style.flex = "unset";
          btnYes.style.padding = "12px 16px";
          btnYes.textContent = "Glasaj: DA";

          const btnNo = document.createElement("button");
          btnNo.className = "btn btnGhost";
          btnNo.type = "button";
          btnNo.style.flex = "unset";
          btnNo.style.padding = "12px 16px";
          btnNo.textContent = "Glasaj: NE";

          btnYes.addEventListener("click", () => vote(bid, p.id, "yes"));
          btnNo.addEventListener("click", () => vote(bid, p.id, "no"));

          row.appendChild(btnYes);
          row.appendChild(btnNo);
          pollBox.appendChild(row);
        }else{
          const note = document.createElement("div");
          note.style.marginTop = "8px";
          note.innerHTML = `<span class="badge">${already ? "Vec ste glasali" : "Anketa je zatvorena"}</span>`;
          pollBox.appendChild(note);
        }
      }else{
        const note = document.createElement("div");
        note.style.marginTop = "8px";
        note.innerHTML = `<span class="badge">Pregled (bez glasanja)</span>`;
        pollBox.appendChild(note);
      }

      li.appendChild(pollBox);
    }

    forumList.appendChild(li);
  });
}
function resetProposalForm(){
  if(!pTitle) return;
  forumError.style.display = "none";
  pTitle.value = "";
  pBody.value = "";
  pPoll.value = "ne";
  pDays.value = 7;
}
function forumInit(bid){
  if(!forumList) return;
  renderForum(bid, CURRENT_QUERY);
  resetProposalForm();
}
function vote(bid, proposalId, dir){
  const items = loadProposals(bid);
  const idx = items.findIndex(x => x.id === proposalId);
  if(idx === -1) return;

  const p = items[idx];
  if(!p.poll || !p.poll.enabled) return;

  const st = pollStatus(p.poll);
  if(!st.open) return;

  if(!CURRENT_SESSION || CURRENT_SESSION.role !== "stanar") return;
  if(hasVoted(p.poll, CURRENT_SESSION.username)) return;

  p.poll.votesYes = p.poll.votesYes || [];
  p.poll.votesNo = p.poll.votesNo || [];

  if(dir === "yes") p.poll.votesYes.push(CURRENT_SESSION.username);
  else p.poll.votesNo.push(CURRENT_SESSION.username);

  items[idx] = p;
  saveProposals(bid, items);
  renderForum(bid, CURRENT_QUERY);
  renderSearchDropdown(CURRENT_QUERY);
  updateHomeSummary();
}
if(createProposalBtn){
  createProposalBtn.addEventListener("click", () => {
    forumError.style.display = "none";

    const bid = activeBid();
    if(!bid){
      forumError.textContent = "Nije izabrana zgrada.";
      forumError.style.display = "block";
      return;
    }

    if(!CURRENT_SESSION || CURRENT_SESSION.role !== "stanar"){
      forumError.textContent = "Nemate dozvolu.";
      forumError.style.display = "block";
      return;
    }

    const title = (pTitle.value||"").trim();
    const body = (pBody.value||"").trim();
    const pollOn = (pPoll.value === "da");
    const days = Math.max(1, Math.min(30, Number(pDays.value||7)));

    if(!title || !body){
      forumError.textContent = "Gre≈°ka: popuni naslov i opis.";
      forumError.style.display = "block";
      return;
    }

    const proposal = {
      id: cryptoRandom(),
      createdAt: Date.now(),
      title,
      body,
      createdBy: CURRENT_SESSION.username,
      poll: pollOn ? { enabled: true, endsAt: Date.now() + 1000*60*60*24*days, votesYes: [], votesNo: [] } : { enabled:false }
    };

    const items = loadProposals(bid);
    items.push(proposal);
    saveProposals(bid, items);

    resetProposalForm();
    renderForum(bid, CURRENT_QUERY);
    renderSearchDropdown(CURRENT_QUERY);
    updateHomeSummary();
  });
}
if(clearProposalBtn){
  clearProposalBtn.addEventListener("click", resetProposalForm);
}

/* ================= GLOBAL SEARCH ================= */
function tagForPage(page){
  if(page === "finansije") return "Finansije";
  if(page === "oglasna") return "Oglasna";
  if(page === "forum") return "Forum";
  if(page === "regulative") return "Regulative";
  if(page === "kontakt") return "Kontakt";
  return "Rezultat";
}
function ensureStaticSids(){
  if(regList){
    [...regList.querySelectorAll("li")].forEach((li, idx) => {
      if(!li.dataset.sid) li.dataset.sid = "reg:" + idx;
    });
  }
  if(kontaktList){
    [...kontaktList.querySelectorAll("li")].forEach((li, idx) => {
      if(!li.dataset.sid) li.dataset.sid = "kon:" + idx;
    });
  }
}
function buildSearchHits(q){
  const bid = activeBid();
  const qq = norm(q);
  if(!qq || !bid) return [];

  const hits = [];

  // finansije (samo aktivna zgrada)
  try{
    const items = loadItems(bid).slice().sort((a,b) => (b.date||"").localeCompare(a.date||""));
    for(const it of items){
      if(financeMatches(it, qq)){
        const firmPart = it.firm ? (" ‚Äî " + it.firm) : "";
        hits.push({
          page: "finansije",
          sid: "fin:" + it.id,
          text: `${it.date} ‚Äî ${it.type === "rashod" ? "Rashod" : "Prihod"} ‚Äî ${it.category}${firmPart}`,
          sub: `"${it.desc}" ‚Äî ${formatRSD(it.amount)} RSD`
        });
      }
    }
  }catch{}

  // oglasna
  try{
    const posts = loadBoardPosts(bid).slice().sort((a,b) => (b.date||"").localeCompare(a.date||""));
    for(const p of posts){
      if(boardMatches(p, qq)){
        hits.push({
          page: "oglasna",
          sid: "brd:" + p.id,
          text: `${p.date} ‚Äî ${p.title}`,
          sub: p.desc || ""
        });
      }
    }
  }catch{}

  // forum
  try{
    const props = loadProposals(bid).slice().sort((a,b) => (b.createdAt||0)-(a.createdAt||0));
    for(const p of props){
      if(forumMatches(p, qq)){
        hits.push({
          page: "forum",
          sid: "frm:" + p.id,
          text: p.title,
          sub: p.body
        });
      }
    }
  }catch{}

  // regulative (static)
  if(regList){
    [...regList.querySelectorAll("li")].forEach(li => {
      if(includesQuery(li.textContent, qq)){
        hits.push({ page:"regulative", sid: li.dataset.sid || "", text: li.textContent, sub:"" });
      }
    });
  }

  // kontakt (static)
  if(kontaktList){
    [...kontaktList.querySelectorAll("li")].forEach(li => {
      if(includesQuery(li.textContent, qq)){
        hits.push({ page:"kontakt", sid: li.dataset.sid || "", text: li.textContent, sub:"" });
      }
    });
  }

  return hits.slice(0, 12);
}
function renderSearchDropdown(q){
  if(!searchResults) return;

  const qq = norm(q);
  if(!qq){
    searchResults.style.display = "none";
    searchResults.innerHTML = "";
    return;
  }

  const hits = buildSearchHits(qq);

  if(!hits.length){
    searchResults.innerHTML = `
      <div class="srHead">Rezultati</div>
      <div class="srItem" style="cursor:default;">
        <div class="srText">Nema rezultata za ‚Äú${q}‚Äù.<div class="srSub">Probaj drugi pojam (npr. ‚Äúkrov‚Äù, ‚Äúlift‚Äù, ‚Äú193‚Äù).</div></div>
      </div>
    `;
    searchResults.style.display = "block";
    return;
  }

  const grouped = new Map();
  for(const h of hits){
    const key = h.page;
    if(!grouped.has(key)) grouped.set(key, []);
    grouped.get(key).push(h);
  }

  let html = `<div class="srHead">Rezultati za ‚Äú${q}‚Äù</div>`;
  const order = ["finansije","oglasna","forum","regulative","kontakt"];

  for(const page of order){
    const arr = grouped.get(page);
    if(!arr || !arr.length) continue;

    const slice = arr.slice(0, 3);
    for(const item of slice){
      html += `
        <div class="srItem" data-page="${item.page}" data-sid="${item.sid}">
          <div class="srTag">${tagForPage(item.page)}</div>
          <div class="srText">
            ${item.text}
            ${item.sub ? `<div class="srSub">${item.sub}</div>` : ``}
          </div>
        </div>
      `;
    }
  }

  searchResults.innerHTML = html;
  searchResults.style.display = "block";
}
function applySearchFilter(){
  const bid = activeBid();
  if(!bid) return;
  renderFinanceList(bid, CURRENT_QUERY);
  renderBoard(bid, CURRENT_QUERY);
  renderForum(bid, CURRENT_QUERY);
}
function scrollToSid(sid){
  if(!sid) return;
  const el = document.querySelector(`[data-sid="${sid}"]`);
  if(!el) return;

  el.scrollIntoView({ behavior:"smooth", block:"center" });
  el.classList.add("searchHitFlash");
  setTimeout(() => el.classList.remove("searchHitFlash"), 1200);
}
function goToHit(page, sid){
  showPage(page);

  setTimeout(() => {
    applySearchFilter();
    setTimeout(() => scrollToSid(sid), 60);
  }, 60);

  if(searchResults) searchResults.style.display = "none";
}

if(globalSearch){
  globalSearch.addEventListener("input", () => {
    CURRENT_QUERY = (globalSearch.value || "").trim();
    applySearchFilter();
    renderSearchDropdown(CURRENT_QUERY);
  });

  globalSearch.addEventListener("focus", () => {
    renderSearchDropdown((globalSearch.value || "").trim());
  });

  globalSearch.addEventListener("keydown", (e) => {
    if(e.key === "Escape"){
      if(searchResults) searchResults.style.display = "none";
    }
  });
}
if(searchResults){
  searchResults.addEventListener("click", (e) => {
    const row = e.target.closest(".srItem");
    if(!row) return;
    const page = row.getAttribute("data-page");
    const sid  = row.getAttribute("data-sid");
    if(page) goToHit(page, sid);
  });
}
document.addEventListener("click", (e) => {
  if(!searchResults || !globalSearch) return;
  const wrap = globalSearch.closest(".searchInline");
  if(wrap && wrap.contains(e.target)) return;
  searchResults.style.display = "none";
});

/* ===== refresh modules for active building ===== */
function refreshAllModules(){
  const bid = activeBid();
  if(!bid) return;

  financeInit(bid);
  forumInit(bid);
  boardInit(bid);

  // refresh filtered view
  applySearchFilter();
  renderSearchDropdown(CURRENT_QUERY);
  updateHomeSummary();
  refreshBalanceUI(bid); /* ‚úÖ IZMENJENO */

// ‚úÖ MESEƒåNI UPLOAD: osve≈æi badge-ove
  updateMonthlyUploadUI(false);
  updateMonthlyUploadUI(true);
}

/* ===== home summary ===== */
function updateHomeSummary(){
  const bid = activeBid();
  if(!bid) return;

  const fin = loadItems(bid).slice().sort((a,b) => (b.date||"").localeCompare(a.date||""));
  if(fin.length){
    const it = fin[0];
    homeLastChange.textContent = `Poslednja promena: ${it.type === "rashod" ? "Rashod" : "Prihod"} - ${it.category} (${it.date})`;
  }else{
    homeLastChange.textContent = "Poslednja promena: (nema)";
  }

  const brd = loadBoardPosts(bid).slice().sort((a,b) => (b.date||"").localeCompare(a.date||""));
  if(brd.length){
    homePinned.textContent = `Istaknuto: ${brd[0].title} (${brd[0].date})`;
  }else{
    homePinned.textContent = "Istaknuto: (nema)";
  }

  const frm = loadProposals(bid).slice().sort((a,b) => (b.createdAt||0)-(a.createdAt||0));
  if(frm.length){
    homeForum.textContent = `Forum: ${frm[0].title}`;
  }else{
    homeForum.textContent = "Forum: (nema)";
  }
}

/* INIT */
(function init(){
  ensureStaticSids();

  const session = getSession();
  if(session && session.username && session.role){
    CURRENT_SESSION = session;
    userPill.textContent = session.username;
    applyRoleUI(session.role);

    if(!CURRENT_SESSION.activeBuildingId){
      if(CURRENT_SESSION.role === "stanar"){
        CURRENT_SESSION.activeBuildingId = (CURRENT_SESSION.buildings || [])[0] || null;
        saveSession(CURRENT_SESSION);
        enterPortal();
      }else{
        if((CURRENT_SESSION.buildings || []).length > 1){
          showBuildingSelect();
        }else{
          CURRENT_SESSION.activeBuildingId = (CURRENT_SESSION.buildings || [])[0] || null;
          saveSession(CURRENT_SESSION);
          enterPortal();
        }
      }
      return;
    }

    enterPortal();
  }else{
    CURRENT_SESSION = null;
    applyRoleUI("stanar");
    setMode("login");
  }
})();

/* =========================
   STATISTIKA - SR mesec/godina picker
   (radi sa hidden input #uplMonthPick kao YYYY-MM)
========================= */
(function initSrMonthPicker(){
  const monthSel = document.getElementById("uplMonthMonth");
  const yearSel  = document.getElementById("uplMonthYear");
  const applyBtn = document.getElementById("uplMonthApply");
  const hidden   = document.getElementById("uplMonthPick");
  const hint     = document.getElementById("uplMonthHint");

  if(!monthSel || !yearSel || !applyBtn || !hidden) return;

  // 1) Napuni godine (npr poslednjih 5 + sledeƒáih 1)
  const now = new Date();
  const thisYear = now.getFullYear();
  const startY = thisYear - 5;
  const endY   = thisYear + 1;

  // Ako select godina nema opcije ili nema dovoljno, popuni
  if (yearSel.options.length <= 1) {
    yearSel.innerHTML = '<option value="">Godina</option>';
    for(let y = endY; y >= startY; y--){
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      yearSel.appendChild(opt);
    }
  }

  // 2) Postavi default na trenutni mesec/godinu
  const mm = String(now.getMonth() + 1).padStart(2,"0");
  monthSel.value = mm;
  yearSel.value = String(thisYear);

  function updateHiddenAndTrigger(){
    const m = monthSel.value;
    const y = yearSel.value;

    if(!m || !y){
      if(hint) hint.textContent = "Izaberi mesec i godinu";
      return;
    }

    hidden.value = `${y}-${m}`;

    // okini change event da postojeƒái kod preradi statistiku
    hidden.dispatchEvent(new Event("change", { bubbles:true }));

    if(hint) hint.textContent = `Izabrano: ${m}.${y}`;
  }

  applyBtn.addEventListener("click", updateHiddenAndTrigger);

  // opcionalno: kada promeni mesec/godinu odmah upi≈°i hint
  monthSel.addEventListener("change", () => { if(hint) hint.textContent = "Klikni Primeni"; });
  yearSel.addEventListener("change", () => { if(hint) hint.textContent = "Klikni Primeni"; });

  // inicijalno pokreni odmah
  updateHiddenAndTrigger();
})();

  /* =========================
   SIDEBAR LOGOUT
========================= */

const sidebarLogout = document.getElementById("sidebarLogout");

if (sidebarLogout) {
  sidebarLogout.addEventListener("click", (e) => {
    e.preventDefault();

    // (opciono) potvrda
    // if (!confirm("Da li ste sigurni da ≈æelite da se odjavite?")) return;

    clearSessions();
    CURRENT_SESSION = null;
    closeS();
    setMode("login");
  });
}

</script>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Supabase init -->
<script>
  const SUPABASE_URL = "https://bkzczqnbeomvshqplrho.supabase.co";
  const SUPABASE_KEY = "sb_publishable_mPQn0h5Ixgyg5WQFsJk38A_qqE2kPb7";

  const supabaseClient = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
  );

  // samo za proveru
  console.log("Supabase connected:", supabaseClient);
</script>

</body>
</html>

























































